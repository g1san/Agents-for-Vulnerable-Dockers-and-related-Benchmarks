# Use official Jetty image as base
FROM eclipse/jetty:9.4.37-jre11

# Downgrade to the exact vulnerable version
USER root
RUN wget -O /tmp/jetty-home.tar.gz https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-home/9.4.38.v20210224/jetty-home-9.4.38.v20210224.tar.gz && \
    tar -xzf /tmp/jetty-home.tar.gz -C /tmp && \
    cp -r /tmp/jetty-home-9.4.38.v20210224/* ${JETTY_BASE} && \
    rm -rf /tmp/jetty-home*

# Copy our vulnerable webapp
COPY ./webapp /var/lib/jetty/webapps/root

# Switch back to jetty user
USER jetty

# Create a health check
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/ || exit 1