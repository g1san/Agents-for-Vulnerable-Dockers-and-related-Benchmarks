FROM eclipse-temurin:11-jre-jammy

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Download and install vulnerable Jetty version
ENV JETTY_VERSION=9.4.38.v20210224
ENV JETTY_HOME=/opt/jetty-home
ENV JETTY_BASE=/opt/jetty-base
ENV PATH=$JETTY_HOME/bin:$PATH

RUN mkdir -p "$JETTY_HOME" "$JETTY_BASE"
WORKDIR $JETTY_HOME

RUN curl -SL https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-home/${JETTY_VERSION}/jetty-home-${JETTY_VERSION}.tar.gz \
    | tar -xz --strip-components=1

# Configure Jetty
WORKDIR $JETTY_BASE
RUN java -jar $JETTY_HOME/start.jar --add-to-startd=http,deploy,annotations,jsp

# Copy our vulnerable webapp
COPY ./webapp $JETTY_BASE/webapps/root

# Copy entrypoint script
COPY entrypoint.sh /
RUN chmod +x /entrypoint.sh

EXPOSE 8080
ENTRYPOINT ["/entrypoint.sh"]