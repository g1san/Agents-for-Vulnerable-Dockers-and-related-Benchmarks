# Using a specific version of Jenkins known to be vulnerable to CVE-2024-23897
# Jenkins 2.414.2 LTS is vulnerable (before the patched 2.414.3)
FROM jenkins/jenkins:2.414.2-lts-jdk17

USER root

# Install necessary tools that might be used in exploitation or testing
# Using netcat-traditional instead of netcat which isn't available in this Debian base
RUN apt-get update && \
    apt-get install -y curl netcat-traditional iputils-ping procps && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Switch back to jenkins user
USER jenkins

# Skip initial setup wizard
ENV JAVA_OPTS -Djenkins.install.runSetupWizard=false

# Copy plugins list
COPY jenkins-plugins.txt /usr/share/jenkins/ref/plugins.txt

# Install plugins
RUN jenkins-plugin-cli --plugin-file /usr/share/jenkins/ref/plugins.txt

# Enable the CLI over HTTP which increases the attack surface
ENV JENKINS_OPTS --httpPort=8080 --httpListenAddress=0.0.0.0 --argumentsRealm.roles.user=admin --argumentsRealm.passwd.admin=admin --argumentsRealm.roles.admin=admin

# Explicitly enable the remoting CLI (part of what makes this vulnerable)
ENV JENKINS_OPTS "${JENKINS_OPTS} --enable-cli"