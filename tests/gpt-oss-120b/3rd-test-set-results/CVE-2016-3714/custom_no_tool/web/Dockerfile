FROM php:7.4-apache

# Install utilities needed to add the snapshot repository
RUN apt-get update && \
    apt-get install -y --no-install-recommends wget ca-certificates gnupg2 && \
    rm -rf /var/lib/apt/lists/*

# Add Debian snapshot repository and disable validity check
RUN echo "deb http://snapshot.debian.org/archive/debian/20200101T000000Z/ buster main" > /etc/apt/sources.list.d/snapshot.list && \
    echo "Acquire::Check-Valid-Until \"false\";" > /etc/apt/apt.conf.d/99no-check-valid-until

# Update index after adding snapshot repo and install vulnerable ImageMagick with build tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libmagickwand-dev \
        build-essential \
        pkg-config \
        git \
        unzip \
        php-pear \
        imagemagick=6.9.3-7 \
        libmagickwand-6.q16-6=6.9.3-7 && \
    rm -rf /var/lib/apt/lists/*

# Build and enable the PHP imagick extension
RUN pecl install imagick && docker-php-ext-enable imagick

# Remove buildâ€‘time dependencies
RUN apt-get purge -y --auto-remove git unzip build-essential pkg-config php-pear && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY index.php /var/www/html/index.php