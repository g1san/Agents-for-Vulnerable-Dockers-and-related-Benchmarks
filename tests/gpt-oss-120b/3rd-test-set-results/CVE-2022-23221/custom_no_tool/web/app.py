from flask import Flask, request, abort, send_file, jsonify
import mysql.connector
import os

app = Flask(__name__)

# Configuration for allowed file reads
ALLOWED_BASE_DIR = '/app/allowed_files'
os.makedirs(ALLOWED_BASE_DIR, exist_ok=True)

def get_db_connection():
    try:
        cnx = mysql.connector.connect(
            user='user',
            password='userpass',
            host='db',
            database='testdb',
            connection_timeout=5
        )
        return cnx
    except mysql.connector.Error as err:
        app.logger.error(f"Database connection failed: {err}")
        return None

@app.route('/')
def index():
    return 'Secure Flask app - CVE-2022-23221 demonstration'

# Secure file‑reading endpoint – only serves files inside ALLOWED_BASE_DIR
@app.route('/read')
def read_file():
    filename = request.args.get('file')
    if not filename:
        abort(400, 'Missing file parameter')
    # Prevent path traversal
    safe_path = os.path.abspath(os.path.join(ALLOWED_BASE_DIR, filename))
    if not safe_path.startswith(ALLOWED_BASE_DIR):
        abort(403, 'Access to the requested file is forbidden')
    if not os.path.isfile(safe_path):
        abort(404, 'File not found')
    return send_file(safe_path, as_attachment=False)

@app.route('/users')
def list_users():
    cnx = get_db_connection()
    if cnx is None:
        return jsonify({'error': 'Database unavailable'}), 503
    cursor = cnx.cursor()
    cursor.execute('SELECT id, username FROM users')
    rows = cursor.fetchall()
    cursor.close()
    cnx.close()
    return jsonify({'users': [{'id': r[0], 'username': r[1]} for r in rows]})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=80)