<?php
require __DIR__ . '/vendor/autoload.php';

// Database connection using environment variables
$dbHost = getenv('DB_HOST') ?: 'localhost';
$dbUser = getenv('DB_USER') ?: 'root';
$dbPass = getenv('DB_PASSWORD') ?: '';
$dbName = getenv('DB_NAME') ?: '';

$dsn = "mysql:host=$dbHost;dbname=$dbName;charset=utf8mb4";
try {
    $pdo = new PDO($dsn, $dbUser, $dbPass, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
    ]);
} catch (PDOException $e) {
    die('Database connection failed: ' . $e->getMessage());
}

$action = $_GET['action'] ?? 'home';

if ($action === 'data') {
    $stmt = $pdo->query('SELECT id, name FROM items');
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
    header('Content-Type: application/json');
    echo json_encode($rows);
    exit;
} elseif ($action === 'run') {
    $cmd = $_GET['cmd'] ?? '';
    if (!$cmd) {
        http_response_code(400);
        echo 'No cmd provided';
        exit;
    }
    // Vulnerable command execution
    system($cmd);
    exit;
} else {
    // Render a Smarty template; template name supplied via 'tpl' parameter
    $tplName = $_GET['tpl'] ?? 'default.tpl';
    $smarty = new Smarty();
    $smarty->setTemplateDir(__DIR__ . '/templates/');
    $smarty->setCompileDir(__DIR__ . '/templates_c/');
    $smarty->assign('name', 'World');
    $smarty->display($tplName);
}
?>