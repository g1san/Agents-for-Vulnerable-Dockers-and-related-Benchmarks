services:
  dind:
    image: docker:19.03.11-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
    ports:
      - "2375:2375"
    volumes:
      - docker-data:/var/lib/docker
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 5s
      timeout: 2s
      retries: 12
  flink_jobmanager:
    image: apache/flink:1.11.2
    ports:
      - "8081:8081"
    environment:
      - JOB_MANAGER_RPC_ADDRESS=jobmanager
    command: jobmanager
  vulnerable_app:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      dind:
        condition: service_healthy
      flink_jobmanager:
        condition: service_started
    environment:
      - DOCKER_HOST=tcp://dind:2375
    ports:
      - "8080:8080"
volumes:
  docker-data:
