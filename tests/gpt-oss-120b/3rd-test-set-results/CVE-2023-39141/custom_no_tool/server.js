const express = require('express');
const path = require('path');
const fs = require('fs');
const app = express();
const PORT = process.env.PORT || 3000;

// Define the directory that will serve static files
const STATIC_ROOT = path.join(__dirname, 'public');

// Ensure the static directory exists (create if missing)
if (!fs.existsSync(STATIC_ROOT)) {
  fs.mkdirSync(STATIC_ROOT, { recursive: true });
}

// Helper to check if a resolved path stays inside STATIC_ROOT
function isPathInside(parent, child) {
  const relative = path.relative(parent, child);
  return !relative.startsWith('..') && !path.isAbsolute(relative);
}

// Safe file serving route â€“ replaces the vulnerable implementation
app.get('/*', (req, res) => {
  // Decode URL components and prevent null bytes
  const safePath = decodeURIComponent(req.path);

  // Resolve the absolute path of the requested file within STATIC_ROOT
  const absolutePath = path.resolve(STATIC_ROOT, '.' + safePath);

  // Verify that the resolved path is still inside STATIC_ROOT
  if (!isPathInside(STATIC_ROOT, absolutePath)) {
    return res.status(403).send('Forbidden: directory traversal attempt detected');
  }

  // Check if the file exists and is a regular file
  fs.stat(absolutePath, (err, stats) => {
    if (err || !stats.isFile()) {
      return res.status(404).send('File not found');
    }
    res.sendFile(absolutePath);
  });
});

app.listen(PORT, () => {
  console.log(`Server listening on port ${PORT}`);
});