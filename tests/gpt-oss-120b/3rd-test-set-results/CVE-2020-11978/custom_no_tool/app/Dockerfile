FROM python:3.8-slim

ENV PYTHONUNBUFFERED=1

# Install system build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc libpq-dev && \
    rm -rf /var/lib/apt/lists/*

# Create a nonâ€‘root user
RUN groupadd -r appgroup && useradd -r -g appgroup appuser

WORKDIR /app

# Upgrade pip and install Python dependencies (compatible versions)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
        Flask==2.2.5 \
        psycopg2-binary==2.8.6

# Remove build tools to keep the image lightweight
RUN apt-get purge -y --auto-remove gcc libpq-dev

COPY app.py .

# Adjust ownership
RUN chown -R appuser:appgroup /app

EXPOSE 80

USER appuser

CMD ["python", "app.py"]