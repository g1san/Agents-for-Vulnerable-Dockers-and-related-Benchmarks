import os
from flask import Flask, request, send_file, abort
import logging

app = Flask(__name__)

# Configuration
EC_SHOP_URL = os.getenv('EC_SHOP_URL', 'http://localhost')
logging.basicConfig(level=logging.INFO)
app.logger.info(f"ECShop endpoint set to: {EC_SHOP_URL}")

# CVE-2021-41460 simulation: insecure file path handling allowing directory traversal
@app.route('/download')
def download_file():
    filename = request.args.get('file')
    if not filename:
        abort(400, 'Missing file parameter')
    # Vulnerable: directly concatenating user input to path without validation
    file_path = os.path.join('/app/data', filename)
    if not os.path.isfile(file_path):
        abort(404, 'File not found')
    return send_file(file_path, as_attachment=True)

# Simple endpoint to demonstrate connectivity to the real ECShop instance
@app.route('/shop_status')
def shop_status():
    return f"Connected to ECShop at {EC_SHOP_URL}\n", 200

if __name__ == '__main__':
    # Ensure the /app/data directory exists with a test file
    os.makedirs('/app/data', exist_ok=True)
    with open('/app/data/secret.txt', 'w') as f:
        f.write('Sensitive information for CVE-2021-41460 testing')
    app.run(host='0.0.0.0', port=80)