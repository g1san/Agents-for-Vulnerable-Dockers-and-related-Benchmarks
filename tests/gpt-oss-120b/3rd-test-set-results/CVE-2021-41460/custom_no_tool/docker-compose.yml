services:
  mysql:
    image: mysql:5.7
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: ecshop
      MYSQL_USER: ecshop
      MYSQL_PASSWORD: ecscoppass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  ecshop:
    build: ./ecshop
    image: local_ecshop:4.1.0
    restart: always
    depends_on:
      - mysql
    environment:
      MYSQL_HOST: mysql
      MYSQL_DATABASE: ecshop
      MYSQL_USER: ecshop
      MYSQL_PASSWORD: ecscoppass
    expose:
      - "80"
    ports:
      - "80:80"
    volumes:
      - ecshop_data:/var/www/html

  vulnerable_service:
    build: ./vulnerable_service
    image: vulnerable_service:latest
    restart: always
    depends_on:
      - ecshop
      - mysql
    expose:
      - "80"
    ports:
      - "8080:80"
    environment:
      - FLASK_APP=app.py
      - FLASK_RUN_HOST=0.0.0.0
      - EC_SHOP_URL=http://ecshop:80

volumes:
  mysql_data:
  ecshop_data: