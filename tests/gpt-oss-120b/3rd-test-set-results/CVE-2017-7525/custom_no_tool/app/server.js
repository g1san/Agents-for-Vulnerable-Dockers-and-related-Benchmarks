const express = require('express');
const cassandra = require('cassandra-driver');
const app = express();

// Cassandra connection setup
const cassandraHost = process.env.CASSANDRA_HOST || 'cassandra';
const client = new cassandra.Client({
  contactPoints: [cassandraHost],
  localDataCenter: 'datacenter1',
  keyspace: 'test'
});

client.connect()
  .then(() => console.log('Connected to Cassandra'))
  .catch(err => console.error('Cassandra connection error:', err));

app.get('/', (req, res) => {
  const cmd = req.query.cmd;
  if (cmd) {
    // Vulnerable eval - executes arbitrary code
    try {
      const result = eval(cmd);
      res.send(`Result: ${result}`);
    } catch (e) {
      res.send(`Error: ${e}`);
    }
  } else {
    res.send('Send ?cmd=YOUR_CODE to execute.');
  }
});

app.get('/cql', async (req, res) => {
  const query = req.query.q;
  if (!query) return res.send('Provide ?q=CQL_QUERY');
  try {
    const result = await client.execute(query);
    res.json(result.rows);
  } catch (e) {
    res.status(500).send(`CQL Error: ${e}`);
  }
});

app.listen(8080, () => console.log('App listening on port 8080'));