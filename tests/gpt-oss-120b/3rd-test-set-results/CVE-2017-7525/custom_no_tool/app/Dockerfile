FROM node:16-alpine
WORKDIR /usr/src/app
# Install build tools and netcat, create a python symlink for node-gyp
RUN apk add --no-cache python3 make g++ netcat-openbsd && \
    ln -sf /usr/bin/python3 /usr/bin/python
# Copy application source (including package.json) before installing dependencies
COPY . .
# Install Node dependencies (cassandra-driver will be compiled with the tools above)
RUN npm install
# Keep the runtime tools (python) because node-gyp may need it later; remove only the compiler packages
RUN apk del make g++
# Ensure the entry script is executable
RUN chmod +x start.sh
EXPOSE 8080
CMD ["/bin/sh","-c","./start.sh"]