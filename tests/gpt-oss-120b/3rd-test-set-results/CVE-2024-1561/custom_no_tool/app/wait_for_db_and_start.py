import os
import time
import sys
import psycopg2

DB_PARAMS = {
    "dbname": os.getenv('POSTGRES_DB'),
    "user": os.getenv('POSTGRES_USER'),
    "password": os.getenv('POSTGRES_PASSWORD'),
    "host": 'db'
}

max_tries = 15
for i in range(max_tries):
    try:
        conn = psycopg2.connect(**DB_PARAMS)
        conn.close()
        break
    except psycopg2.OperationalError:
        print(f"[wait] Postgres not ready yet ({i+1}/{max_tries})â€¦")
        time.sleep(2)
else:
    print("[wait] Postgres did not become ready in time.")
    sys.exit(1)

# Replace the current process with the Flask server
os.execvp("flask", ["flask", "run", "--host=0.0.0.0", "--port=5000"])
