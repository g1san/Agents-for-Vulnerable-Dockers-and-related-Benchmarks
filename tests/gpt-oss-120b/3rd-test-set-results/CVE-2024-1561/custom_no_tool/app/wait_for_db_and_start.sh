#!/bin/sh

# Ensure we are in the container's working directory
cd /app

# Database connection parameters (same as in app.py)
DB_NAME=${POSTGRES_DB}
DB_USER=${POSTGRES_USER}
DB_PASSWORD=${POSTGRES_PASSWORD}

# Export password for psql client
export PGPASSWORD="${POSTGRES_PASSWORD}"

# Wait for PostgreSQL to become reachable
max_tries=30
tries=0
while ! pg_isready -h db -U "$DB_USER" -d "$DB_NAME" >/dev/null 2>&1; do
  tries=$(($tries + 1))
  if [ $tries -ge $max_tries ]; then
    echo "PostgreSQL did not become ready in time, exiting."
    exit 1
  fi
  echo "Waiting for PostgreSQL... ($tries)"
  sleep 1
done

# Run any initialization SQL (the image already contains init_db.sql)
psql -h db -U "$DB_USER" -d "$DB_NAME" -f /app/app/init_db.sql

# Start the Flask application
exec /usr/local/bin/flask run --host=0.0.0.0 --port=5000