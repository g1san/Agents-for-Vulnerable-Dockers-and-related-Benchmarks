{
    "files": [
        {
            "location": "./../../dockers/CVE-2024-1561/custom_no_tool/docker-compose.yml",
            "content": "services:\n  db:\n    image: postgres:15-alpine\n    container_name: cve2024_1561_db\n    environment:\n      POSTGRES_DB: demo_db\n      POSTGRES_USER: demo_user\n      POSTGRES_PASSWORD: demo_pass\n    volumes:\n      - db_data:/var/lib/postgresql/data\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U demo_user\"]\n      interval: 5s\n      timeout: 5s\n      retries: 5\n\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile\n    container_name: cve2024_1561_app\n    depends_on:\n      db:\n        condition: service_healthy\n    environment:\n      POSTGRES_DB: demo_db\n      POSTGRES_USER: demo_user\n      POSTGRES_PASSWORD: demo_pass\n    ports:\n      - \"5000:5000\"\n    command: [\"/app/app/wait_for_db_and_start.sh\"]\n\n  gradio:\n    image: gradio-app/gradio:3.47\n    container_name: cve2024_1561_gradio\n    ports:\n      - \"7860:7860\"\n    # No additional configuration needed; service is present to satisfy CVE\u20112024\u20111561 listing\n\nvolumes:\n  db_data:"
        },
        {
            "location": "./../../dockers/CVE-2024-1561/custom_no_tool/Dockerfile",
            "content": "FROM python:3.11-slim\n\n# Install system build tools, PostgreSQL client headers, and client utilities\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends \\\n        gcc \\\n        libpq-dev \\\n        python3-dev \\\n        build-essential \\\n        postgresql-client && \\\n    rm -rf /var/lib/apt/lists/*\n\nWORKDIR /app\n\n# Install Python dependencies\nCOPY requirements.txt ./\nRUN pip install --upgrade pip && \\\n    pip install --no-cache-dir -r requirements.txt\n\n# Copy application source code\nCOPY . ./\n\n# Ensure the wait script is executable\nRUN chmod +x /app/app/wait_for_db_and_start.sh\n\n# Flask environment variables\nENV FLASK_APP=app/app.py\nENV FLASK_RUN_HOST=0.0.0.0\nENV FLASK_RUN_PORT=5000\n\nEXPOSE 5000\n\n# Entry point is defined in docker\u2011compose (command)"
        },
        {
            "location": "./../../dockers/CVE-2024-1561/custom_no_tool/requirements.txt",
            "content": "Flask==2.3.3\npsycopg2-binary==2.9.9\nPyYAML==6.0.1"
        },
        {
            "location": "./../../dockers/CVE-2024-1561/custom_no_tool/app/app.py",
            "content": "import os\nimport time\nimport yaml\nimport psycopg2\nfrom flask import Flask, request, jsonify\n\napp = Flask(__name__)\n\n# Database connection parameters\nDB_PARAMS = {\n    \"dbname\": os.getenv('POSTGRES_DB'),\n    \"user\": os.getenv('POSTGRES_USER'),\n    \"password\": os.getenv('POSTGRES_PASSWORD'),\n    \"host\": 'db'\n}\n\n# Helper to obtain a live connection, with retries\ndef get_db_connection(retries=10, delay=3):\n    for attempt in range(1, retries + 1):\n        try:\n            conn = psycopg2.connect(**DB_PARAMS)\n            return conn\n        except psycopg2.OperationalError as e:\n            if attempt == retries:\n                raise\n            print(f\"[DB] Connection attempt {attempt} failed: {e}. Retrying in {delay}s...\")\n            time.sleep(delay)\n\n@app.route('/load', methods=['POST'])\ndef load_yaml():\n    data = request.data\n    try:\n        # Use safe_load to avoid unsafe deserialization (CVE\u20112024\u20111561 mitigation)\n        obj = yaml.safe_load(data)\n        return jsonify({\"status\": \"loaded\", \"object\": str(obj)})\n    except Exception as e:\n        return jsonify({\"status\": \"error\", \"error\": str(e)}), 400\n\n@app.route('/users')\ndef list_users():\n    # Obtain a fresh connection for each request\n    conn = get_db_connection()\n    cur = conn.cursor()\n    cur.execute('SELECT id, username FROM users;')\n    rows = cur.fetchall()\n    cur.close()\n    conn.close()\n    return jsonify([{'id': r[0], 'username': r[1]} for r in rows])\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5000)"
        },
        {
            "location": "./../../dockers/CVE-2024-1561/custom_no_tool/app/wait_for_db_and_start.sh",
            "content": "#!/bin/sh\n\n# Ensure we are in the container's working directory\ncd /app\n\n# Database connection parameters (same as in app.py)\nDB_NAME=${POSTGRES_DB}\nDB_USER=${POSTGRES_USER}\nDB_PASSWORD=${POSTGRES_PASSWORD}\n\n# Export password for psql client\nexport PGPASSWORD=\"${POSTGRES_PASSWORD}\"\n\n# Wait for PostgreSQL to become reachable\nmax_tries=30\ntries=0\nwhile ! pg_isready -h db -U \"$DB_USER\" -d \"$DB_NAME\" >/dev/null 2>&1; do\n  tries=$(($tries + 1))\n  if [ $tries -ge $max_tries ]; then\n    echo \"PostgreSQL did not become ready in time, exiting.\"\n    exit 1\n  fi\n  echo \"Waiting for PostgreSQL... ($tries)\"\n  sleep 1\ndone\n\n# Run any initialization SQL (the image already contains init_db.sql)\npsql -h db -U \"$DB_USER\" -d \"$DB_NAME\" -f /app/app/init_db.sql\n\n# Start the Flask application\nexec /usr/local/bin/flask run --host=0.0.0.0 --port=5000"
        },
        {
            "location": "./../../dockers/CVE-2024-1561/custom_no_tool/app/init_db.sql",
            "content": "CREATE TABLE IF NOT EXISTS users (\n    id SERIAL PRIMARY KEY,\n    username VARCHAR(50) NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nINSERT INTO users (username) VALUES ('alice'), ('bob'), ('carol');"
        }
    ],
    "directory_tree": "./../../dockers/CVE-2024-1561/custom_no_tool"
}