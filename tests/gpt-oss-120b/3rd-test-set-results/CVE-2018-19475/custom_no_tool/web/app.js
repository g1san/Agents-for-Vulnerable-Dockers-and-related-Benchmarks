const express = require('express');
const { spawn } = require('child_process');
const app = express();

// Whitelisted commands – hard‑coded map, never derived from user input
const allowedCommands = {
  ls: { cmd: 'ls', args: ['-la'] },
  pwd: { cmd: 'pwd', args: [] }
};

function runCommand(commandObj) {
  return new Promise((resolve, reject) => {
    const child = spawn(commandObj.cmd, commandObj.args, { stdio: ['ignore', 'pipe', 'pipe'] });
    let stdout = '';
    let stderr = '';
    child.stdout.on('data', (data) => { stdout += data; });
    child.stderr.on('data', (data) => { stderr += data; });
    child.on('error', (err) => reject(err));
    child.on('close', (code) => {
      if (code === 0) {
        resolve(stdout);
      } else {
        reject(new Error(stderr));
      }
    });
  });
}

app.get('/run', async (req, res) => {
  const name = req.query.cmd;
  const entry = allowedCommands[name];
  if (!entry) {
    return res.status(400).send('Invalid or unsupported command');
  }
  try {
    const output = await runCommand(entry);
    res.send(`Output: ${output}`);
  } catch (err) {
    res.status(500).send(`Error: ${err.message}`);
  }
});

app.listen(3000, '0.0.0.0', () => console.log('App listening on port 3000'));