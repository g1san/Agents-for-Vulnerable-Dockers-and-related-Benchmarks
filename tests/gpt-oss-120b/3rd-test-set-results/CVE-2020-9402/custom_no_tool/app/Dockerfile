FROM python:3.9-slim
WORKDIR /app
# Install system dependencies required by Django GIS and Oracle Instant Client
RUN apt-get update && apt-get install -y \
    libaio1 \
    libaio-dev \
    unzip \
    zip \
    libgeos-dev \
    libproj-dev \
    gdal-bin \
    libgdal-dev \
    wget \
    gcc \
    g++ \
    make \
    python3-dev \
    libncurses5-dev \
    libssl-dev \
    netcat-openbsd \
 && rm -rf /var/lib/apt/lists/*
# Install Oracle Instant Client (Basic and SDK) with license acceptance cookie
ENV ORACLE_INSTANT_CLIENT_VERSION=19.12.0.0.0
RUN mkdir -p /opt/oracle && cd /opt/oracle && \
    wget --no-check-certificate --header "Cookie: oraclelicense=accept-securedownload" \
        https://download.oracle.com/otn_software/linux/instantclient/instantclient-basic-linux.x64-${ORACLE_INSTANT_CLIENT_VERSION}.zip && \
    wget --no-check-certificate --header "Cookie: oraclelicense=accept-securedownload" \
        https://download.oracle.com/otn_software/linux/instantclient/instantclient-sdk-linux.x64-${ORACLE_INSTANT_CLIENT_VERSION}.zip && \
    unzip instantclient-basic-linux.x64-${ORACLE_INSTANT_CLIENT_VERSION}.zip && \
    unzip instantclient-sdk-linux.x64-${ORACLE_INSTANT_CLIENT_VERSION}.zip && \
    rm *.zip && \
    ln -s /opt/oracle/instantclient_19_12 /opt/oracle/instantclient && \
    echo "/opt/oracle/instantclient" > /etc/ld.so.conf.d/oracle-instantclient.conf && ldconfig
ENV LD_LIBRARY_PATH=/opt/oracle/instantclient
# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir --upgrade --force-reinstall oracledb
# Copy application code
COPY . .
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh
EXPOSE 8000
ENTRYPOINT ["/app/entrypoint.sh"]