from django.http import JsonResponse
from django.contrib.gis.geos import Point
from .models import Location

def gis_endpoint(request):
    # The 'tolerance' parameter is taken directly from the request and passed to the ORM.
    # This mirrors the vulnerable pattern in CVE‑2020‑9402.
    tolerance = request.GET.get('tolerance', '0')
    reference_point = Point(0, 0, srid=4326)
    # Vulnerable query – the tolerance value is inserted without validation.
    queryset = Location.objects.filter(geom__distance_lte=(reference_point, tolerance))
    return JsonResponse({'count': queryset.count()})