FROM debian:stable-slim
ENV DEBIAN_FRONTEND=noninteractive

# Install required packages (Bash, Apache with CGI, OpenSSH)
RUN apt-get update && \
    apt-get install -y --no-install-recommends apache2 bash openssh-server && \
    rm -rf /var/lib/apt/lists/*

# Configure SSH and generate host keys
RUN mkdir -p /var/run/sshd && echo 'root:toor' | chpasswd && \
    sed -i 's/^#*PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#*PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    ssh-keygen -A

# Enable CGI module (the correct module is "cgid")
RUN a2enmod cgid

# Copy Apache configuration
COPY 000-default.conf /etc/apache2/sites-available/000-default.conf

# Add the vulnerable CGI script
COPY vulnerable.cgi /usr/lib/cgi-bin/vulnerable.cgi
RUN chmod +x /usr/lib/cgi-bin/vulnerable.cgi

# Expose required ports
EXPOSE 80 22

# Copy start script
COPY start.sh /start.sh
RUN chmod +x /start.sh

CMD ["/start.sh"]