FROM golang:1.20-alpine AS builder
WORKDIR /src
COPY . .
ENV CGO_ENABLED=1
# Install MySQL client C library, development headers, and a C compiler
RUN apk add --no-cache mariadb-connector-c mariadb-connector-c-dev gcc musl-dev
# Disable sumdb verification to avoid external checksum checks
ENV GOSUMDB=off
# Remove any existing go.sum to avoid checksum mismatches and regenerate it
RUN rm -f go.sum && go mod tidy
# Download module dependencies
RUN go mod download
# Build the vulnerable Go binary
RUN go build -o vulnerable-app .

FROM alpine:3.18
WORKDIR /app
COPY --from=builder /src/vulnerable-app .
COPY --from=builder /src/docker-entrypoint.sh .
COPY --from=builder /src/init.sql .
RUN chmod +x docker-entrypoint.sh \
    && apk add --no-cache mariadb-client
EXPOSE 8080
ENTRYPOINT ["/app/docker-entrypoint.sh"]