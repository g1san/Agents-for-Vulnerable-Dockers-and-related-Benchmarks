version: "3.8"

services:
  dind:
    image: docker:19.03-dind
    privileged: true
    command: ["dockerd", "-H", "unix:///var/run/docker.sock"]
    environment:
      - DOCKER_TLS_CERTDIR=
    volumes:
      - dind-storage:/var/lib/docker
    ports:
      - "2375:2375"

  mysql:
    image: mysql:5.7
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: example_root_pwd
      MYSQL_DATABASE: drupal
      MYSQL_USER: drupal
      MYSQL_PASSWORD: drupal_pwd
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  drupal:
    image: drupal:7.61
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DRUPAL_DB_HOST: mysql
      DRUPAL_DB_USER: drupal
      DRUPAL_DB_PASSWORD: drupal_pwd
      DRUPAL_DB_NAME: drupal
    ports:
      - "80:80"
    volumes:
      - drupal-data:/var/www/html

volumes:
  dind-storage:
  mysql-data:
  drupal-data: