#!/bin/sh
set -e

HOST="vulnerable-docker"
PORT="2375"

# Wait until the Docker daemon inside DinD is ready (up to 30 seconds).
wait_for_docker() {
  for i in $(seq 1 30); do
    if curl -s "http://${HOST}:${PORT}/_ping" | grep -q 'OK'; then
      return 0
    fi
    sleep 1
  done
  echo "Docker daemon did not become ready" >&2
  exit 1
}

wait_for_docker

# Pull a minimal Alpine image from Docker Hub
curl -s -X POST "http://${HOST}:${PORT}/images/create?fromImage=alpine&tag=3.18" > /dev/null

# Create a container and capture its full ID
CID=$(curl -s -X POST "http://${HOST}:${PORT}/containers/create?name=demo" \
     -H "Content-Type: application/json" \
     -d '{"Image":"alpine:3.18","Cmd":["sh","-c","echo Hello from DinD"]}' | jq -r .Id)

# Start the container using the captured ID
curl -s -X POST "http://${HOST}:${PORT}/containers/${CID}/start" > /dev/null

# Retrieve and display the container's output logs
curl -s "http://${HOST}:${PORT}/containers/${CID}/logs?stdout=1&stderr=1"
