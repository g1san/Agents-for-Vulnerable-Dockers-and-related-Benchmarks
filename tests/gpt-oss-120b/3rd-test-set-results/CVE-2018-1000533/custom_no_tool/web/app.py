import os
import time
from flask import Flask, request, jsonify
import mysql.connector

app = Flask(__name__)

# Base directory for safe file reads
SAFE_BASE_DIR = os.path.abspath(os.path.join(os.getcwd(), 'safe_files'))

def get_db_connection(retries=5, delay=2):
    for attempt in range(retries):
        try:
            conn = mysql.connector.connect(
                host=os.getenv('DB_HOST', 'db'),
                user=os.getenv('DB_USER', 'root'),
                password=os.getenv('DB_PASSWORD', 'example'),
                database=os.getenv('DB_NAME', 'vuln_db')
            )
            return conn
        except mysql.connector.Error as e:
            if attempt < retries - 1:
                time.sleep(delay)
            else:
                raise e

@app.route('/read', methods=['GET'])
def read_file():
    filename = request.args.get('file')
    if not filename:
        return jsonify({'error': 'file parameter required'}), 400
    # Resolve path and ensure it stays within SAFE_BASE_DIR
    requested_path = os.path.abspath(os.path.join(SAFE_BASE_DIR, filename))
    if not requested_path.startswith(SAFE_BASE_DIR):
        return jsonify({'error': 'Access to the requested path is denied'}), 403
    try:
        with open(requested_path, 'r') as f:
            data = f.read()
        return jsonify({'content': data})
    except FileNotFoundError:
        return jsonify({'error': 'File not found'}), 404
    except Exception as e:
        return jsonify({'error': 'Unable to read file'}), 500

@app.route('/users', methods=['GET'])
def list_users():
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT id, username FROM users")
        rows = cursor.fetchall()
        cursor.close()
        conn.close()
        return jsonify(rows)
    except Exception as e:
        return jsonify({'error': 'Database query failed'}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)