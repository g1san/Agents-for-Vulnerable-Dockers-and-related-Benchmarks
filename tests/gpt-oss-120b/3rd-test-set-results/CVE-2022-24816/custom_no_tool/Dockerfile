FROM openjdk:11-jre-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV GEOSERVER_VERSION=2.20.0
ENV GEOSERVER_HOME=/opt/geoserver
ENV JAVA_HOME=/opt/java/openjdk

RUN apt-get update && apt-get install -y --no-install-recommends wget unzip ca-certificates \
    && wget -q https://downloads.sourceforge.net/project/geoserver/GeoServer/${GEOSERVER_VERSION}/geoserver-${GEOSERVER_VERSION}-bin.zip -O /tmp/geoserver.zip \
    && mkdir -p /opt/${GEOSERVER_VERSION}_tmp \
    && unzip /tmp/geoserver.zip -d /opt/${GEOSERVER_VERSION}_tmp \
    && if [ -d /opt/${GEOSERVER_VERSION}_tmp/geoserver-${GEOSERVER_VERSION} ]; then \
         mv /opt/${GEOSERVER_VERSION}_tmp/geoserver-${GEOSERVER_VERSION} ${GEOSERVER_HOME}; \
       else \
         mkdir -p ${GEOSERVER_HOME} && mv /opt/${GEOSERVER_VERSION}_tmp/* ${GEOSERVER_HOME}; \
       fi \
    && rm -rf /opt/${GEOSERVER_VERSION}_tmp \
    && chmod +x ${GEOSERVER_HOME}/bin/startup.sh \
    && rm -f ${GEOSERVER_HOME}/webapps/geoserver/WEB-INF/lib/*jt-jiffle*.jar \
    && wget -q https://repo1.maven.org/maven2/org/geotools/gt-jt-jiffle/1.1.22/gt-jt-jiffle-1.1.22.jar -O ${GEOSERVER_HOME}/webapps/geoserver/WEB-INF/lib/gt-jt-jiffle-1.1.22.jar \
    && rm -rf /tmp/geoserver.zip \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

EXPOSE 8080

CMD ["/opt/geoserver/bin/startup.sh"]