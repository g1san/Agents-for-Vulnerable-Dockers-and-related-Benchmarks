import os
from flask import Flask, request, jsonify
import psycopg2
import psycopg2.extras

app = Flask(__name__)

DB_HOST = os.getenv('POSTGRES_HOST', 'db')
DB_NAME = os.getenv('POSTGRES_DB', 'testdb')
DB_USER = os.getenv('POSTGRES_USER', 'testuser')
DB_PASS = os.getenv('POSTGRES_PASSWORD', 'testpass')

def get_connection():
    """Create a new database connection on demand.
    This deferred approach allows the container to start even if the
    PostgreSQL service is not yet ready; the first request will attempt
    the connection and will raise a clear error if it fails.
    """
    return psycopg2.connect(host=DB_HOST, dbname=DB_NAME, user=DB_USER, password=DB_PASS)

@app.route('/login', methods=['POST'])
def login():
    if not request.is_json:
        return jsonify({"status": "failure", "error": "JSON body required"}), 400
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')
    if username is None or password is None:
        return jsonify({"status": "failure", "error": "Missing credentials"}), 400
    try:
        conn = get_connection()
        cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
        query = "SELECT * FROM users WHERE username = %s AND password = %s"
        cur.execute(query, (username, password))
        user = cur.fetchone()
        cur.close()
        conn.close()
    except Exception:
        # Return a generic error instead of leaking internal details
        return jsonify({"status": "failure", "error": "Database error"}), 500
    if user:
        return jsonify({"status": "success", "user": user['username']})
    else:
        return jsonify({"status": "failure"}), 401

if __name__ == '__main__':
    mode = os.getenv('VULN_MODE', 'none')
    if mode == 'exploit':
        # Enable debug mode for testing/exploitation
        app.run(host='0.0.0.0', port=80, debug=True)
    else:
        app.run(host='0.0.0.0', port=80)