{
    "files": [
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/docker-compose.yml",
            "content": "version: '3.8'\nservices:\n  vulnerable_app:\n    build: .\n    image: vulnerable/app:1.0.0\n    container_name: vulnerable_app\n    ports:\n      - \"80:80\"\n    environment:\n      - VULN_MODE=exploit\n    depends_on:\n      - db\n  db:\n    image: \"postgres:12-alpine\"\n    container_name: vulnerable_db\n    environment:\n      POSTGRES_USER: testuser\n      POSTGRES_PASSWORD: testpass\n      POSTGRES_DB: testdb\n    ports:\n      - \"5432:5432\"\n    volumes:\n      - db_data:/var/lib/postgresql/data\n      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql\n  adminer:\n    image: adminer:4.7.8\n    container_name: adminer\n    ports:\n      - \"8080:8080\"\n    depends_on:\n      - db\n    environment:\n      - ADMINER_DEFAULT_SERVER=db\n  php:\n    image: php:8.2-apache\n    container_name: php_service\n    # No host port mapping needed; service is reachable internally on its default port 80\n    depends_on:\n      - db\n    volumes:\n      - ./php:/var/www/html\nvolumes:\n  db_data:\n    driver: local"
        },
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/Dockerfile",
            "content": "FROM python:3.9-slim\nWORKDIR /app\nCOPY ./app /app\n# Install minimal runtime certificates and netcat-openbsd for health\u2011check script\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends ca-certificates netcat-openbsd && \\\n    rm -rf /var/lib/apt/lists/*\nRUN pip install --no-cache-dir -r requirements.txt\n# Copy the wait\u2011for\u2011db entrypoint script and make it executable\nCOPY ./app/wait_for_db.sh /app/wait_for_db.sh\nRUN chmod +x /app/wait_for_db.sh\nEXPOSE 80\nENV VULN_MODE=none\nENTRYPOINT [\"/app/wait_for_db.sh\"]\nCMD [\"python\", \"app.py\"]"
        },
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/app/app.py",
            "content": "import os\nfrom flask import Flask, request, jsonify\nimport psycopg2\nimport psycopg2.extras\n\napp = Flask(__name__)\n\nDB_HOST = os.getenv('POSTGRES_HOST', 'db')\nDB_NAME = os.getenv('POSTGRES_DB', 'testdb')\nDB_USER = os.getenv('POSTGRES_USER', 'testuser')\nDB_PASS = os.getenv('POSTGRES_PASSWORD', 'testpass')\n\ndef get_connection():\n    \"\"\"Create a new database connection on demand.\n    This deferred approach allows the container to start even if the\n    PostgreSQL service is not yet ready; the first request will attempt\n    the connection and will raise a clear error if it fails.\n    \"\"\"\n    return psycopg2.connect(host=DB_HOST, dbname=DB_NAME, user=DB_USER, password=DB_PASS)\n\n@app.route('/login', methods=['POST'])\ndef login():\n    if not request.is_json:\n        return jsonify({\"status\": \"failure\", \"error\": \"JSON body required\"}), 400\n    data = request.get_json()\n    username = data.get('username')\n    password = data.get('password')\n    if username is None or password is None:\n        return jsonify({\"status\": \"failure\", \"error\": \"Missing credentials\"}), 400\n    try:\n        conn = get_connection()\n        cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)\n        query = \"SELECT * FROM users WHERE username = %s AND password = %s\"\n        cur.execute(query, (username, password))\n        user = cur.fetchone()\n        cur.close()\n        conn.close()\n    except Exception:\n        # Return a generic error instead of leaking internal details\n        return jsonify({\"status\": \"failure\", \"error\": \"Database error\"}), 500\n    if user:\n        return jsonify({\"status\": \"success\", \"user\": user['username']})\n    else:\n        return jsonify({\"status\": \"failure\"}), 401\n\nif __name__ == '__main__':\n    mode = os.getenv('VULN_MODE', 'none')\n    if mode == 'exploit':\n        # Enable debug mode for testing/exploitation\n        app.run(host='0.0.0.0', port=80, debug=True)\n    else:\n        app.run(host='0.0.0.0', port=80)"
        },
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/app/requirements.txt",
            "content": "Flask==2.0.3\nWerkzeug==2.0.3\npsycopg2-binary==2.9.3"
        },
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/app/init-db.sql",
            "content": "CREATE TABLE users (\n    id SERIAL PRIMARY KEY,\n    username VARCHAR(50) NOT NULL,\n    password VARCHAR(255) NOT NULL\n);\nINSERT INTO users (username, password) VALUES\n    ('admin', 'adminpass'),\n    ('user', 'userpass');"
        },
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/app/wait_for_db.sh",
            "content": "#!/bin/sh\n# Wait for PostgreSQL to become reachable before starting the Flask app\nHOST=\"${POSTGRES_HOST:-db}\"\nPORT=\"${POSTGRES_PORT:-5432}\"\n\nwhile ! nc -z \"$HOST\" \"$PORT\"; do\n  echo \"Waiting for PostgreSQL at $HOST:$PORT...\"\n  sleep 2\ndone\n\nexec \"$@\""
        },
        {
            "location": "./../../dockers/CVE-2021-21311/custom_no_tool/php/index.php",
            "content": "<?php\nphpinfo();\n?>"
        }
    ],
    "directory_tree": "CVE-2021-21311/custom_no_tool"
}