FROM debian:bullseye-slim

# Install required development tools, libraries and runtime SSL package (use libssl3 instead of libssl1.1)
RUN apt-get update && apt-get install -y \
    wget \
    build-essential \
    autoconf \
    automake \
    libtool \
    libssl-dev \
    libssl3 \
    libpcre3-dev \
    zlib1g-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /goahead

# Download GoAhead source for version 3.6.4 (tag includes leading 'v')
RUN wget -O goahead.tar.gz https://github.com/goahead/goahead/archive/refs/tags/v3.6.4.tar.gz \
    && tar -xzf goahead.tar.gz --strip-components=1 \
    && rm goahead.tar.gz

# Generate the configure script and build
RUN autoreconf -i \
    && ./configure --prefix=/usr/local \
    && make \
    && make install

# Create document root required by GoAhead CGI
RUN mkdir -p /var/www

# Copy a minimal configuration file
COPY goahead.cfg /etc/goahead.cfg

# Expose the default HTTP port used by GoAhead
EXPOSE 80

# Run GoAhead with the provided configuration file (full binary path)
CMD ["/usr/local/bin/goahead", "-c", "/etc/goahead.cfg"]