#!/usr/bin/env bash
#   Use this script to test if a given TCP host/port are available
#   Adapted from the original wait-for-it script
set -e

HOST=
PORT=
TIMEOUT=15
STRICT=0
QUIET=0

usage(){
  cat << USAGE
Usage: $0 host:port [-t timeout] [-- command args]
 -t TIMEOUT  Timeout in seconds, zero for no timeout
 --strict    Only execute subcommand if the test succeeds
 --quiet     Don't output any status messages
USAGE
}

while [[ "$#" -gt 0 ]]; do
  case $1 in
    *:* )
      HOSTPORT=(${1//:/ })
      HOST=${HOSTPORT[0]}
      PORT=${HOSTPORT[1]}
      shift
      ;;
    -t)
      TIMEOUT=$2
      shift 2
      ;;
    --strict)
      STRICT=1
      shift
      ;;
    --quiet)
      QUIET=1
      shift
      ;;
    --)
      shift
      CMD=($(printf "%s " "$@"))
      break
      ;;
    *)
      usage
      exit 1
      ;;
  esac
done

if [[ -z "$HOST" || -z "$PORT" ]]; then
  echo "Error: host and port must be specified"
  usage
  exit 1
fi

wait_until_ready(){
  if [[ $TIMEOUT -gt 0 ]]; then
    end=$(($(date +%s) + TIMEOUT))
  fi
  while :; do
    if nc -z "$HOST" "$PORT"; then
      return 0
    fi
    if [[ $TIMEOUT -gt 0 && $(date +%s) -ge $end ]]; then
      return 1
    fi
    sleep 0.5
  done
}

if wait_until_ready; then
  [[ $QUIET -eq 0 ]] && echo "$HOST:$PORT is available"
else
  echo "Timeout occurred after waiting $TIMEOUT seconds for $HOST:$PORT"
  [[ $STRICT -eq 1 ]] && exit 1
fi

if [[ ${#CMD[@]} -gt 0 ]]; then
  exec "${CMD[@]}"
fi