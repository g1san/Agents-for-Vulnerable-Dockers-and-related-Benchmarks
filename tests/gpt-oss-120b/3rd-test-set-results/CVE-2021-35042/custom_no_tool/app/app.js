const express = require('express');
const { Pool } = require('pg');
const tar = require('tar');
const path = require('path');
const fs = require('fs');

const app = express();
app.use(express.json());

const pool = new Pool({
  host: process.env.DB_HOST || 'db',
  port: process.env.DB_PORT || 5432,
  user: process.env.DB_USER || 'user',
  password: process.env.DB_PASSWORD || 'example',
  database: process.env.DB_NAME || 'vulndb'
});

// Ensure extraction directory exists
const extractDir = '/tmp/extract';
fs.mkdirSync(extractDir, { recursive: true });

// Vulnerable endpoint – extracts a tar archive without proper path sanitization (CVE-2021-35042)
app.post('/upload', (req, res) => {
  // In a real scenario, the tar file would be received in the request body.
  // Here we simulate extraction of a pre‑stored malicious archive.
  const maliciousArchive = path.join(__dirname, 'malicious.tar');
  tar.x({
    file: maliciousArchive,
    C: extractDir // extraction directory
    // The vulnerable version of tar does not enforce safe path checks.
  })
    .then(() => {
      res.send('Archive extracted');
    })
    .catch(err => {
      res.status(500).send('Extraction failed');
    });
});

app.get('/users', async (req, res) => {
  try {
    const result = await pool.query('SELECT id, username FROM users');
    res.json(result.rows);
  } catch (e) {
    res.status(500).send('DB error');
  }
});

app.listen(8080, () => {
  console.log('Vulnerable app listening on port 8080');
});