# -*- coding: utf-8 -*-
import time
import sys
from flask import Flask, request, jsonify
import docker
from docker.errors import DockerException

app = Flask(__name__)

# -----------------------------------------------
# Docker client initialization with retry logic
# -----------------------------------------------

def get_docker_client(retries=3, delay=2):
    for attempt in range(1, retries + 1):
        try:
            # Use environment variables (DOCKER_HOST) – fallback to default socket
            client = docker.from_env()
            # Trigger a cheap API call to verify connectivity
            client.ping()
            return client
        except DockerException as e:
            if attempt == retries:
                raise
            time.sleep(delay)
    # Should never reach here
    raise DockerException("Unable to establish Docker client connection after retries")

# Initialise client lazily – the first request will attempt connection
client = None

@app.route('/')
def index():
    return 'Vulnerable Docker API Demo - CVE-2016-3088'

@app.route('/run', methods=['POST'])
def run_container():
    global client
    if client is None:
        try:
            client = get_docker_client()
        except DockerException as e:
            return jsonify({'error': f'Docker client init failed: {e}'}), 500

    data = request.get_json()
    if not data or 'image' not in data:
        return jsonify({'error': 'Missing "image" field'}), 400
    image = data['image']
    try:
        # Pull the requested image without validation (demonstration purposes)
        client.images.pull(image)
        # Run container with safe defaults – no privileged flag, default bridge network
        container = client.containers.run(
            image,
            detach=True,
            tty=True,
        )
        return jsonify({
            'status': 'container started',
            'id': container.id[:12]
        })
    except DockerException as e:
        return jsonify({'error': str(e)}), 500
    except Exception as e:
        # Catch any unexpected errors
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    # Bind to all interfaces so it is reachable from host
    app.run(host='0.0.0.0', port=5000)
