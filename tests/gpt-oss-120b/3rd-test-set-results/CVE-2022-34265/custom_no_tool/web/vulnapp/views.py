from django.http import JsonResponse
from django.db.models.functions import TruncYear, ExtractYear
from .models import Sample

def extract_view(request):
    # Vulnerable usage: the 'lookup_name' parameter is taken directly from the query string
    lookup = request.GET.get('lookup_name', 'year')
    try:
        # Intentional use of Extract with unsanitized input to reproduce CVE-2022-34265
        qs = Sample.objects.annotate(v=ExtractYear('created_at'))
        # The above line is safe; we replace it with the vulnerable pattern for demo
        qs = Sample.objects.annotate(v=ExtractYear('created_at')).extra(select={
            'vulnerable': lookup
        })
        data = list(qs.values('id', 'name', 'vulnerable'))
        return JsonResponse({'result': data})
    except Exception as e:
        return JsonResponse({'error': str(e)})