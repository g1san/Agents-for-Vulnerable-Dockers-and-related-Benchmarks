import os
import subprocess
from flask import Flask, jsonify, request
import mysql.connector

app = Flask(__name__)

# Vulnerable endpoint that executes whatever is in the CMD environment variable
@app.route('/run', methods=['GET'])
def run_cmd():
    cmd = os.getenv('CMD')
    # Execute the command safely using subprocess.run
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    output = result.stdout if result.returncode == 0 else result.stderr
    return jsonify({"command": cmd, "output": output.strip()})

# Simple DB test endpoint
@app.route('/db', methods=['GET'])
def db_test():
    try:
        cnx = mysql.connector.connect(
            host='db',
            user='testuser',
            password='testpass',
            database='testdb'
        )
        cursor = cnx.cursor()
        cursor.execute('SELECT message FROM greetings LIMIT 1;')
        row = cursor.fetchone()
        return jsonify({"greeting": row[0] if row else 'No data'})
    except Exception as e:
        return jsonify({"error": str(e)})
    finally:
        if 'cnx' in locals() and cnx.is_connected():
            cnx.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)