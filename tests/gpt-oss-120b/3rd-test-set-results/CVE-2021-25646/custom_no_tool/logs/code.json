{
    "files": [
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/docker-compose.yml",
            "content": "services:\n  vulnerable_app:\n    build: ./app\n    environment:\n      - CMD=${CMD:-echo no command provided}\n    ports:\n      - \"5000:5000\"\n    depends_on:\n      db:\n        condition: service_healthy\n      druid:\n        condition: service_started\n  db:\n    image: mysql:5.7\n    environment:\n      MYSQL_ROOT_PASSWORD: rootpass\n      MYSQL_DATABASE: testdb\n      MYSQL_USER: testuser\n      MYSQL_PASSWORD: testpass\n    ports:\n      - \"3306:3306\"\n    volumes:\n      - db_data:/var/lib/mysql\n      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql\n    healthcheck:\n      test: [\"CMD\", \"mysqladmin\", \"ping\", \"-h\", \"localhost\"]\n      interval: 5s\n      timeout: 2s\n      retries: 10\n  druid:\n    build: ./druid\n    environment:\n      - DRUID_HOST=0.0.0.0\n      - DRUID_JAVA_OPTS=-Xms512m -Xmx512m\n    ports:\n      - \"8082:8082\"\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8082/status\"]\n      interval: 5s\n      timeout: 2s\n      retries: 10\nvolumes:\n  db_data:\n"
        },
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/app/Dockerfile",
            "content": "FROM python:3.9-slim\nWORKDIR /app\nCOPY requirements.txt requirements.txt\nRUN pip install --no-cache-dir -r requirements.txt\n# Install netcat for health\u2011check loop in entrypoint and fix line endings\nRUN apt-get update && apt-get install -y netcat-openbsd && rm -rf /var/lib/apt/lists/*\nCOPY app.py app.py\nCOPY entrypoint.sh entrypoint.sh\n# Convert Windows line endings to Unix and ensure executable bit\nRUN sed -i 's/\\r$//' entrypoint.sh && chmod +x entrypoint.sh\nEXPOSE 5000\nENTRYPOINT [\"/app/entrypoint.sh\"]"
        },
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/app/requirements.txt",
            "content": "Flask==2.0.3\nWerkzeug==2.0.3\nmysql-connector-python==8.0.28"
        },
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/app/app.py",
            "content": "import os\nimport subprocess\nfrom flask import Flask, jsonify, request\nimport mysql.connector\n\napp = Flask(__name__)\n\n# Vulnerable endpoint that executes whatever is in the CMD environment variable\n@app.route('/run', methods=['GET'])\ndef run_cmd():\n    cmd = os.getenv('CMD')\n    # Execute the command safely using subprocess.run\n    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)\n    output = result.stdout if result.returncode == 0 else result.stderr\n    return jsonify({\"command\": cmd, \"output\": output.strip()})\n\n# Simple DB test endpoint\n@app.route('/db', methods=['GET'])\ndef db_test():\n    try:\n        cnx = mysql.connector.connect(\n            host='db',\n            user='testuser',\n            password='testpass',\n            database='testdb'\n        )\n        cursor = cnx.cursor()\n        cursor.execute('SELECT message FROM greetings LIMIT 1;')\n        row = cursor.fetchone()\n        return jsonify({\"greeting\": row[0] if row else 'No data'})\n    except Exception as e:\n        return jsonify({\"error\": str(e)})\n    finally:\n        if 'cnx' in locals() and cnx.is_connected():\n            cnx.close()\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5000)"
        },
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/app/entrypoint.sh",
            "content": "#!/bin/sh\n# Wait for MySQL to be ready before starting the Flask app\nwhile ! nc -z db 3306; do\n  echo \"Waiting for MySQL to be available...\"\n  sleep 2\ndone\n\necho \"MySQL is up - starting Flask application\"\nexec python app.py"
        },
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/db/init.sql",
            "content": "CREATE TABLE IF NOT EXISTS greetings (\n    id INT AUTO_INCREMENT PRIMARY KEY,\n    message VARCHAR(255) NOT NULL\n);\nINSERT INTO greetings (message) VALUES ('Hello from Druid demo');"
        },
        {
            "location": "./../../dockers/CVE-2021-25646/custom_no_tool/druid/Dockerfile",
            "content": "FROM eclipse-temurin:8-jre-alpine\nLABEL maintainer=\"security@example.com\"\nENV DRUID_VERSION=0.19.5\nENV DRUID_HOME=/opt/druid\nENV PATH=$DRUID_HOME/bin:$PATH\n# Install required utilities and CA certificates\nRUN apk add --no-cache bash curl tar ca-certificates && update-ca-certificates\n# Install Druid distribution\nRUN mkdir -p $DRUID_HOME && \\\n    curl -fSL https://archive.apache.org/dist/druid/${DRUID_VERSION}/apache-druid-${DRUID_VERSION}-bin.tar.gz | \\\n    tar -xz -C $DRUID_HOME --strip-components=1 && \\\n    chmod +x $DRUID_HOME/bin/*\nWORKDIR $DRUID_HOME\n# Default command (kept for reference, not used in compose)\nCMD [\"bin/post-index-task\", \"--host\", \"localhost\", \"--port\", \"8082\"]"
        }
    ],
    "directory_tree": "CVE-2021-25646/custom_no_tool"
}