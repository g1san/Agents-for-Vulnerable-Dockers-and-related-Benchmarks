#!/bin/bash
set -e

# Wait for MySQL to become reachable
while ! mysql -h"${DRUPAL_DB_HOST}" -u"${DRUPAL_DB_USER}" -p"${DRUPAL_DB_PASSWORD}" -e "SELECT 1" "${DRUPAL_DB_NAME}" >/dev/null 2>&1; do
  echo "Waiting for MySQL to be ready..."
  sleep 5
done

# If Drupal is not yet installed, perform site installation using Drush
if ! drush status bootstrap | grep -q "Successful"; then
  echo "Installing Drupal site..."
  drush site-install standard \
    --db-url="mysql://${DRUPAL_DB_USER}:${DRUPAL_DB_PASSWORD}@${DRUPAL_DB_HOST}/${DRUPAL_DB_NAME}" \
    --site-name="Demo Site" \
    --account-name=admin \
    --account-pass=admin \
    --yes
  echo "Loading sample data..."
  drush sql-cli < /tmp/init-db.sql
fi

# Finally launch the original Apache command
exec apache2-foreground