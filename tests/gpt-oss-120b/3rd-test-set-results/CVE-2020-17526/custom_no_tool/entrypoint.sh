#!/usr/bin/env bash
set -e

# Wait for PostgreSQL to be ready using pg_isready (installed via postgresql-client)
echo "Waiting for PostgreSQL to become reachable..."
while ! pg_isready -d "$AIRFLOW__CORE__SQL_ALCHEMY_CONN" -U "$(echo $AIRFLOW__CORE__SQL_ALCHEMY_CONN | cut -d'/' -f3 | cut -d':' -f1)" >/dev/null 2>&1; do
  sleep 2
done

echo "PostgreSQL is ready. Initializing Airflow metadata database..."
# Airflow 1.10.x uses 'airflow initdb'
airflow initdb || true

echo "Starting Airflow webserver..."
# Run the webserver as the airflow user
exec gosu airflow airflow webserver