{
    "files": [
        {
            "location": "./../../dockers/CVE-2016-9086/custom_no_tool/docker-compose.yml",
            "content": "version: \"3.8\"\nservices:\n  gitlab:\n    image: gitlab/gitlab-ce:8.13.2\n    hostname: gitlab.example.com\n    container_name: gitlab\n    restart: always\n    ports:\n      - \"8080:80\"\n      - \"8443:443\"\n      - \"2222:22\"\n    environment:\n      GITLAB_OMNIBUS_CONFIG: |\n        external_url 'http://localhost:8080'\n        gitlab_rails['db_adapter'] = 'postgresql'\n        gitlab_rails['db_encoding'] = 'utf8'\n        gitlab_rails['db_database'] = 'gitlabhq_production'\n        gitlab_rails['db_host'] = 'postgres'\n        gitlab_rails['db_username'] = 'gitlab'\n        gitlab_rails['db_password'] = 'gitlab_pass'\n        gitlab_rails['redis_host'] = 'redis'\n    depends_on:\n      - postgres\n      - redis\n    volumes:\n      - ./gitlab/config:/etc/gitlab\n      - ./gitlab/logs:/var/log/gitlab\n      - ./gitlab/data:/var/opt/gitlab\n\n  postgres:\n    image: postgres:9.5\n    container_name: postgres\n    restart: always\n    environment:\n      POSTGRES_USER: gitlab\n      POSTGRES_PASSWORD: gitlab_pass\n      POSTGRES_DB: gitlabhq_production\n    volumes:\n      - ./postgres/data:/var/lib/postgresql/data\n      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql\n    healthcheck:\n      test: [\"CMD\", \"pg_isready\", \"-U\", \"gitlab\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\n  redis:\n    image: redis:5.0\n    container_name: redis\n    restart: always\n    command: [\"redis-server\", \"--appendonly\", \"yes\"]\n    volumes:\n      - ./redis/data:/data\n\n  app:\n    build:\n      context: ./app\n    container_name: vuln_app\n    restart: always\n    ports:\n      - \"5000:5000\"\n    environment:\n      POSTGRES_HOST: postgres\n      POSTGRES_USER: gitlab\n      POSTGRES_PASSWORD: gitlab_pass\n      POSTGRES_DB: gitlabhq_production\n    depends_on:\n      - postgres\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:5000/\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock"
        },
        {
            "location": "./../../dockers/CVE-2016-9086/custom_no_tool/app/Dockerfile",
            "content": "FROM python:3.9-slim\n\nWORKDIR /app\n\n# Copy requirements first so they are available for the pip install step\nCOPY requirements.txt ./\n\n# Install system build dependencies, curl, upgrade pip, install Python dependencies, then clean up\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends gcc libpq-dev libpq5 curl && \\\n    pip install --no-cache-dir --upgrade pip && \\\n    pip install --no-cache-dir -r requirements.txt && \\\n    apt-get purge -y --auto-remove gcc libpq-dev && \\\n    rm -rf /var/lib/apt/lists/*\n\n# Copy the rest of the application source code\nCOPY . .\n\nEXPOSE 5000\n\nCMD [\"python\", \"app.py\"]"
        },
        {
            "location": "./../../dockers/CVE-2016-9086/custom_no_tool/app/requirements.txt",
            "content": "Flask==2.0.3\nWerkzeug==2.0.3\npsycopg2-binary==2.9.6"
        },
        {
            "location": "./../../dockers/CVE-2016-9086/custom_no_tool/app/app.py",
            "content": "import os\nimport socket\nfrom flask import Flask, request, jsonify\nimport psycopg2\n\napp = Flask(__name__)\n\ndef get_db_connection():\n    return psycopg2.connect(\n        host=os.getenv('POSTGRES_HOST', 'postgres'),\n        user=os.getenv('POSTGRES_USER', 'gitlab'),\n        password=os.getenv('POSTGRES_PASSWORD', 'gitlab_pass'),\n        dbname=os.getenv('POSTGRES_DB', 'gitlabhq_production')\n    )\n\n@app.route('/')\ndef index():\n    return 'Vulnerable Flask App - CVE-2016-9086 demonstration'\n\n# Endpoint that illustrates the Docker socket exposure (CVE-2016-9086)\n# An attacker can POST a JSON with a \"cmd\" field that will be executed on the host via the Docker socket.\n@app.route('/run', methods=['POST'])\ndef run_cmd():\n    data = request.get_json(force=True)\n    cmd = data.get('cmd')\n    if not cmd:\n        return jsonify({'error': 'No command provided'}), 400\n    try:\n        payload = f\"{{\\\"Image\\\":\\\"alpine:latest\\\",\\\"Cmd\\\":[\\\"sh\\\",\\\"-c\\\",\\\"{cmd}\\\"]}}\"\n        client = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)\n        client.connect('/var/run/docker.sock')\n        request_line = (\n            f'POST /containers/create?name=vuln_test HTTP/1.1\\r\\n'\n            f'Host: localhost\\r\\n'\n            f'Content-Type: application/json\\r\\n'\n            f'Content-Length: {len(payload)}\\r\\n\\r\\n{payload}'\n        )\n        client.sendall(request_line.encode())\n        response = client.recv(4096)\n        client.close()\n        return jsonify({'docker_response': response.decode()})\n    except Exception as e:\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/data')\ndef get_data():\n    conn = get_db_connection()\n    cursor = conn.cursor()\n    cursor.execute('SELECT * FROM users')\n    rows = cursor.fetchall()\n    cursor.close()\n    conn.close()\n    columns = ['id', 'username', 'email']\n    result = [dict(zip(columns, row)) for row in rows]\n    return jsonify(result)\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5000)\n"
        },
        {
            "location": "./../../dockers/CVE-2016-9086/custom_no_tool/db/init.sql",
            "content": "CREATE TABLE IF NOT EXISTS users (\n  id SERIAL PRIMARY KEY,\n  username VARCHAR(50) NOT NULL,\n  email VARCHAR(100) NOT NULL\n);\nINSERT INTO users (username, email) VALUES\n('alice', 'alice@example.com'),\n('bob', 'bob@example.com');\n"
        }
    ],
    "directory_tree": "CVE-2016-9086/\n\u2514\u2500 custom_no_tool/\n   \u251c\u2500 docker-compose.yml\n   \u251c\u2500 app/\n   \u2502   \u251c\u2500 Dockerfile\n   \u2502   \u251c\u2500 requirements.txt\n   \u2502   \u2514\u2500 app.py\n   \u2514\u2500 db/\n       \u2514\u2500 init.sql"
}