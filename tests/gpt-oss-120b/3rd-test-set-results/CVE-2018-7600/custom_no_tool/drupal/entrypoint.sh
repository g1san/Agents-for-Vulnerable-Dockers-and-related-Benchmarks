#!/bin/bash
set -e

# Wait for MariaDB to become reachable
while ! mysqladmin ping -h"${DRUPAL_DB_HOST}" -u"${DRUPAL_DB_USER}" -p"${DRUPAL_DB_PASSWORD}" --silent; do
  echo "Waiting for MariaDB at ${DRUPAL_DB_HOST}..."
  sleep 2
done

echo "MariaDB is up - continuing with Drupal setup"

# Run drush site:install only if the site is not already installed
if [ ! -f /var/www/html/sites/default/settings.php ] || ! grep -q "\$databases" /var/www/html/sites/default/settings.php; then
  drush site:install standard \
    --account-name=admin \
    --account-pass=admin \
    --db-url="mysqli://${DRUPAL_DB_USER}:${DRUPAL_DB_PASSWORD}@${DRUPAL_DB_HOST}/${MYSQL_DATABASE}" \
    --yes
fi

# Start Apache in the foreground
exec apache2-foreground