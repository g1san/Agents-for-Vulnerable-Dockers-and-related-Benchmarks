FROM php:7.3-apache

# Install required system packages and PHP extensions (including MariaDB client and PDO MySQL)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        libzip-dev \
        libpng-dev libjpeg-dev libfreetype6-dev libpq-dev libxml2-dev \
        git unzip wget mariadb-client && \
    docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
    docker-php-ext-install -j$(nproc) gd xml zip pdo_mysql && \
    rm -rf /var/lib/apt/lists/*

# Install Composer
RUN php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" && \
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer && \
    php -r "unlink('composer-setup.php');"

# Install Drush 8 globally
RUN composer global require drush/drush:8.* && \
    ln -s /root/.composer/vendor/bin/drush /usr/local/bin/drush

# Download vulnerable Drupal 7.58
ARG DRUPAL_VERSION=7.58
ENV DRUPAL_VERSION=${DRUPAL_VERSION}
RUN wget https://ftp.drupal.org/files/projects/drupal-${DRUPAL_VERSION}.tar.gz && \
    tar -xzf drupal-${DRUPAL_VERSION}.tar.gz --strip-components=1 && \
    rm drupal-${DRUPAL_VERSION}.tar.gz && \
    chown -R www-data:www-data /var/www/html

# Copy custom entrypoint and settings
COPY entrypoint.sh /entrypoint.sh
COPY settings.php /var/www/html/sites/default/settings.php

# Ensure the MariaDB client is in PATH and start Apache
ENV PATH="/usr/bin:${PATH}"
ENTRYPOINT ["/entrypoint.sh"]