FROM debian:bookworm-slim

# Install build dependencies required for compiling GoAhead, including m4 for autoreconf
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    wget \
    ca-certificates \
    libssl-dev \
    libpcre3-dev \
    zlib1g-dev \
    autoconf \
    automake \
    libtool \
    git \
    m4 && \
    rm -rf /var/lib/apt/lists/*

# Set GoAhead version (v3.5.0 is vulnerable and available)
ENV GOAHEAD_VERSION=3.5.0

# Download and extract GoAhead source (correct URL without the extra "v" prefix)
RUN mkdir -p /opt/goahead && \
    wget -O /tmp/goahead.tar.gz "https://github.com/embedthis/goahead/archive/refs/tags/${GOAHEAD_VERSION}.tar.gz" && \
    tar -xzf /tmp/goahead.tar.gz -C /opt/goahead --strip-components=1 && \
    rm -f /tmp/goahead.tar.gz

# Configure, build, and place the binary at a known location
RUN cd /opt/goahead && \
    autoreconf -i && \
    ./configure && \
    make clean && make && \
    cp src/goahead /opt/goahead/goahead

# Expose the default GoAhead port
EXPOSE 8080

# Set working directory and entrypoint to start GoAhead
WORKDIR /opt/goahead
CMD ["./goahead", "-v", "-p", "8080"]