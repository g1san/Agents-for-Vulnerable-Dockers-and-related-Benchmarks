from flask import Flask, request, send_file, abort
import os

app = Flask(__name__)

# Base directory for files (absolute path)
BASE_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), 'files'))

# Ensure the files directory exists at runtime (in case it was not created during build)
os.makedirs(BASE_DIR, exist_ok=True)

# Create a sample file if it does not exist (for demonstration/testing)
sample_file_path = os.path.join(BASE_DIR, 'secret.txt')
if not os.path.isfile(sample_file_path):
    with open(sample_file_path, 'w') as f:
        f.write('Sensitive data')

# Vulnerable endpoint: reads arbitrary file based on 'file' parameter (CVE-2021-40438)
@app.route('/download')
def download():
    filename = request.args.get('file')
    if not filename:
        abort(400, 'file parameter required')
    # No sanitization leads to path traversal
    filepath = os.path.join(BASE_DIR, filename)
    if not os.path.isfile(filepath):
        abort(404)
    return send_file(filepath, as_attachment=True)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)