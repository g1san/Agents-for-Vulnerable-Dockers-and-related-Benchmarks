#!/bin/bash
set -e

# Wait for the MySQL service to be ready using Drupal DB credentials
timeout=60
while ! mysqladmin ping -h"${DRUPAL_DB_HOST}" -u"${DRUPAL_DB_USER}" -p"${DRUPAL_DB_PASSWORD}" --silent; do
  timeout=$((timeout-1))
  if [ $timeout -le 0 ]; then
    echo "MySQL not reachable, exiting."
    exit 1
  fi
  echo "Waiting for MySQL..."
  sleep 2
done

# If Drupal is not installed, run site install via Drush
if [ ! -f /var/www/html/sites/default/settings.php ]; then
  echo "Installing Drupal site..."
  drush site:install standard \
    --db-url="mysqli://${DRUPAL_DB_USER}:${DRUPAL_DB_PASSWORD}@${DRUPAL_DB_HOST}/${DRUPAL_DB_NAME}" \
    --site-name="Vulnerable Drupal" \
    --account-name=admin \
    --account-pass=admin \
    -y
fi

# Execute the default command (Apache foreground)
exec "$@"
