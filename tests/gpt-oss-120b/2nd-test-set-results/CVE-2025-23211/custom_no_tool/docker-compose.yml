version: "3.9"
services:
  web:
    image: tandoorrecipes/recipes:1.5.24
    container_name: tandoor_web
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - DEBUG=False
      - ALLOWED_HOSTS=*
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=tandoor
      - DB_USER=tandoor
      - DB_PASSWORD=securepassword
    depends_on:
      - postgres
    volumes:
      - tandoor_media:/opt/recipes/media
      - tandoor_static:/opt/recipes/static
    command: sh -c "python manage.py migrate && python manage.py runserver 0.0.0.0:8080"

  postgres:
    image: postgres:13
    container_name: tandoor_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=tandoor
      - POSTGRES_USER=tandoor
      - POSTGRES_PASSWORD=securepassword
    volumes:
      - postgres_data:/var/lib/postgresql/data

  populate:
    image: alpine:3.20
    container_name: tandoor_populate
    restart: "no"
    depends_on:
      - web
    environment:
      - PGPASSWORD=securepassword
    entrypoint: >
      sh -c "apk add --no-cache postgresql-client && \
      until pg_isready -h postgres -p 5432; do sleep 1; done && \
      psql -h postgres -U tandoor -d tandoor -f /data/init-db.sql"
    volumes:
      - ./init-db.sql:/data/init-db.sql:ro

volumes:
  tandoor_media:
  tandoor_static:
  postgres_data: