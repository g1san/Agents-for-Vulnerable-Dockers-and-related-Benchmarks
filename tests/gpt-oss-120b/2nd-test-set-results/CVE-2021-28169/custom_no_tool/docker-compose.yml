services:
  vulnerable_engine:
    build: ./engine
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
    ports:
      - "2375:2375"
    command: ["dockerd-entrypoint.sh", "dockerd", "-H", "tcp://0.0.0.0:2375", "-H", "unix:///var/run/docker.sock", "--storage-driver=overlay2"]
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 2s
      timeout: 5s
      start_period: 5s
      retries: 20
  exploiter:
    build: ./app
    depends_on:
      vulnerable_engine:
        condition: service_healthy
    environment:
      - DOCKER_HOST=tcp://vulnerable_engine:2375
    command: ["sh", "/trigger.sh"]
    restart: "no"