FROM debian:bullseye-slim

# Install required packages: Python, pip, Docker SDK, ImageMagick, PHP and imagick extension
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        curl \
        gnupg \
        imagemagick \
        php-cli \
        php-imagick \
        php-mbstring \
        php-xml && \
    # Prevent apt from upgrading ImageMagick automatically
    apt-mark hold imagemagick && \
    pip3 install --no-cache-dir docker && \
    rm -rf /var/lib/apt/lists/*

# Expose the ImageMagick version for inspection (the actual version will be whatever is available in the Bullseye repository)
ENV IMAGEMAGICK_VERSION=6.9.3-10
LABEL imagick_vulnerable_version="6.9.3-10"

WORKDIR /app
COPY exploit.py /app/exploit.py
COPY index.php /var/www/html/index.php

EXPOSE 80

# Start both the Python script (to show container listing) and a simple PHP builtâ€‘in server.
CMD ["sh", "-c", "python3 /app/exploit.py & php -S 0.0.0.0:80 -t /var/www/html"]