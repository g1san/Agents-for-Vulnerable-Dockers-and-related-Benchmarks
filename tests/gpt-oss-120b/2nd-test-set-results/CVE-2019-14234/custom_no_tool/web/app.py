from flask import Flask, request, abort, send_from_directory
import os

app = Flask(__name__)

BASE_DIR = '/app/files'

@app.route('/file')
def file():
    filename = request.args.get('path')
    if not filename:
        return 'No path provided', 400
    # Prevent directory traversal attacks
    safe_path = os.path.normpath(filename)
    if safe_path.startswith('..'):
        return 'Invalid path', 403
    # Ensure the final path stays within BASE_DIR
    full_path = os.path.join(BASE_DIR, safe_path)
    if not os.path.abspath(full_path).startswith(os.path.abspath(BASE_DIR) + os.sep):
        return 'Forbidden', 403
    if os.path.isfile(full_path):
        return send_from_directory(BASE_DIR, safe_path)
    else:
        return 'File not found', 404

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
