FROM python:3.9-slim

# Install system dependencies needed for psycopg2 and netcat
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc libpq-dev netcat-openbsd && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
# Copy all source files from the build context into the container
COPY . /app/

RUN pip install --no-cache-dir -r requirements.txt

EXPOSE 5000

# Wait for PostgreSQL to become reachable before starting gunicorn
CMD ["sh", "-c", "while ! nc -z $POSTGRES_HOST 5432; do sleep 1; done && exec gunicorn -b 0.0.0.0:5000 app:app"]