FROM docker:20.10.14-dind

ENV GEOSERVER_VERSION=2.17.2
ENV GEOSERVER_HOME=/opt/geoserver-${GEOSERVER_VERSION}

# Install Java (OpenJDK 11), Bash, curl and unzip, then download and extract GeoServer
RUN apk add --no-cache openjdk11 bash curl unzip && \
    mkdir -p /opt && \
    curl -L -o /tmp/geoserver.zip https://downloads.sourceforge.net/project/geoserver/GeoServer/${GEOSERVER_VERSION}/geoserver-${GEOSERVER_VERSION}-bin.zip && \
    unzip /tmp/geoserver.zip -d /opt && \
    rm /tmp/geoserver.zip && \
    # Ensure the extracted directory matches GEOSERVER_HOME (handle possible "-bin" suffix)
    mv /opt/geoserver-${GEOSERVER_VERSION}* ${GEOSERVER_HOME} && \
    chmod +x ${GEOSERVER_HOME}/bin/startup.sh

EXPOSE 8080

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]