FROM node:18-alpine

# Install git and native‑build tools required by optional npm packages
RUN apk add --no-cache git make gcc g++ python3

WORKDIR /app

# Clone the repository (full history to allow any commit checkout if needed)
RUN git clone https://github.com/ziahamza/webui-aria2.git .

# Overwrite the vulnerable server file with the hardened version
COPY node-server.js /app/node-server.js

# Install only production dependencies and skip running install scripts (avoids node‑sass build failures)
RUN npm ci --omit=dev --ignore-scripts

# Add a minimal public directory so the server has a valid baseDir
COPY public/ ./public/

EXPOSE 80

# Start the server directly with node (the repo does not define an npm start script)
CMD ["node", "node-server.js"]