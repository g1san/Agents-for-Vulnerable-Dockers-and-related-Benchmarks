import os
from flask import Flask, request, jsonify
import pymysql
import requests

app = Flask(__name__)

def get_db():
    return pymysql.connect(host='db', user='root', password='example', database='vuln', cursorclass=pymysql.cursors.DictCursor)

ES_HOST = os.getenv('ES_HOST', 'elasticsearch')

@app.route('/')
def index():
    query = request.args.get('query')
    if query:
        # Forward the user‑supplied query to Elasticsearch using the vulnerable 'source' parameter (CVE‑2014‑3120)
        url = f'http://{ES_HOST}:9200/_search'
        try:
            resp = requests.get(url, params={'source': query})
            return resp.text, resp.status_code, {'Content-Type': resp.headers.get('Content-Type', 'application/json')}
        except Exception as e:
            return str(e), 500
    return "Vulnerable Flask app ready. Use ?query=... to trigger CVE-2014-3120."

@app.route('/users')
def users():
    db = get_db()
    with db.cursor() as cur:
        cur.execute("SELECT * FROM users")
        rows = cur.fetchall()
    return jsonify({"users": rows})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)