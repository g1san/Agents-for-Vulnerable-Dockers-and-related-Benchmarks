services:
  registry:
    image: registry:2.6.2
    container_name: vulnerable_registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
    volumes:
      - ./data:/var/lib/registry

  nginx:
    image: nginx:1.27.0
    container_name: malicious_nginx
    ports:
      - "80:80"
    volumes:
      - ./data:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - registry

  ffmpeg:
    build: ./ffmpeg-custom
    container_name: vulnerable_ffmpeg
    depends_on:
      - nginx
    command: ["sh", "-c", "until curl -s http://nginx:80/playlist.m3u8 >/dev/null; do sleep 1; done && (ffmpeg -loglevel error -i http://nginx:80/playlist.m3u8 -f null - || true); tail -f /dev/null"]
    volumes:
      - ./data:/data