from flask import Flask, request, render_template_string
import pymysql

app = Flask(__name__)

def get_db_connection():
    return pymysql.connect(host='db',
                           user='user',
                           password='userpass',
                           database='testdb',
                           cursorclass=pymysql.cursors.DictCursor)

@app.route('/')
def index():
    return 'Welcome to the vulnerable app. Use /vuln?name=YOUR_INPUT'

# Vulnerable endpoint (SSTI via render_template_string)
@app.route('/vuln')
def vuln():
    name = request.args.get('name', '')
    # Directly render user input without sanitization â€“ CVE-2017-6920 exploitation vector
    return render_template_string(name)

# Simple data display endpoint using the database
@app.route('/users')
def users():
    conn = get_db_connection()
    with conn.cursor() as cursor:
        cursor.execute('SELECT * FROM users')
        rows = cursor.fetchall()
    conn.close()
    output = '<h2>User List</h2><ul>'
    for row in rows:
        output += f"<li>{row['id']}: {row['name']}</li>"
    output += '</ul>'
    return output

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)