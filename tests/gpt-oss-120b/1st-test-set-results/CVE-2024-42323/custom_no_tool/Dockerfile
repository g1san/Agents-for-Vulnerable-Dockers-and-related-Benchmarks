FROM openjdk:11-jre-slim

ARG HERTZBEAT_VERSION=1.5.9
ENV HERTZBEAT_HOME=/opt/hertzbeat

# Install utilities, download HertzBeat, extract it, ensure lib directory exists, replace SnakeYAML with vulnerable version
RUN apt-get update && \
    apt-get install -y --no-install-recommends wget tar ca-certificates && \
    mkdir -p $HERTZBEAT_HOME && \
    wget -O /tmp/hertzbeat.tar.gz https://archive.apache.org/dist/hertzbeat/${HERTZBEAT_VERSION}/apache-hertzbeat-${HERTZBEAT_VERSION}-bin.tar.gz && \
    tar -xzf /tmp/hertzbeat.tar.gz -C $HERTZBEAT_HOME --strip-components=1 && \
    rm -f /tmp/hertzbeat.tar.gz && \
    mkdir -p $HERTZBEAT_HOME/lib && \
    wget -O $HERTZBEAT_HOME/lib/snakeyaml.jar https://repo1.maven.org/maven2/org/yaml/snakeyaml/1.33/snakeyaml-1.33.jar && \
    chmod +x $HERTZBEAT_HOME/bin/start.sh && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR $HERTZBEAT_HOME
EXPOSE 1157
CMD ["sh","-c","bin/start.sh"]