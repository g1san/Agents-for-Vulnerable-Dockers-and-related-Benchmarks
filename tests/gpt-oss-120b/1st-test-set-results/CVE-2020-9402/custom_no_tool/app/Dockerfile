FROM python:3.8-bullseye-slim AS builder

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    LD_LIBRARY_PATH=/opt/oracle/instantclient:$LD_LIBRARY_PATH

# Install build tools and native libraries needed for Pillow, GDAL and Oracle client
RUN apt-get update && apt-get install -y --no-install-recommends \
        gcc \
        g++ \
        make \
        libaio1 libaio-dev \
        python3-dev \
        libffi-dev \
        libjpeg-dev \
        zlib1g-dev \
        libpng-dev \
        libgdal-dev gdal-bin \
        build-essential \
        unzip \
        wget \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Oracle Instant Client Basic and SDK with required license cookie
RUN wget --no-check-certificate \
        --header "Cookie: oraclelicense=accept-securebackup-cookie" \
        https://download.oracle.com/otn_software/linux/instantclient/1919000/instantclient-basic-linux.x64-19.19.0.0.0dbru.zip \
        -O /tmp/instantclient-basic.zip && \
    wget --no-check-certificate \
        --header "Cookie: oraclelicense=accept-securebackup-cookie" \
        https://download.oracle.com/otn_software/linux/instantclient/1919000/instantclient-sdk-linux.x64-19.19.0.0.0dbru.zip \
        -O /tmp/instantclient-sdk.zip && \
    unzip /tmp/instantclient-basic.zip -d /opt/oracle && \
    unzip /tmp/instantclient-sdk.zip -d /opt/oracle && \
    rm /tmp/instantclient-basic.zip /tmp/instantclient-sdk.zip && \
    ln -s /opt/oracle/instantclient_19_19 /opt/oracle/instantclient && \
    echo "/opt/oracle/instantclient" > /etc/ld.so.conf.d/oracle-instantclient.conf && ldconfig

WORKDIR /app
COPY requirements.txt .
RUN pip install --upgrade pip && pip install -r requirements.txt

COPY . .

FROM python:3.8-bullseye-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    LD_LIBRARY_PATH=/opt/oracle/instantclient:$LD_LIBRARY_PATH

# Copy Oracle Instant Client libraries from builder
COPY --from=builder /opt/oracle /opt/oracle

# Install runtime dependencies for Oracle client and GDAL
RUN apt-get update && apt-get install -y --no-install-recommends \
        libaio1 \
        gdal-bin \
    && rm -rf /var/lib/apt/lists/* && \
    echo "/opt/oracle/instantclient" > /etc/ld.so.conf.d/oracle-instantclient.conf && ldconfig

WORKDIR /app
COPY --from=builder /app /app

EXPOSE 8000
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]