FROM httpd:2.4.54

# Install curl (required for healthcheck and wait‑for‑it script)
RUN apt-get update && \
    apt-get install -y curl && \
    rm -rf /var/lib/apt/lists/*

# Download wait‑for‑it script at build time
RUN curl -fsSL https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh -o /usr/local/bin/wait-for-it.sh && \
    chmod +x /usr/local/bin/wait-for-it.sh

# Apache configuration to proxy PHP requests to php‑fpm
RUN echo 'LoadModule proxy_module modules/mod_proxy.so' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'ProxyPassMatch ^/(.*\\.php)$ fcgi://php:9000/var/www/html/\\$1' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'ProxyPassReverse ^/(.*\\.php)$ fcgi://php:9000/var/www/html/\\$1' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'DirectoryIndex index.php index.html' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'DocumentRoot /usr/local/apache2/htdocs' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'ServerName localhost' >> /usr/local/apache2/conf/httpd.conf && \
    echo '<Directory "/usr/local/apache2/htdocs">' >> /usr/local/apache2/conf/httpd.conf && \
    echo '    Options Indexes FollowSymLinks' >> /usr/local/apache2/conf/httpd.conf && \
    echo '    AllowOverride All' >> /usr/local/apache2/conf/httpd.conf && \
    echo '    Require all granted' >> /usr/local/apache2/conf/httpd.conf && \
    echo '</Directory>' >> /usr/local/apache2/conf/httpd.conf && \
    echo 'DirectoryIndex index.php index.html' >> /usr/local/apache2/conf/httpd.conf

# Copy web content (index.php) into the container
COPY public/ /usr/local/apache2/htdocs/

# Entry point waits for PHP‑FPM to be ready before starting Apache
ENTRYPOINT ["/usr/local/bin/wait-for-it.sh", "php:9000", "--", "httpd-foreground"]