FROM alpine:3.18

# Install build dependencies and the libraries required by AppWeb
RUN apk add --no-cache build-base curl openssl-dev pcre-dev zlib-dev linux-headers

# Set AppWeb version (must match the vulnerable version list)
ENV APPWEB_VERSION=7.0.2

# Download, extract, build and install AppWeb
RUN mkdir -p /appweb && \
    curl -L https://github.com/embedthis/appweb/archive/refs/tags/${APPWEB_VERSION}.tar.gz -o /tmp/appweb.tar.gz && \
    tar -xzf /tmp/appweb.tar.gz -C /appweb --strip-components=1 && \
    cd /appweb && \
    ./configure --prefix=/usr/local && \
    make && make install && \
    rm -rf /appweb /tmp/appweb.tar.gz

# Create a minimal document root with a test page
RUN mkdir -p /var/appweb/www && echo "<html><body>AppWeb Test Page</body></html>" > /var/appweb/www/index.html

# Expose HTTP port
EXPOSE 80

# Default command to start AppWeb (full path ensures the binary is found)
CMD ["/usr/local/bin/appweb", "-c", "/etc/appweb.conf"]
