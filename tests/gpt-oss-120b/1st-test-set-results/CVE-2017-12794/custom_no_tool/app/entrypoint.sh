#!/bin/sh
set -eu

# Give PostgreSQL a few seconds to start up, retry until it is ready
for i in $(seq 1 30); do
    if pg_isready -h postgres -U django -d django_db >/dev/null 2>&1; then
        echo "PostgreSQL is ready"
        break
    fi
    echo "Waiting for PostgreSQL... ($i/30)"
    sleep 2
done

# Fail fast if the DB never became ready
pg_isready -h postgres -U django -d django_db >/dev/null 2>&1 || {
    echo "PostgreSQL did not become ready in time"
    exit 1
}

# Apply migrations and optional fixture
python manage.py migrate --noinput
python manage.py loaddata initial_data.json || true

# Finally start the development server
exec python manage.py runserver 0.0.0.0:8000