const express = require('express');
const fs = require('fs');
const path = require('path');
const app = express();
const PORT = 8080;

// Vulnerable endpoint - CVE-2017-12794 demonstration
// Reads arbitrary file based on the 'file' query parameter without proper validation
app.get('/read', (req, res) => {
  const requestedFile = req.query.file;
  if (!requestedFile) {
    return res.status(400).send('Missing "file" query parameter');
  }
  // Intentionally insecure: directly concatenates user input to file system path
  const filePath = path.join(__dirname, requestedFile);
  fs.readFile(filePath, 'utf8', (err, data) => {
    if (err) {
      return res.status(500).send('Error reading file');
    }
    res.type('text/plain').send(data);
  });
});

// Simple health check endpoint
app.get('/', (req, res) => {
  res.send('Vulnerable app running. Use /read?file=relative_path to test path traversal.');
});

app.listen(PORT, () => {
  console.log(`Vulnerable app listening on port ${PORT}`);
});