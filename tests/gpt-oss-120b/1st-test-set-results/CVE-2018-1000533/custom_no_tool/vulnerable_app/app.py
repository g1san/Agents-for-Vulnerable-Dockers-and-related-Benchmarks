import os
from flask import Flask, request, jsonify
import pymysql
app = Flask(__name__)

def get_db_connection():
    return pymysql.connect(host='db',
                           user=os.getenv('MYSQL_USER', 'testuser'),
                           password=os.getenv('MYSQL_PASSWORD', 'testpwd'),
                           db=os.getenv('MYSQL_DATABASE', 'testdb'),
                           cursorclass=pymysql.cursors.DictCursor)

@app.route('/search')
def search():
    # Vulnerable to SQL injection when VULN_MODE is enabled
    query = request.args.get('q', '')
    conn = get_db_connection()
    cursor = conn.cursor()
    if os.getenv('VULN_MODE') == 'enabled':
        sql = f"SELECT * FROM users WHERE name LIKE '%{query}%';"
    else:
        sql = "SELECT * FROM users WHERE name LIKE %s;"
        cursor.execute(sql, ('%' + query + '%',))
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
    # Execute unsafe query
    cursor.execute(sql)
    rows = cursor.fetchall()
    conn.close()
    return jsonify(rows)

@app.route('/')
def index():
    return "Vulnerable App Ready"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)