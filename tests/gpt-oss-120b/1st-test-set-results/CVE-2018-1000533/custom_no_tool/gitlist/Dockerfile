FROM php:7.4-fpm

# Install dependencies needed for GitList and MySQL client
RUN apt-get update && apt-get install -y \
    git unzip libzip-dev default-mysql-client && \
    docker-php-ext-install mysqli && \
    docker-php-ext-configure zip && docker-php-ext-install zip && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /var/www/html

# Clone the specific vulnerable version of GitList (0.5.0)
RUN git clone --branch 0.5.0 --depth 1 https://github.com/klaussilveira/gitlist.git .

# Copy initialization scripts
COPY entrypoint.sh /entrypoint.sh
COPY db_init.sh /app/db_init.sh
COPY init_db.sql /app/init_db.sql
RUN chmod +x /entrypoint.sh /app/db_init.sh

EXPOSE 9000

ENTRYPOINT ["/entrypoint.sh"]