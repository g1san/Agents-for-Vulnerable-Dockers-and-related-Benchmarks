#!/bin/sh
set -e

# Export password for pg_isready and psql commands
export PGPASSWORD="${DB_PASSWORD:-demopass}"

host="${DB_HOST:-db}"
port="${DB_PORT:-5432}"
user="${DB_USER:-demo}"
# Wait for the PostgreSQL server to accept connections (no specific DB needed)
until pg_isready -h "$host" -p "$port" -U "$user" >/dev/null 2>&1; do
  echo "Waiting for PostgreSQL at $host:$port..."
  sleep 2
done

echo "PostgreSQL is up - executing migrations"
python manage.py migrate --noinput

echo "Starting Django server"
exec python manage.py runserver 0.0.0.0:8000