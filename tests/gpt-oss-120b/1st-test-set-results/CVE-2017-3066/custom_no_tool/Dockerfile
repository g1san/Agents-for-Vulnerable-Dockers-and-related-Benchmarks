FROM httpd:2.4

# Switch to root to install packages and generate certificates
USER root

# Install OpenSSL (mod_ssl is already included in the Debian-based httpd image)
RUN apt-get update && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

# Generate a self‑signed certificate (vulnerable mod_ssl will use this)
RUN openssl req -newkey rsa:2048 -nodes \
    -keyout /usr/local/apache2/conf/server.key \
    -x509 -days 365 \
    -out /usr/local/apache2/conf/server.crt \
    -subj "/C=US/ST=State/L=City/O=Org/OU=Dept/CN=localhost" && \
    chmod 600 /usr/local/apache2/conf/server.key && \
    chmod 644 /usr/local/apache2/conf/server.crt && \
    chown daemon:daemon /usr/local/apache2/conf/server.key /usr/local/apache2/conf/server.crt

# Ensure log directory is writable by the daemon user
RUN mkdir -p /usr/local/apache2/logs && chown -R daemon:daemon /usr/local/apache2/logs

# Expose HTTP and HTTPS ports
EXPOSE 80 443

# Copy custom configuration and web content
COPY httpd.conf /usr/local/apache2/conf/httpd.conf
COPY htdocs/ /usr/local/apache2/htdocs/

# Drop back to the non‑root daemon user for runtime
USER daemon