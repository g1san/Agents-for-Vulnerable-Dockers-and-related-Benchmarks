FROM debian:bullseye-slim

ENV DEBIAN_FRONTEND=noninteractive

# Install required packages and runtime dependencies for Gogs
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        tzdata \
        git \
        openssh-client \
        wget \
        curl \
        ffmpeg \
        libsqlite3-0 \
        libssl1.1 \
        unzip && \
    rm -rf /var/lib/apt/lists/*

# Create gogs user and application directory
RUN adduser --disabled-password --gecos "" gogs && \
    mkdir -p /app/gogs && \
    chown -R gogs:gogs /app/gogs

# Download and extract Gogs binary (v0.11.0) – zip archive
ENV GOGS_VERSION=0.11.0
ENV GOGS_URL=https://github.com/gogs/gogs/releases/download/v${GOGS_VERSION}/gogs_${GOGS_VERSION}_linux_amd64.zip
RUN curl -L -o /tmp/gogs.zip "$GOGS_URL" && \
    unzip /tmp/gogs.zip -d /app/gogs && \
    mv /app/gogs/gogs_${GOGS_VERSION}_linux_amd64/* /app/gogs/ && \
    rmdir /app/gogs/gogs_${GOGS_VERSION}_linux_amd64 && \
    rm /tmp/gogs.zip && \
    chmod +x /app/gogs/gogs && \
    chown -R gogs:gogs /app/gogs

# Expose ports (web UI and SSH)
EXPOSE 3000 22

# Set working directory
WORKDIR /app/gogs

# Run as the gogs user
USER gogs

# Entrypoint – start Gogs web server
ENTRYPOINT ["./gogs", "web"]