FROM alpine:3.20 AS builder

# Install build dependencies (compiler, make, headers, and dev libraries required by GoAhead)
RUN apk add --no-cache \
    build-base \
    wget \
    ca-certificates \
    pcre-dev \
    openssl-dev \
    zlib-dev \
    linux-headers

WORKDIR /src

# Download source, extract, build GoAhead (follow redirects)
RUN wget -qO- "https://downloads.sourceforge.net/project/goahead/goahead-3.5.tar.gz" | \
    tar xz && \
    cd goahead-3.5 && \
    make && \
    chmod +x goahead && \
    cp goahead /src/goahead

# Runtime stage â€“ minimal image with required shared libraries
FROM alpine:3.20

# Install runtime libraries needed by the dynamically linked GoAhead binary
RUN apk add --no-cache \
    pcre \
    openssl \
    zlib \
    libstdc++

# Copy compiled binary
COPY --from=builder /src/goahead /usr/local/bin/goahead

# Copy configuration (goahead.conf resides next to this Dockerfile)
COPY goahead.conf /etc/goahead.conf

# Ensure CGI directory exists (the configuration expects this path)
RUN mkdir -p /var/www/cgi-bin

EXPOSE 80

CMD ["goahead", "-c", "/etc/goahead.conf"]