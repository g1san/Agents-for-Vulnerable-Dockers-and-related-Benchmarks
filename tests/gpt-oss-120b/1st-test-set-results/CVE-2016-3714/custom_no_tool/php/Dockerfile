FROM php:7.4-apache
# Add an old Debian repository that contains the vulnerable ImageMagick version
RUN echo "deb http://deb.debian.org/debian stretch main" > /etc/apt/sources.list.d/stretch.list && \
    apt-get update && \
    # Install the specific vulnerable ImageMagick version and matching dev headers
    apt-get install -y --no-install-recommends \
        imagemagick=6.9.3-0 \
        libmagickwand-6.q16-dev=6.9.3-0 \
        libmagickcore-dev=6.9.3-0 \
        build-essential \
        pkg-config && \
    # Build and enable the imagick PECL extension against the pinned ImageMagick
    pecl install imagick && \
    docker-php-ext-enable imagick && \
    rm -rf /var/lib/apt/lists/*
COPY ./index.php /var/www/html/index.php
