FROM node:14-bullseye
WORKDIR /usr/src/app
# Add an old Debian repository that still provides the vulnerable ImageMagick versions
RUN echo "deb http://deb.debian.org/debian stretch main" > /etc/apt/sources.list.d/stretch.list && \
    apt-get update && \
    # Pin ImageMagick to a vulnerable version from the allowed list (e.g., 6.9.3-0)
    apt-get install -y --no-install-recommends imagemagick=6.9.3-0 && \
    rm -rf /var/lib/apt/lists/*
COPY package.json .
RUN npm install
COPY . .
EXPOSE 8080
CMD ["node", "server.js"]
