import docker, sys, time

# Correct socket path with three slashes
client = docker.DockerClient(base_url='unix:///var/run/docker.sock')

def wait_for_socket(retries=10, delay=3):
    for _ in range(retries):
        try:
            client.ping()
            return True
        except Exception:
            time.sleep(delay)
    return False

def create_test_container():
    if not wait_for_socket():
        print('Docker socket not reachable', file=sys.stderr)
        return
    try:
        client.images.pull('alpine:latest')
    except Exception as e:
        print(f"Error pulling image: {e}")
    container = client.containers.run(
        'alpine:latest',
        command=['sh', '-c', 'echo vulnerable > /tmp/vuln.txt && cat /tmp/vuln.txt'],
        detach=True,
        remove=False
    )
    # Stream logs while container is running
    for line in container.logs(stream=True):
        sys.stdout.buffer.write(line)
    # Ensure container is removed after logs are consumed
    container.remove(force=True)

if __name__ == '__main__':
    print('Attempting to exploit Docker socket...')
    create_test_container()
    print('Exploit completed.')