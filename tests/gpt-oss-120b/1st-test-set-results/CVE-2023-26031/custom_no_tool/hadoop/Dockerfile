FROM openjdk:8-jdk
ARG HADOOP_VERSION=3.3.1
ENV HADOOP_HOME=/opt/hadoop
ENV HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
ENV PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin

# Install utilities needed for download and extraction, plus ssh client required by Hadoop scripts.
RUN apt-get update && apt-get install -y --no-install-recommends \
        wget bash openssh-client rsync tar gzip ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Download and extract Hadoop
RUN wget -q https://downloads.apache.org/hadoop/common/hadoop-${HADOOP_VERSION}/hadoop-${HADOOP_VERSION}.tar.gz \
    && tar -xzf hadoop-${HADOOP_VERSION}.tar.gz -C /opt \
    && mv /opt/hadoop-${HADOOP_VERSION} $HADOOP_HOME \
    && rm hadoop-${HADOOP_VERSION}.tar.gz

# Copy minimal configuration files
COPY core-site.xml $HADOOP_CONF_DIR/
COPY hdfs-site.xml $HADOOP_CONF_DIR/
COPY yarn-site.xml $HADOOP_CONF_DIR/
COPY mapred-site.xml $HADOOP_CONF_DIR/

# Ensure container-executor is present and setuid root (simulated for exploit)
RUN chmod u+s $HADOOP_HOME/sbin/container-executor || true

EXPOSE 8088 8042 50070

COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["yarn", "nodemanager"]