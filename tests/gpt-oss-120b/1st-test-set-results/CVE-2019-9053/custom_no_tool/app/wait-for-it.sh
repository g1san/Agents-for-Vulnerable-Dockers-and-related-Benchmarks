#!/usr/bin/env bash
#   Use this script to test if a given TCP host/port are available
#   The script loops until the host/port is reachable (or timeout). Adapted from https://github.com/vishnubob/wait-for-it
set -e

HOST=
PORT=
TIMEOUT=15

usage() {
  echo "Usage: $0 host:port [-- command args...]" 1>&2
  exit 1
}

while [[ "$#" -gt 0 ]]; do
  case "$1" in
    *:* )
      HOST=$(printf "%s" "$1" | cut -d: -f1)
      PORT=$(printf "%s" "$1" | cut -d: -f2)
      shift
      ;;
    -- )
      shift
      break
      ;;
    * )
      usage
      ;;
  esac
done

cmd=""
if [[ "$#" -gt 0 ]]; then
  cmd="$@"
fi

for i in `seq $TIMEOUT` ; do
  nc -z $HOST $PORT >/dev/null 2>&1 && break
  echo "Waiting for $HOST:$PORT... ($i/$TIMEOUT)"
  sleep 1
done

if [[ $i -eq $TIMEOUT ]]; then
  echo "Timeout waiting for $HOST:$PORT"
  exit 1
fi

if [[ -n "$cmd" ]]; then
  exec $cmd
fi