services:
  druid:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: druid
    ports:
      - "8081:8081"   # Coordinator (exposes /druid/indexer/v1/sampler)
      - "8082:8082"   # Overlord
      - "8083:8083"   # Historical
      - "8080:8080"   # Broker
      - "8888:8888"   # Router
    environment:
      - DRUID_HOST=0.0.0.0
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f -s http://localhost:8081/druid/indexer/v1/sampler || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  curl:
    image: curlimages/curl:7.88.1
    container_name: curl
    depends_on:
      druid:
        condition: service_healthy
    entrypoint: ["sh", "-c", "until [ \"$(curl -s -o /dev/null -w '%{http_code}' http://druid:8081/druid/indexer/v1/sampler)\" -eq 200 ]; do echo 'Waiting for Druid sampler endpoint...'; sleep 5; done; echo 'Druid sampler is ready'; tail -f /dev/null"]
    restart: unless-stopped