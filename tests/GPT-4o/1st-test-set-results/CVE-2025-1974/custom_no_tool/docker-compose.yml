version: '3.7'
services:
  ingress-nginx-controller:
    image: k8s.gcr.io/ingress-nginx/controller:v1.11.5
    ports:
      - "80:80"
      - "443:443"
    environment:
      - KUBERNETES_MASTER=http://kube-apiserver:6443
    volumes:
      - ./kubeconfig:/etc/kubernetes/kubeconfig
    command: ["/nginx-ingress-controller", "--kubeconfig=/etc/kubernetes/kubeconfig", "--default-backend-service=default/http-svc", "--configmap=default/nginx-ingress-controller", "--ingress-class=nginx", "--validating-webhook=false", "--watch-ingress-without-class=true"]
    networks:
      - k8s-net

  kube-apiserver:
    image: k8s.gcr.io/kube-apiserver:v1.24.0
    networks:
      - k8s-net
    ports:
      - "6443:6443"

  etcd:
    image: k8s.gcr.io/etcd:v3.5.0
    networks:
      - k8s-net
    volumes:
      - etcd-data:/var/lib/etcd
    command: ["etcd", "--advertise-client-urls=http://0.0.0.0:2379", "--listen-client-urls=http://0.0.0.0:2379"]
    ports:
      - "2379:2379"

  kube-controller-manager:
    image: k8s.gcr.io/kube-controller-manager:v1.24.0
    networks:
      - k8s-net

  kube-scheduler:
    image: k8s.gcr.io/kube-scheduler:v1.24.0
    networks:
      - k8s-net

networks:
  k8s-net:
    driver: bridge

volumes:
  etcd-data:
    driver: local
