#!/usr/bin/env bash
#   Use this script to test if a given TCP host/port are available

TIMEOUT=15

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      echo "Usage: wait-for-it.sh host:port [-t timeout] [-- command args]"
      exit 0
      ;;
    -t)
      TIMEOUT="$2"
      shift 2
      ;;
    --)
      shift
      CMD=("$@")
      break
      ;;
    *)
      HOSTPORT=(${1//:/ })
      HOST=${HOSTPORT[0]}
      PORT=${HOSTPORT[1]}
      shift
      ;;
  esac
  shift

done

if [ -z "$HOST" ] || [ -z "$PORT" ]; then
  echo "Error: you need to provide a host and port to test."
  exit 1
fi

for i in $(seq $TIMEOUT); do
  nc -z "$HOST" "$PORT" > /dev/null 2>&1
  result=$?
  if [ $result -eq 0 ]; then
    if [ -n "$CMD" ]; then
      exec "${CMD[@]}"
    fi
    exit 0
  fi
  sleep 1
done

exit 1
