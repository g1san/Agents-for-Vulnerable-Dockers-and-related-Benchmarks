FROM ubuntu:16.04

# Set non-interactive mode for APT
ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    openssh-server \
    ca-certificates \
    postfix \
    git \
    build-essential \
    libssl-dev \
    libreadline-dev \
    zlib1g-dev \
    libyaml-dev \
    libxml2-dev \
    libxslt1-dev \
    libcurl4-openssl-dev \
    libffi-dev \
    libicu-dev \
    logrotate \
    python-docutils \
    cmake \
    pkg-config \
    ruby-full \
    ruby-dev

# Install Bundler
RUN gem install bundler -v 1.17.3

# Download GitLab source code using shallow clone
RUN git clone --depth 1 --branch v8.13.2 https://gitlab.com/gitlab-org/gitlab-ce.git /home/git/gitlab

# Set up GitLab
WORKDIR /home/git/gitlab
RUN cp config/gitlab.yml.example config/gitlab.yml && \
    cp config/unicorn.rb.example config/unicorn.rb && \
    cp config/database.yml.postgresql config/database.yml && \
    # Create a default redis.yml if it doesn't exist
    [ ! -f config/redis.yml.example ] && echo "production:\n  url: redis://redis:6379" > config/redis.yml.example; \
    cp config/redis.yml.example config/redis.yml && \
    bundle install --deployment --without development test mysql aws kerberos

# Expose ports
EXPOSE 80 443 22

# Start GitLab
CMD ["/home/git/gitlab/bin/rake", "gitlab:setup", "RAILS_ENV=production"]
