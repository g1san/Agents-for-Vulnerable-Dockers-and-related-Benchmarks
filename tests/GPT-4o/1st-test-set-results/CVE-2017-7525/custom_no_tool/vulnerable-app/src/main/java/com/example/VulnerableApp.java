package com.example;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.databind.jsontype.BasicPolymorphicTypeValidator;
import com.fasterxml.jackson.databind.jsontype.PolymorphicTypeValidator;
import com.fasterxml.jackson.databind.ObjectMapper.DefaultTyping;
import spark.Spark;

public class VulnerableApp {
    public static void main(String[] args) {
        ObjectMapper objectMapper = new ObjectMapper();
        PolymorphicTypeValidator ptv = BasicPolymorphicTypeValidator.builder()
            .allowIfBaseType(Object.class)
            .build();
        objectMapper.activateDefaultTyping(ptv, DefaultTyping.NON_FINAL, ObjectMapper.As.WRAPPER_ARRAY);

        Spark.port(8080);

        Spark.post("/deserialize", (req, res) -> {
            String json = req.body();
            try {
                Object obj = objectMapper.readValue(json, Object.class);
                return "Deserialized: " + obj.toString();
            } catch (Exception e) {
                res.status(500);
                return "Deserialization error: " + e.getMessage();
            }
        });
    }
}
