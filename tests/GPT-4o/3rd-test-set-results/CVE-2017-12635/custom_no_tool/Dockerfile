FROM erlang:20

# Configure the old Debian repository
RUN echo 'deb http://archive.debian.org/debian buster main' > /etc/apt/sources.list && \
    echo 'deb-src http://archive.debian.org/debian buster main' >> /etc/apt/sources.list && \
    echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until

# Install dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libicu-dev \
    libcurl4-openssl-dev \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Manually download and install libmozjs185-dev from an alternative source
RUN wget https://snapshot.debian.org/archive/debian/20170707T000000Z/pool/main/libm/libmozjs185/libmozjs185-dev_1.8.5-1.0.0+dfsg-4_amd64.deb && \
    dpkg -i libmozjs185-dev_1.8.5-1.0.0+dfsg-4_amd64.deb && \
    rm libmozjs185-dev_1.8.5-1.0.0+dfsg-4_amd64.deb

# Download and build CouchDB 1.7.0
RUN curl -L https://archive.apache.org/dist/couchdb/source/1.7.0/apache-couchdb-1.7.0.tar.gz | tar xz && \
    cd apache-couchdb-1.7.0 && \
    ./configure && \
    make && \
    make install

# Setup CouchDB
RUN adduser --disabled-password --gecos '' couchdb && \
    chown -R couchdb:couchdb /usr/local/var/lib/couchdb /usr/local/var/log/couchdb /usr/local/var/run/couchdb

COPY init-user-db.sh /init-user-db.sh
RUN chmod +x /init-user-db.sh

USER couchdb

CMD ["couchdb"]
