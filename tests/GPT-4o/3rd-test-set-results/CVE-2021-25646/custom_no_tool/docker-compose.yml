version: '3.8'

services:
  druid:
    image: apache/druid:0.20.0
    ports:
      - "8888:8888"
      - "8081:8081"
    environment:
      - DRUID_XMX=512m
      - DRUID_XMS=512m
    user: druid
    command: /bin/sh -c "su druid -c '/usr/bin/supervisord -c /etc/supervisord.conf'"
    depends_on:
      - mysql
      - zookeeper
    volumes:
      - druid-config:/opt/druid/conf
      - runtime-properties:/runtime.properties

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: druid
      MYSQL_USER: druid
      MYSQL_PASSWORD: druidpassword
    ports:
      - "3306:3306"
    volumes:
      - druid-mysql-data:/var/lib/mysql
    healthcheck:
      test: "exit 0"

  zookeeper:
    image: zookeeper:3.6.2
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888

volumes:
  druid-mysql-data:
    driver: local
  druid-config:
    driver: local
  runtime-properties:
    driver: local
