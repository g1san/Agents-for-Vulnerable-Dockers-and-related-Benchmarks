# Start from a base image that includes necessary tools
FROM kartoza/geoserver:2.20.0

# Switch to root to perform system updates
USER root

# Ensure the geoserver user exists
RUN id -u geoserver &>/dev/null || useradd -m geoserver

# Remove existing JAI-EXT library if it exists
RUN rm -f /usr/local/tomcat/webapps/geoserver/WEB-INF/lib/jaiext-*.jar

# Copy the JAI-EXT library from the local context
COPY jaiext-1.1.21.jar /usr/local/tomcat/webapps/geoserver/WEB-INF/lib/jaiext.jar

# Set permissions for geoserver user
RUN chown -R geoserver:geoserver /usr/local/tomcat/webapps/geoserver

# Revert back to the default user
USER geoserver
