version: '3.8'
services:
  ingress-nginx:
    image: k8s.gcr.io/ingress-nginx/controller:v1.11.5
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ENABLE_VALIDATING_WEBHOOK=false
      - KUBECONFIG=/etc/kubernetes/kubeconfig
      - KUBERNETES_MASTER=https://kube-apiserver:6443
    networks:
      - k8s-network
    volumes:
      - ./kubeconfig:/etc/kubernetes/kubeconfig

  kube-apiserver:
    image: k8s.gcr.io/kube-apiserver:v1.23.0
    networks:
      - k8s-network
    ports:
      - "6443:6443"

  etcd:
    image: k8s.gcr.io/etcd:3.5.3-0
    networks:
      - k8s-network
    command: ["/usr/local/bin/etcd", "--advertise-client-urls=http://etcd:2379", "--listen-client-urls=http://0.0.0.0:2379"]

  coredns:
    image: k8s.gcr.io/coredns/coredns:v1.8.6
    networks:
      - k8s-network
    command: ["-conf", "/etc/coredns/Corefile"]
    volumes:
      - ./coredns/Corefile:/etc/coredns/Corefile

  kube-proxy:
    image: k8s.gcr.io/kube-proxy:v1.23.0
    networks:
      - k8s-network
    command: ["/usr/local/bin/kube-proxy", "--config=/var/lib/kube-proxy/config.conf"]

networks:
  k8s-network:
    driver: bridge
