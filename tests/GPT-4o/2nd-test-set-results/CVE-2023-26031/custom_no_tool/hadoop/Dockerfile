FROM ubuntu:20.04

RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    openjdk-8-jdk \
    wget \
    openssh-client \
    openssh-server \
    && apt-get clean;

# Create a 'hadoop' user and group with a home directory
RUN groupadd -r hadoop && useradd -r -g hadoop -m hadoop

# Set up SSH for the 'hadoop' user
RUN mkdir /home/hadoop/.ssh \
    && (test -f /etc/ssh/ssh_host_rsa_key || ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N '') \
    && (test -f /etc/ssh/ssh_host_dsa_key || ssh-keygen -t dsa -f /etc/ssh/ssh_host_dsa_key -N '') \
    && ssh-keygen -t rsa -b 4096 -f /home/hadoop/.ssh/id_rsa -N '' \
    && cp /home/hadoop/.ssh/id_rsa.pub /home/hadoop/.ssh/authorized_keys \
    && chown -R hadoop:hadoop /home/hadoop/.ssh \
    && chmod 700 /home/hadoop/.ssh \
    && chmod 600 /home/hadoop/.ssh/authorized_keys

# Install Hadoop
RUN wget https://downloads.apache.org/hadoop/common/hadoop-3.3.5/hadoop-3.3.5.tar.gz \
    && tar -xzvf hadoop-3.3.5.tar.gz \
    && mv hadoop-3.3.5 /hadoop \
    && rm hadoop-3.3.5.tar.gz

# Configure Hadoop environment
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
ENV PATH=$PATH:/hadoop/bin:/hadoop/sbin

# Copy configuration files
COPY core-site.xml /hadoop/etc/hadoop/core-site.xml
COPY yarn-site.xml /hadoop/etc/hadoop/yarn-site.xml
COPY hdfs-site.xml /hadoop/etc/hadoop/hdfs-site.xml

# Set up Hadoop directories
RUN mkdir -p /hadoop_data/hdfs/namenode \
    && mkdir -p /hadoop_data/hdfs/datanode \
    && mkdir -p /hadoop/logs \
    && chown -R hadoop:hadoop /hadoop_data /hadoop/logs /hadoop

# Format HDFS
USER hadoop
RUN /hadoop/bin/hdfs namenode -format

# Expose ports
EXPOSE 9870 8088
