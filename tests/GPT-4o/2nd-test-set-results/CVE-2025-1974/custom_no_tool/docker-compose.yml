version: '3.7'
services:
  ingress-nginx-controller:
    image: k8s.gcr.io/ingress-nginx/controller:v1.12.1
    ports:
      - "80:80"
      - "443:443"
    environment:
      - KUBERNETES_SERVICE_HOST=kube-apiserver
      - KUBERNETES_SERVICE_PORT=6443
      - KUBECONFIG=/etc/kubernetes/kubeconfig
    networks:
      - k8s-net
    depends_on:
      - kube-apiserver
    volumes:
      - ./kubeconfig:/etc/kubernetes/kubeconfig:ro
    command: ["/nginx-ingress-controller", "--kubeconfig=/etc/kubernetes/kubeconfig"]

  kube-apiserver:
    image: k8s.gcr.io/kube-apiserver:v1.20.0
    networks:
      - k8s-net
    command:
      - "--secure-port=6443"
      - "--allow-privileged=true"

  kube-controller-manager:
    image: k8s.gcr.io/kube-controller-manager:v1.20.0
    networks:
      - k8s-net

  kube-scheduler:
    image: k8s.gcr.io/kube-scheduler:v1.20.0
    networks:
      - k8s-net

  etcd:
    build:
      context: ./etcd
    networks:
      - k8s-net
    volumes:
      - etcd-data:/var/lib/etcd

  coredns:
    image: k8s.gcr.io/coredns:1.7.0
    networks:
      - k8s-net

  pause:
    image: k8s.gcr.io/pause:3.2
    networks:
      - k8s-net

volumes:
  etcd-data:

networks:
  k8s-net:
    driver: bridge
