FROM ubuntu:18.04

RUN apt-get update && \
    apt-get install -y \
    build-essential \
    libssl-dev \
    zlib1g-dev \
    libcurl4-gnutls-dev \
    libexpat1-dev \
    gettext \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Git version 2.12.2
RUN cd /usr/src && \
    wget https://www.kernel.org/pub/software/scm/git/git-2.12.2.tar.gz && \
    tar xzf git-2.12.2.tar.gz && \
    cd git-2.12.2 && \
    make prefix=/usr/local all && \
    make prefix=/usr/local install && \
    cd .. && \
    rm -rf git-2.12.2 git-2.12.2.tar.gz

RUN apt-get update && \
    apt-get install -y openssh-server && \
    mkdir /var/run/sshd && \
    useradd -m -s /usr/bin/git-shell gituser && \
    mkdir -p /home/gituser/.ssh && \
    chown -R gituser:gituser /home/gituser/.ssh

COPY git-shell-commands /home/gituser/git-shell-commands

RUN chown -R gituser:gituser /home/gituser/git-shell-commands && \
    chmod +x /home/gituser/git-shell-commands/no-interactive-login

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
