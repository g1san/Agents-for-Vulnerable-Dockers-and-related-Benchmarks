# Use a multi-stage build to create a new image using a newer base
FROM gitlab/gitlab-ce:8.13.2-ce.0 AS base

# Stage to copy and rebuild the image
FROM ubuntu:20.04

# Set environment variable to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install necessary packages
RUN apt-get update && \
    apt-get install -y curl openssh-server ca-certificates tzdata perl && \
    curl -sL https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash && \
    apt-get install -y gitlab-ce=8.13.2-ce.0

# Copy configuration files
COPY config/gitlab.rb /etc/gitlab/gitlab.rb
COPY config/database.yml /var/opt/gitlab/gitlab-rails/etc/database.yml

# Expose necessary ports
EXPOSE 80 443 2222

CMD ["/assets/wrapper"]
