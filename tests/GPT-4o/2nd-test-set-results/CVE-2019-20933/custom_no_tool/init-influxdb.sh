#!/bin/bash

set -e

INFLUXDB_INIT_PORT="8086"
INFLUXDB_INIT_HOST="http://localhost:$INFLUXDB_INIT_PORT"

# Wait for InfluxDB to start
until curl -s $INFLUXDB_INIT_HOST/ping
 do
   echo "Waiting for InfluxDB to be up..."
   sleep 2
 done

# Create a test database and insert test data
curl -i -XPOST "$INFLUXDB_INIT_HOST/query" --data-urlencode "q=CREATE DATABASE mydb"
curl -i -XPOST "$INFLUXDB_INIT_HOST/query" --data-urlencode "q=CREATE USER admin WITH PASSWORD 'admin' WITH ALL PRIVILEGES"
curl -i -XPOST "$INFLUXDB_INIT_HOST/query?db=mydb" --data-urlencode "q=INSERT cpu,host=serverA,region=us_west value=0.64"
curl -i -XPOST "$INFLUXDB_INIT_HOST/query?db=mydb" --data-urlencode "q=INSERT cpu,host=serverB,region=us_east value=0.82"