#!/bin/bash
set -e

# Wait for MySQL to be fully ready
echo "Waiting for MySQL to be ready..."
until mysql -h "$DB_HOST" -u root -pinsecure_root_pass -e "SELECT 1" &> /dev/null; do
  sleep 2
done

# Verify Cacti user permissions
echo "Verifying database permissions..."
if ! mysql -h "$DB_HOST" -u cactiuser -pcactipass -e "USE cacti; SELECT 1 FROM user_auth LIMIT 1" &> /dev/null; then
  echo "Initializing Cacti database..."
  mysql -h "$DB_HOST" -u root -pinsecure_root_pass cacti < /tmp/cacti.sql
  mysql -h "$DB_HOST" -u root -pinsecure_root_pass -e "GRANT ALL PRIVILEGES ON cacti.* TO 'cactiuser'@'%'"
  mysql -h "$DB_HOST" -u root -pinsecure_root_pass -e "FLUSH PRIVILEGES"
fi

# Fix file permissions
chown -R www-data:www-data /var/www/html/log /var/www/html/rra

exec "$@"