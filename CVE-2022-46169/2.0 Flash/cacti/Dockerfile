FROM php:7.4-apache

# Install necessary system dependencies, including libgmp-dev
RUN apt-get update && apt-get install -y --no-install-recommends \
    libsnmp-dev \
    snmp \
    libmariadb-dev \
    mariadb-client \
    libnet-snmp-perl \
    rrdtool \
    make \
    gcc \
    wget \
    unzip \
    cron \
    vim \
    iputils-ping \
    libgmp-dev

# Install PHP extensions
RUN docker-php-ext-install mysqli snmp sockets bcmath gmp

# Enable Apache rewrite module
RUN a2enmod rewrite

# Set working directory
WORKDIR /var/www/html

# Download vulnerable Cacti version (1.2.22)
RUN wget https://www.cacti.net/downloads/cacti-1.2.22.tar.gz && \
    tar xzf cacti-1.2.22.tar.gz && \
    mv cacti-1.2.22/* . && \
    rm -rf cacti-1.2.22 cacti-1.2.22.tar.gz

# Set correct permissions for Cacti directories
RUN chown -R www-data:www-data /var/www/html/rra /var/www/html/log /var/www/html/cache

# Copy initial configuration (optional)
COPY config.ini /var/www/html/include/config.ini

# Set permissions for config.php if it exists (might not at this stage)
RUN if [ -f /var/www/html/include/config.php ]; then chown www-data:www-data /var/www/html/include/config.php; fi

# Set up cron for poller (adjust as needed)
RUN echo "* * * * * www-data php /var/www/html/poller.php" > /etc/cron.d/cacti
RUN chmod 0644 /etc/cron.d/cacti
RUN service cron start

# Expose port 80
EXPOSE 80

# Start Apache in the foreground
CMD ["apache2-foreground"]