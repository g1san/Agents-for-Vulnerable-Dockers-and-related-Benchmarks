FROM php:7.4-apache

# Install dependencies
RUN apt-get update && apt-get install -y \
    libapache2-mod-php \
    libmysqlclient-dev \
    mariadb-client \
    snmp \
    snmpd \
    libsnmp-dev \
    rrdtool \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Enable required PHP extensions
RUN docker-php-ext-install mysqli pdo pdo_mysql sockets

# Download and extract Cacti 1.2.22
RUN curl -L https://github.com/Cacti/cacti/archive/refs/tags/release/1.2.22.tar.gz -o cacti.tar.gz \
    && tar -xzf cacti.tar.gz -C /var/www/html \
    && mv /var/www/html/cacti-release-1.2.22 /var/www/html/cacti \
    && rm cacti.tar.gz

# Set permissions
RUN chown -R www-data:www-data /var/www/html/cacti \
    && chmod -R 755 /var/www/html/cacti

# Enable Apache rewrite module
RUN a2enmod rewrite

# Copy Apache configuration
RUN echo "<Directory /var/www/html/cacti>\n\
    Options Indexes FollowSymLinks\n\
    AllowOverride All\n\
    Require all granted\n\
</Directory>" > /etc/apache2/conf-available/cacti.conf \
    && a2enconf cacti

# Expose port
EXPOSE 80

CMD ["apache2-foreground"]