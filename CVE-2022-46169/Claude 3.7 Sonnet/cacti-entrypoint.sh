#!/bin/bash
set -e

# Start cron
service cron start

# Wait for MySQL to be ready
echo "Waiting for MySQL to start up..."
until mysql -h db -u cacti -pcacti -e "SELECT 1"; do
  sleep 1
done

# Initialize Cacti database if needed
if ! mysql -h db -u cacti -pcacti cacti -e "SHOW TABLES" | grep -q 'poller'; then
  echo "Initializing Cacti database..."
  mysql -h db -u cacti -pcacti cacti < /var/www/html/cacti.sql
  
  # Create data sources and poller for vulnerability demonstration
  mysql -h db -u cacti -pcacti cacti << EOF
  INSERT IGNORE INTO poller (id, name, hostname, dbdefault, dbuser, dbpass, dbport, dbssl, total_time, max_time, min_time, avg_time, total_polls, last_update, last_status, status) 
  VALUES (1, 'Main Poller', 'localhost', 'cacti', 'cacti', 'cacti', 3306, 0, 0, 0, 0, 0, 0, '0000-00-00 00:00:00', '0000-00-00 00:00:00', 0);
  
  INSERT IGNORE INTO host (id, poller_id, hostname, description, status, status_event_count, status_fail_date, status_rec_date, status_last_error, min_time, max_time, cur_time, avg_time, polling_time, total_polls, failed_polls, availability) 
  VALUES (1, 1, 'localhost', 'Localhost', 3, 0, '0000-00-00 00:00:00', '0000-00-00 00:00:00', '', 0, 0, 0, 0, 0, 0, 0, 100);
  
  INSERT IGNORE INTO data_local (id, host_id, snmp_query_id, snmp_index) 
  VALUES (1, 1, 0, '');
EOF

  # Set admin password
  mysql -h db -u cacti -pcacti cacti -e "UPDATE user_auth SET password=MD5('admin') WHERE username='admin';"

  # Configure spine settings
  echo "Configuring spine settings..."
  mysql -h db -u cacti -pcacti cacti -e "REPLACE INTO settings (name, value) VALUES ('path_spine', '/usr/local/spine');"
  mysql -h db -u cacti -pcacti cacti -e "REPLACE INTO settings (name, value) VALUES ('path_spine_config', '/etc/spine.conf');"
fi

# Fix file permissions
chown -R www-data:www-data /var/www/html

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground