FROM alpine:3.16

# Install required packages
RUN apk add --no-cache \
    apache2 \
    php8 \
    php8-apache2 \
    php8-mysqli \
    php8-session \
    php8-sockets \
    php8-pdo \
    php8-pdo_mysql \
    php8-gd \
    php8-curl \
    php8-json \
    php8-xml \
    php8-snmp \
    php8-mbstring \
    php8-ldap \
    php8-gd \
    php8-ctype \
    mysql-client \
    rrdtool \
    wget \
    curl \
    tar \
    bash

# Download vulnerable Cacti version
RUN wget -q https://www.cacti.net/downloads/cacti-1.2.22.tar.gz -O /tmp/cacti.tar.gz && \
    mkdir -p /var/www/localhost/htdocs && \
    tar -xzf /tmp/cacti.tar.gz -C /var/www/localhost/htdocs --strip-components=1 && \
    rm /tmp/cacti.tar.gz

# Configure Cacti
RUN mkdir -p /var/www/localhost/htdocs/rra /var/www/localhost/htdocs/log && \
    chown -R apache:apache /var/www/localhost/htdocs

# Create Cacti config file
RUN cat > /var/www/localhost/htdocs/include/config.php << 'EOL'
<?php
$database_type = 'mysql';
$database_default = 'cacti';
$database_hostname = 'db';
$database_username = 'cacti';
$database_password = 'cacti';
$database_port = '3306';
$database_ssl = false;
$url_path = '/';
$cacti_session_name = 'Cacti';
$poller_id = 1;
?>
EOL

# Configure Apache
RUN sed -i 's/#LoadModule rewrite_module/LoadModule rewrite_module/' /etc/apache2/httpd.conf && \
    sed -i 's#/var/www/localhost/htdocs#/var/www/localhost/htdocs#' /etc/apache2/httpd.conf && \
    sed -i 's/AllowOverride None/AllowOverride All/' /etc/apache2/httpd.conf

# Copy and make executable the setup script
COPY setup.sh /setup.sh
RUN chmod +x /setup.sh

# Expose port 80
EXPOSE 80

# Start services
CMD ["/bin/bash", "-c", "/setup.sh && httpd -D FOREGROUND"]