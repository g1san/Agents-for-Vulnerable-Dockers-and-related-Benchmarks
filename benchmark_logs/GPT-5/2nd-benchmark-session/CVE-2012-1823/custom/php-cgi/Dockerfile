FROM debian:bullseye-slim

ENV DEBIAN_FRONTEND=noninteractive \
    PHP_VERSION=5.4.1 \
    PHP_PREFIX=/usr/local/php-5.4.1

# Minimal, reliable build deps for PHP 5.4.1 CGI SAPI on modern Debian
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    ca-certificates curl build-essential autoconf make pkg-config \
    libxml2-dev zlib1g-dev bison re2c \
 && rm -rf /var/lib/apt/lists/*

# Fetch and build PHP CGI with a minimal feature set to avoid legacy deps
RUN mkdir -p /src && cd /src \
 && curl -fsSL https://museum.php.net/php5/php-${PHP_VERSION}.tar.gz -o php-${PHP_VERSION}.tar.gz \
 && tar -xzf php-${PHP_VERSION}.tar.gz \
 && cd php-${PHP_VERSION} \
 && ./buildconf --force || true \
 && ./configure \
      --prefix=${PHP_PREFIX} \
      --enable-cgi \
      --disable-all \
      --with-libxml-dir=/usr \
      --with-zlib \
      --without-pear \
 && make -j"$(nproc)" \
 && make install \
 # Ensure the CGI SAPI is installed to ${PHP_PREFIX}/bin/php-cgi
 && { [ -x "${PHP_PREFIX}/bin/php-cgi" ] || make -C sapi/cgi install; } \
 && { [ -x "${PHP_PREFIX}/bin/php-cgi" ] || { echo "php-cgi not found after build" >&2; exit 1; }; } \
 && mkdir -p ${PHP_PREFIX}/lib \
 && cp -v php.ini-production ${PHP_PREFIX}/lib/php.ini \
 && ln -sf ${PHP_PREFIX}/bin/php-cgi /usr/local/bin/php-cgi \
 && rm -rf /src

# Shared volume target where the php-cgi binary will be exported
RUN mkdir -p /opt/php-cgi

COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]
