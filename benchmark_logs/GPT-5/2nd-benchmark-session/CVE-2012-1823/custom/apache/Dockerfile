FROM httpd:2.4.59

# Ensure modules are loaded exactly once and include our CGI/PHP mapping
RUN set -e; \
    CONF=/usr/local/apache2/conf/httpd.conf; \
    # Remove any existing cgid/actions LoadModule lines, then add ours
    sed -i '/^[#[:space:]]*LoadModule[[:space:]]\+cgid_module[[:space:]]/d' "$CONF"; \
    sed -i '/^[#[:space:]]*LoadModule[[:space:]]\+actions_module[[:space:]]/d' "$CONF"; \
    printf '%s\n' \
      'LoadModule cgid_module modules/mod_cgid.so' \
      'LoadModule actions_module modules/mod_actions.so' \
      '' \
      '# Include CVE-2012-1823 vulnerable CGI-based PHP handler' \
      'Include conf/extra/cve-2012-1823.conf' \
      >> "$CONF"

# Provide our custom config (maps .php to CGI wrapper)
COPY httpd.conf /usr/local/apache2/conf/extra/cve-2012-1823.conf

# Provide CGI wrapper script path
RUN mkdir -p /usr/local/apache2/cgi-bin
COPY cgi-bin/php-cgi /usr/local/apache2/cgi-bin/php-cgi
RUN chmod +x /usr/local/apache2/cgi-bin/php-cgi

# Add a lightweight entrypoint that waits for php-cgi to be present
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]
