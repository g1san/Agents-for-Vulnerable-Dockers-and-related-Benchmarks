FROM httpd:2.4.59

# Enable CGI via mod_cgid and enable mod_actions for the Action directive
RUN sed -ri 's/^#?LoadModule cgid_module/LoadModule cgid_module/' /usr/local/apache2/conf/httpd.conf || true \
 && sed -ri 's/^#?LoadModule actions_module/LoadModule actions_module/' /usr/local/apache2/conf/httpd.conf || echo "LoadModule actions_module modules/mod_actions.so" >> /usr/local/apache2/conf/httpd.conf

# Provide our custom config (maps .php to CGI wrapper)
COPY httpd.conf /usr/local/apache2/conf/extra/cve-2012-1823.conf
RUN echo "\n# Include CVE-2012-1823 vulnerable CGI-based PHP handler\nInclude conf/extra/cve-2012-1823.conf" >> /usr/local/apache2/conf/httpd.conf

# Provide CGI wrapper script path
RUN mkdir -p /usr/local/apache2/cgi-bin
COPY cgi-bin/php-cgi /usr/local/apache2/cgi-bin/php-cgi
RUN chmod +x /usr/local/apache2/cgi-bin/php-cgi
