FROM debian:bullseye-slim

# Build dependencies for compiling PHP 5.3.11 with CGI/FastCGI SAPI
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates wget build-essential autoconf pkg-config \
    libxml2-dev zlib1g-dev \
    libreadline-dev libsqlite3-dev libbz2-dev \
    libjpeg-dev libpng-dev \
    libonig-dev libxslt1.1 libxslt1-dev \
  && rm -rf /var/lib/apt/lists/*

# Fetch and unpack PHP 5.3.11 (vulnerable range)
WORKDIR /usr/src
RUN wget -q https://museum.php.net/php5/php-5.3.11.tar.gz && \
    echo "Downloaded php-5.3.11.tar.gz" && \
    tar xzf php-5.3.11.tar.gz
WORKDIR /usr/src/php-5.3.11

# Configure minimal, enabling CGI/FastCGI, and disable XML-family extensions that
# are incompatible with modern libxml2 on this distro (not needed for the lab)
RUN ./configure \
    --prefix=/usr/local \
    --enable-cgi \
    --enable-fastcgi \
    --disable-dom \
    --disable-simplexml \
    --disable-xml \
    --disable-xmlreader \
    --disable-xmlwriter \
    --with-zlib \
    --with-readline \
    --with-config-file-path=/usr/local/etc \
    --without-pear \
  && make -j"$(nproc)" \
  && make install

# Runtime preparation
RUN mkdir -p /usr/local/etc /var/www/html && \
    useradd -r -s /usr/sbin/nologin php && \
    chown -R php:php /var/www/html

COPY php.ini /usr/local/etc/php.ini
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

USER php
WORKDIR /var/www/html
EXPOSE 9000
VOLUME ["/var/www/html"]

ENTRYPOINT ["/entrypoint.sh"]
