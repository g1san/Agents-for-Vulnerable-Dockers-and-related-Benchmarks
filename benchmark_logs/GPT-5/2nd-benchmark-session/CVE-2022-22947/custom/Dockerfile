FROM eclipse-temurin:17-jre AS builder

# Install build toolchain (Maven) and JDK inside the allowed base image
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       maven \
       openjdk-17-jdk-headless \
       ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Ensure Maven uses the installed JDK (not the base image JRE)
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:${PATH}"

WORKDIR /src
COPY pom.xml .
# Pre-fetch dependencies for faster builds
RUN mvn -q -e -U -DskipTests=true dependency:go-offline

COPY src ./src
RUN mvn -q -DskipTests=true package

FROM eclipse-temurin:17-jre
WORKDIR /app
COPY --from=builder /src/target/gateway-0.0.1-SNAPSHOT.jar /app/app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","/app/app.jar"]
