FROM debian:10-slim

ENV DEBIAN_FRONTEND=noninteractive \
    OSMTPD_VERSION=6.6.1p1 \
    OSMTPD_URL=https://www.opensmtpd.org/archives/opensmtpd-6.6.1p1.tar.gz

# Use Debian Buster archive repositories and disable Valid-Until checks
RUN printf 'deb http://archive.debian.org/debian buster main contrib non-free\n' > /etc/apt/sources.list \
 && printf 'deb http://archive.debian.org/debian buster-updates main contrib non-free\n' >> /etc/apt/sources.list \
 && printf 'deb http://archive.debian.org/debian-security buster/updates main contrib non-free\n' >> /etc/apt/sources.list \
 && printf 'Acquire::Check-Valid-Until "false";\nAcquire::Languages "none";\n' > /etc/apt/apt.conf.d/99no-check-valid-until

# Base packages and full build toolchain for OpenSMTPD portable
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg dirmngr \
    build-essential pkg-config \
    autoconf automake libtool m4 \
    libevent-dev libssl-dev zlib1g-dev \
    libbsd-dev libedit-dev \
    libasr-dev \
    bison flex \
 && rm -rf /var/lib/apt/lists/*

# Create required system users and directories with correct ownership/permissions
# Force _smtpd UID to 997 to satisfy queue backend check; keep queue GID as 0 (root)
RUN groupadd --system _smtpd \
 && useradd --system --no-create-home --uid 997 --gid _smtpd _smtpd \
 && groupadd --system _smtpq \
 && useradd --system --no-create-home --gid _smtpq _smtpq \
 && mkdir -p /var/spool/smtpd/queue /var/spool/smtpd/offline /var/empty /var/run/smtpd \
 && chown root:root /var/spool/smtpd \
 && chmod 711 /var/spool/smtpd \
 && chown -R 997:0 /var/spool/smtpd/queue \
 && chmod 700 /var/spool/smtpd/queue \
 && chown root:_smtpq /var/spool/smtpd/offline \
 && chmod 770 /var/spool/smtpd/offline \
 && chmod 755 /var/empty \
 && chmod 755 /var/run/smtpd

# Build and install OpenSMTPD portable 6.6.1p1 (vulnerable)
WORKDIR /tmp/build
RUN set -eux; \
    curl -fsSL "$OSMTPD_URL" -o opensmtpd.tar.gz; \
    tar xzf opensmtpd.tar.gz; \
    cd OpenSMTPD-portable-* || cd opensmtpd-*; \
    ./bootstrap; \
    ./configure --prefix=/usr/local; \
    make -j"$(nproc)"; \
    make install; \
    ldconfig; \
    test -x /usr/local/sbin/smtpd; \
    strip /usr/local/sbin/smtpd || true; \
    cd /; \
    rm -rf /tmp/build

# Configuration
COPY smtpd.conf /usr/local/etc/smtpd.conf
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 25/tcp

ENTRYPOINT ["/entrypoint.sh"]
