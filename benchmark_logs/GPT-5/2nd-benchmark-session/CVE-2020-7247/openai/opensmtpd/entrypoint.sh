#!/usr/bin/env bash
set -euo pipefail

# Ensure required runtime directories and correct ownership/permissions
mkdir -p /var/spool/smtpd/queue /var/spool/smtpd/offline /var/empty /var/run/smtpd
chown root:root /var/spool/smtpd
chmod 711 /var/spool/smtpd
# Queue must be uid 997 and gid 0 (root)
chown -R 997:0 /var/spool/smtpd/queue
chmod 700 /var/spool/smtpd/queue
chown root:_smtpq /var/spool/smtpd/offline
chmod 770 /var/spool/smtpd/offline
chmod 755 /var/empty
chmod 755 /var/run/smtpd

# Remove stale sockets and pid files; stop any orphaned smtpd from previous crashes
pkill -x smtpd >/dev/null 2>&1 || true
rm -f /var/run/smtpd/* /var/run/smtpd.sock /var/run/smtpd.pid >/dev/null 2>&1 || true

# Show version for verification
/usr/local/sbin/smtpd -v || true

# Run OpenSMTPD in foreground with provided config
exec /usr/local/sbin/smtpd -d -f /usr/local/etc/smtpd.conf
