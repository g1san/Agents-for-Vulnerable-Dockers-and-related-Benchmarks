FROM debian:bullseye-slim

ENV DEBIAN_FRONTEND=noninteractive \
    OPENSMTPD_VERSION=6.6.1p1 \
    OPENSMTPD_URL=https://www.opensmtpd.org/archives/opensmtpd-6.6.1p1.tar.gz \
    LIBASR_VERSION=1.0.4 \
    LIBASR_URL=https://www.opensmtpd.org/archives/libasr-1.0.4.tar.gz

# Build and runtime deps
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       ca-certificates curl build-essential \
       libevent-dev libssl-dev libsqlite3-dev zlib1g-dev \
       bison flex pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Build and install libasr (since libasr-dev is not available on bullseye)
RUN set -eux; \
    mkdir -p /tmp/build && cd /tmp/build; \
    curl -fsSL "$LIBASR_URL" -o libasr.tar.gz; \
    tar -xzf libasr.tar.gz; \
    cd libasr-*; \
    ./configure --prefix=/usr; \
    make -j"$(nproc)"; \
    make install; \
    cd /; rm -rf /tmp/build

# Build and install OpenSMTPD portable 6.6.1p1 (within the vulnerable range)
# Use -fcommon to handle GCC 10+ default (-fno-common) which breaks these sources
RUN set -eux; \
    mkdir -p /tmp/build && cd /tmp/build; \
    curl -fsSL "$OPENSMTPD_URL" -o opensmtpd.tar.gz; \
    tar -xzf opensmtpd.tar.gz; \
    cd opensmtpd-*; \
    CFLAGS="-O2 -fcommon" ./configure --prefix=/usr; \
    make -j"$(nproc)"; \
    make install; \
    cd /; rm -rf /tmp/build

# Create required runtime users and directories for OpenSMTPD subsystems
RUN set -eux; \
    # Users/groups expected by OpenSMTPD
    groupadd -r _smtpd; \
    useradd -r -g _smtpd -d /var/empty -s /usr/sbin/nologin _smtpd; \
    # Create _smtpq with the specific GID 998 required by the offline dir check
    groupadd -r -g 998 _smtpq; \
    useradd -r -g _smtpq -d /var/empty -s /usr/sbin/nologin _smtpq; \
    # Create /var/empty used as home for system users
    mkdir -p /var/empty; \
    chown 0:0 /var/empty; \
    chmod 755 /var/empty; \
    # Spool/chroot tree used by subsystems (ca, control, scheduler, queue, etc.)
    mkdir -p /etc/smtpd /var/spool/smtpd; \
    mkdir -p \
      /var/spool/smtpd/ca \
      /var/spool/smtpd/control \
      /var/spool/smtpd/scheduler \
      /var/spool/smtpd/queue \
      /var/spool/smtpd/incoming \
      /var/spool/smtpd/temporary \
      /var/spool/smtpd/purge \
      /var/spool/smtpd/offline \
      /var/spool/smtpd/corrupt; \
    # Enforce OpenSMTPD expectations: base spool must be root:root with 711
    chown 0:0 /var/spool/smtpd; \
    chmod 711 /var/spool/smtpd; \
    # Subdirectories owned by _smtpd for runtime operations (exclude offline)
    chown -R _smtpd:_smtpd \
      /var/spool/smtpd/ca \
      /var/spool/smtpd/control \
      /var/spool/smtpd/scheduler \
      /var/spool/smtpd/queue \
      /var/spool/smtpd/incoming \
      /var/spool/smtpd/temporary \
      /var/spool/smtpd/purge \
      /var/spool/smtpd/corrupt; \
    chmod 700 \
      /var/spool/smtpd/ca \
      /var/spool/smtpd/control \
      /var/spool/smtpd/scheduler \
      /var/spool/smtpd/queue \
      /var/spool/smtpd/incoming \
      /var/spool/smtpd/temporary \
      /var/spool/smtpd/purge \
      /var/spool/smtpd/corrupt; \
    # Offline directory must be owned by root and group _smtpq (gid 998) with 770
    chown 0:998 /var/spool/smtpd/offline; \
    chmod 770 /var/spool/smtpd/offline

COPY smtpd.conf /etc/smtpd/smtpd.conf

EXPOSE 25
CMD ["/usr/sbin/smtpd", "-d", "-f", "/etc/smtpd/smtpd.conf"]
