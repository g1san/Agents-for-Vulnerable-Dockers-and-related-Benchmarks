{
    "file_name": [
        "./../../dockers/CVE-2020-7247/custom/docker-compose.yml",
        "./../../dockers/CVE-2020-7247/custom/opensmtpd/Dockerfile",
        "./../../dockers/CVE-2020-7247/custom/opensmtpd/smtpd.conf"
    ],
    "file_code": [
        "services:\n  opensmtpd:\n    build: ./opensmtpd\n    image: cve-2020-7247-opensmtpd:6.6\n    ports:\n      - \"25:25\"\n    restart: unless-stopped\n",
        "FROM debian:bullseye-slim\n\nENV DEBIAN_FRONTEND=noninteractive \\\n    OPENSMTPD_VERSION=6.6.1p1 \\\n    OPENSMTPD_URL=https://www.opensmtpd.org/archives/opensmtpd-6.6.1p1.tar.gz \\\n    LIBASR_VERSION=1.0.4 \\\n    LIBASR_URL=https://www.opensmtpd.org/archives/libasr-1.0.4.tar.gz\n\n# Build and runtime deps\nRUN apt-get update \\\n    && apt-get install -y --no-install-recommends \\\n       ca-certificates curl build-essential \\\n       libevent-dev libssl-dev libsqlite3-dev zlib1g-dev \\\n       bison flex pkg-config \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Build and install libasr (since libasr-dev is not available on bullseye)\nRUN set -eux; \\\n    mkdir -p /tmp/build && cd /tmp/build; \\\n    curl -fsSL \"$LIBASR_URL\" -o libasr.tar.gz; \\\n    tar -xzf libasr.tar.gz; \\\n    cd libasr-*; \\\n    ./configure --prefix=/usr; \\\n    make -j\"$(nproc)\"; \\\n    make install; \\\n    cd /; rm -rf /tmp/build\n\n# Build and install OpenSMTPD portable 6.6.1p1 (within the vulnerable range)\n# Use -fcommon to handle GCC 10+ default (-fno-common) which breaks these sources\nRUN set -eux; \\\n    mkdir -p /tmp/build && cd /tmp/build; \\\n    curl -fsSL \"$OPENSMTPD_URL\" -o opensmtpd.tar.gz; \\\n    tar -xzf opensmtpd.tar.gz; \\\n    cd opensmtpd-*; \\\n    CFLAGS=\"-O2 -fcommon\" ./configure --prefix=/usr; \\\n    make -j\"$(nproc)\"; \\\n    make install; \\\n    cd /; rm -rf /tmp/build\n\n# Create required runtime users and directories for OpenSMTPD subsystems\nRUN set -eux; \\\n    # Users/groups expected by OpenSMTPD\n    groupadd -r _smtpd; \\\n    useradd -r -g _smtpd -d /var/empty -s /usr/sbin/nologin _smtpd; \\\n    # Create _smtpq with the specific GID 998 required by the offline dir check\n    groupadd -r -g 998 _smtpq; \\\n    useradd -r -g _smtpq -d /var/empty -s /usr/sbin/nologin _smtpq; \\\n    # Create /var/empty used as home for system users\n    mkdir -p /var/empty; \\\n    chown 0:0 /var/empty; \\\n    chmod 755 /var/empty; \\\n    # Spool/chroot tree used by subsystems (ca, control, scheduler, queue, etc.)\n    mkdir -p /etc/smtpd /var/spool/smtpd; \\\n    mkdir -p \\\n      /var/spool/smtpd/ca \\\n      /var/spool/smtpd/control \\\n      /var/spool/smtpd/scheduler \\\n      /var/spool/smtpd/queue \\\n      /var/spool/smtpd/incoming \\\n      /var/spool/smtpd/temporary \\\n      /var/spool/smtpd/purge \\\n      /var/spool/smtpd/offline \\\n      /var/spool/smtpd/corrupt; \\\n    # Enforce OpenSMTPD expectations: base spool must be root:root with 711\n    chown 0:0 /var/spool/smtpd; \\\n    chmod 711 /var/spool/smtpd; \\\n    # Subdirectories owned by _smtpd for runtime operations (exclude offline)\n    chown -R _smtpd:_smtpd \\\n      /var/spool/smtpd/ca \\\n      /var/spool/smtpd/control \\\n      /var/spool/smtpd/scheduler \\\n      /var/spool/smtpd/queue \\\n      /var/spool/smtpd/incoming \\\n      /var/spool/smtpd/temporary \\\n      /var/spool/smtpd/purge \\\n      /var/spool/smtpd/corrupt; \\\n    chmod 700 \\\n      /var/spool/smtpd/ca \\\n      /var/spool/smtpd/control \\\n      /var/spool/smtpd/scheduler \\\n      /var/spool/smtpd/queue \\\n      /var/spool/smtpd/incoming \\\n      /var/spool/smtpd/temporary \\\n      /var/spool/smtpd/purge \\\n      /var/spool/smtpd/corrupt; \\\n    # Offline directory must be owned by root and group _smtpq (gid 998) with 770\n    chown 0:998 /var/spool/smtpd/offline; \\\n    chmod 770 /var/spool/smtpd/offline\n\nCOPY smtpd.conf /etc/smtpd/smtpd.conf\n\nEXPOSE 25\nCMD [\"/usr/sbin/smtpd\", \"-d\", \"-f\", \"/etc/smtpd/smtpd.conf\"]\n",
        "listen on 0.0.0.0\n\n# Minimal action and match rules to accept SMTP sessions from anywhere\naction \"relay\" relay\nmatch from any for any action \"relay\"\n"
    ],
    "directory_tree": "./../../dockers/CVE-2020-7247/custom\n\u2514\u2500\u2500 opensmtpd\n    \u251c\u2500\u2500 Dockerfile\n    \u2514\u2500\u2500 smtpd.conf\n./../../dockers/CVE-2020-7247/custom/docker-compose.yml"
}