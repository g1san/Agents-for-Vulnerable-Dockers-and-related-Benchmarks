FROM debian:11-slim

ENV DEBIAN_FRONTEND=noninteractive \
    OPENSMTPD_VERSION=6.6.1p1 \
    LIBASR_VERSION=1.0.4

# Build and runtime dependencies
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      ca-certificates curl build-essential \
      libssl-dev libevent-dev zlib1g-dev pkg-config \
      bison flex \
 && rm -rf /var/lib/apt/lists/*

# Create required system users and groups
RUN groupadd -r _smtpd && useradd -r -g _smtpd -d /var/empty -s /usr/sbin/nologin _smtpd \
 && groupadd -r _smtpq && useradd -r -g _smtpq -d /var/empty -s /usr/sbin/nologin _smtpq

# Ensure chroot base exists
RUN mkdir -p /var/empty && chmod 755 /var/empty && chown root:root /var/empty

# Build and install libasr (not available as a Debian package)
RUN set -eux; \
    curl -fsSL -o /tmp/libasr.tar.gz \
      https://www.opensmtpd.org/archives/libasr-${LIBASR_VERSION}.tar.gz; \
    mkdir -p /usr/src/libasr; \
    tar -xzf /tmp/libasr.tar.gz -C /usr/src/libasr --strip-components=1; \
    cd /usr/src/libasr; \
    ./configure; \
    make -j"$(nproc)"; \
    make install; \
    ldconfig; \
    rm -rf /usr/src/libasr /tmp/libasr.tar.gz

# Build OpenSMTPD portable 6.6.1p1
RUN set -eux; \
    curl -fsSL -o /tmp/opensmtpd.tar.gz \
      https://www.opensmtpd.org/archives/opensmtpd-${OPENSMTPD_VERSION}.tar.gz; \
    mkdir -p /usr/src/opensmtpd; \
    tar -xzf /tmp/opensmtpd.tar.gz -C /usr/src/opensmtpd --strip-components=1; \
    cd /usr/src/opensmtpd; \
    CFLAGS="-O2 -pipe -fcommon" ./configure \
      --with-path-queue=/var/spool/smtpd/queue \
      --with-path-run=/var/run/smtpd; \
    make -j"$(nproc)"; \
    make install-strip; \
    rm -rf /usr/src/opensmtpd /tmp/opensmtpd.tar.gz

# Config
COPY smtpd.conf /usr/local/etc/smtpd/smtpd.conf
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 25

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
