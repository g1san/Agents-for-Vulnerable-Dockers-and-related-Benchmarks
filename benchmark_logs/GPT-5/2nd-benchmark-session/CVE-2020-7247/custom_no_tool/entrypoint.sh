#!/bin/sh
set -eu

# Ensure chroot base exists for smtpd subprocesses (ca, control, pony, scheduler)
mkdir -p /var/empty
chmod 755 /var/empty
chown root:root /var/empty

# Ensure spool hierarchy exists
mkdir -p \
  /var/spool/smtpd/queue \
  /var/spool/smtpd/offline \
  /var/spool/smtpd/purge \
  /var/spool/smtpd/corrupt \
  /var/spool/smtpd/incoming \
  /var/spool/smtpd/tmp

# Queue directory must be owned by root and mode 711
chown root:root /var/spool/smtpd/queue
chmod 711 /var/spool/smtpd/queue

# Other spool subdirs owned by _smtpq with restrictive perms
chown -R _smtpq:_smtpq \
  /var/spool/smtpd/offline \
  /var/spool/smtpd/purge \
  /var/spool/smtpd/corrupt \
  /var/spool/smtpd/incoming \
  /var/spool/smtpd/tmp || true
chmod 700 \
  /var/spool/smtpd/offline \
  /var/spool/smtpd/purge \
  /var/spool/smtpd/corrupt \
  /var/spool/smtpd/incoming \
  /var/spool/smtpd/tmp || true

# Runtime directory for control socket
mkdir -p /var/run/smtpd
chown -R _smtpd:_smtpd /var/run/smtpd || true

# Start OpenSMTPD in foreground with provided config
exec /usr/local/sbin/smtpd -d -f /usr/local/etc/smtpd/smtpd.conf
