# Multistage build: build vulnerable php-cgi (5.4.1) and serve with Apache HTTP Server 2.4.59

# Builder stage: compile PHP 5.4.1 CGI SAPI using a modern Debian to avoid snapshot issues
FROM debian:bullseye AS php-builder

ENV DEBIAN_FRONTEND=noninteractive

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
       ca-certificates wget build-essential autoconf pkg-config \
       libxml2-dev bison re2c; \
    rm -rf /var/lib/apt/lists/*

WORKDIR /tmp
RUN set -eux; \
    wget https://museum.php.net/php5/php-5.4.1.tar.gz; \
    echo "Downloading PHP 5.4.1"; \
    tar xzf php-5.4.1.tar.gz; \
    cd php-5.4.1; \
    # Avoid buildconf on release tarball; ensure compatibility with newer GCC
    export CFLAGS="-O2 -fcommon"; \
    ./configure \
      --prefix=/usr/local/php541 \
      --enable-cgi \
      --disable-all \
      --without-pear; \
    make -j"$(nproc)"; \
    make install

# Final stage: Apache HTTP Server 2.4.59 serving .php via CGI using the vulnerable php-cgi
FROM httpd:2.4.59

# Copy php-cgi binary into Apache's cgi-bin
COPY --from=php-builder /usr/local/php541/bin/php-cgi /usr/local/apache2/cgi-bin/php-cgi
RUN chmod +x /usr/local/apache2/cgi-bin/php-cgi

# Provide full Apache configuration enabling CGI and mapping .php to php-cgi
COPY ./httpd.conf /usr/local/apache2/conf/httpd.conf

# Web root with test PHP script
COPY ./htdocs/ /usr/local/apache2/htdocs/

# Expose default HTTP port (80) by base image; no CMD override needed (httpd-foreground)
