FROM httpd:2.4.58

# Build vulnerable php-cgi (PHP 5.3.x vulnerable line)
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      ca-certificates \
      build-essential \
      curl \
      zlib1g-dev \
      libxml2-dev \
 && rm -rf /var/lib/apt/lists/*

ENV PHP_VERSION=5.3.10

RUN curl -fsSL https://museum.php.net/php5/php-${PHP_VERSION}.tar.gz -o /tmp/php.tar.gz \
 && tar -xf /tmp/php.tar.gz -C /tmp \
 && cd /tmp/php-${PHP_VERSION} \
 && ./configure \
      --prefix=/usr/local/php-5.3 \
      --enable-cgi \
      --with-zlib \
      --disable-dom \
      --disable-simplexml \
      --disable-xml \
      --disable-xmlreader \
      --disable-xmlwriter \
      --without-pear \
 && make -j"$(nproc)" \
 && make install \
 && rm -rf /tmp/php* \
 && apt-get purge -y build-essential curl zlib1g-dev libxml2-dev \
 && apt-get autoremove -y \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Apache HTTPD configuration to run php-cgi via CGI/Action
COPY httpd.conf /usr/local/apache2/conf/httpd.conf

# CGI wrapper invoking the vulnerable php-cgi binary
COPY cgi-bin/php-cgi /usr/local/apache2/cgi-bin/php-cgi
RUN chmod +x /usr/local/apache2/cgi-bin/php-cgi

# Sample PHP application
COPY htdocs/ /usr/local/apache2/htdocs/

EXPOSE 80
CMD ["httpd-foreground"]
