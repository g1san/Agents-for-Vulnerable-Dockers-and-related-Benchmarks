#!/bin/bash
set -euo pipefail

# Wait for CouchDB to be reachable on its HTTP port inside the container
until curl -sf http://127.0.0.1:5984/ >/dev/null 2>&1; do
  sleep 1
done
# Small extra delay to ensure full readiness
sleep 2

# Create a sample database and insert a test document using the admin credentials
DB_URL="http://127.0.0.1:5984"
AUTH="${COUCHDB_USER}:${COUCHDB_PASSWORD}"

# Create test database (idempotent)
curl -sf -u "$AUTH" -X PUT "${DB_URL}/testdb" >/dev/null 2>&1 || true

# Insert a sample document
curl -sf -u "$AUTH" -H 'Content-Type: application/json' -X POST \
  "${DB_URL}/testdb" \
  -d '{"_id":"doc1","type":"demo","msg":"hello from CVE-2022-24706 setup"}' >/dev/null 2>&1 || true
