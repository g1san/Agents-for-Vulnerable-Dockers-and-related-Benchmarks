FROM couchdb:3.2.1

USER root

# Utilities for health checks and initialization
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       curl netcat-openbsd ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Insecure, predictable Erlang cookie for reproducibility of CVE-2022-24706
COPY erlang.cookie /opt/couchdb/.erlang.cookie

# Expose HTTP on all interfaces and keep defaults otherwise
COPY local.ini /opt/couchdb/etc/local.d/local.ini

# Initialization scripts
COPY init-db.sh /init-db.sh
COPY custom-entrypoint.sh /custom-entrypoint.sh

RUN chown -R couchdb:couchdb /opt/couchdb \
    && chmod 400 /opt/couchdb/.erlang.cookie \
    && chmod +x /custom-entrypoint.sh /init-db.sh

USER couchdb

# Default ports (Erlang distribution chooses a dynamic high port by default)
EXPOSE 5984 4369

ENTRYPOINT ["/custom-entrypoint.sh"]
