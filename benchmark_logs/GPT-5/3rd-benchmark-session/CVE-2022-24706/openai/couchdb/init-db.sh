#!/bin/sh
set -e

HOST=127.0.0.1
USER=${COUCHDB_USER:-admin}
PASS=${COUCHDB_PASSWORD:-adminpass}

# Wait for CouchDB to be reachable
for i in $(seq 1 60); do
  if curl -fsS http://$HOST:5984/ >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

# If admin party is enabled, use no auth; otherwise use provided creds
AUTH=""
if curl -fsS http://$HOST:5984/_session >/dev/null 2>&1; then
  AUTH="-u ${USER}:${PASS}"
fi

# Create a test database and populate with a sample document
curl -fsS $AUTH -X PUT http://$HOST:5984/testdb || true
curl -fsS $AUTH -H 'Content-Type: application/json' -d '{"_id":"doc1","type":"test","message":"Hello from CVE-2022-24706 PoC"}' \
  -X POST http://$HOST:5984/testdb || true
