#!/bin/sh
set -e

# Ensure cookie permissions are correct for Erlang
chown couchdb:couchdb /opt/couchdb/.erlang.cookie
chmod 400 /opt/couchdb/.erlang.cookie

# Start CouchDB in background
/docker-entrypoint.sh couchdb &
PID=$!

# Wait for HTTP API to become available, then initialize data
for i in $(seq 1 60); do
  if curl -fsS http://127.0.0.1:5984/ >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

/sh /init-db.sh || true

# Wait on CouchDB process
wait $PID
