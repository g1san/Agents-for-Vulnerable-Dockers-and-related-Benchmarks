#!/usr/bin/env sh
set -eu

COUCH_USER="${COUCHDB_USER:-admin}"
COUCH_PASS="${COUCHDB_PASSWORD:-admin}"
COUCH_URL="http://127.0.0.1:5984"
AUTH_URL="http://${COUCH_USER}:${COUCH_PASS}@127.0.0.1:5984"

# wait for /_up
for i in $(seq 1 60); do
  if curl -sf "${COUCH_URL}/_up" >/dev/null 2>&1; then
    break
  fi
  sleep 2
done

# create test database (idempotent)
curl -sf -X PUT "${AUTH_URL}/testdb" || true

# insert a sample document (idempotent-like; ignore conflicts)
TS=$(date -u +%FT%TZ || true)
DOC='{"type":"sample","msg":"hello","ts":"'"${TS}"'"}'

curl -sf -H 'Content-Type: application/json' -X POST \
  "${AUTH_URL}/testdb" -d "${DOC}" || true

exit 0
