FROM eclipse-temurin:11-jre

ENV JETTY_VERSION=9.4.37.v20210219 \
    JETTY_HOME=/opt/jetty \
    JETTY_BASE=/var/lib/jetty

# Create jetty user/group and install prerequisites
RUN useradd -r -m -U -d ${JETTY_HOME} -s /usr/sbin/nologin jetty \
    && apt-get update \
    && apt-get install -y --no-install-recommends ca-certificates curl bash \
    && rm -rf /var/lib/apt/lists/* \
    # Fetch and install Jetty distribution
    && mkdir -p ${JETTY_HOME} \
    && curl -fsSL https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-distribution/${JETTY_VERSION}/jetty-distribution-${JETTY_VERSION}.tar.gz -o /tmp/jetty.tar.gz \
    && tar -xzf /tmp/jetty.tar.gz -C ${JETTY_HOME} --strip-components=1 \
    && rm /tmp/jetty.tar.gz \
    # Initialize Jetty base with needed modules (ensure server, http, and deploy are enabled)
    && mkdir -p ${JETTY_BASE} \
    && JETTY_BASE=${JETTY_BASE} java -jar ${JETTY_HOME}/start.jar --create-startd --add-to-start=server,http,deploy \
    && chown -R jetty:jetty ${JETTY_HOME} ${JETTY_BASE}

# Copy vulnerable demo webapp into Jetty's webapps directory
COPY webapps/ ${JETTY_BASE}/webapps/

# Ensure ownership for runtime
RUN chown -R jetty:jetty ${JETTY_BASE}

USER jetty
WORKDIR ${JETTY_BASE}
EXPOSE 8080

# Start Jetty with explicit modules to guarantee a runnable server
CMD ["java", "-jar", "/opt/jetty/start.jar", "--module=server,http,deploy"]
