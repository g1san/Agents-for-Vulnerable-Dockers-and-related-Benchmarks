version: "3.8"

services:
  teamcity-server:
    image: jetbrains/teamcity-server:2023.05.3
    container_name: cve-2023-42793-teamcity
    ports:
      - "8111:8111"
    environment:
      - TEAMCITY_SERVER_MEM_OPTS=-Xmx2g -Xms1g
      - TEAMCITY_CONTEXT_PATH=
    volumes:
      - ./teamcity-data:/data
    restart: unless-stopped
    healthcheck:
      # Self-healing healthcheck: if startup wizard is pending, create admin via super user token, then check /
      test: ["CMD-SHELL", "set -e; BASE=http://localhost:8111; if [ -f /data/system/superUserToken.txt ] && [ ! -f /data/system/.admin_created ]; then TOKEN=$(cat /data/system/superUserToken.txt); (curl -fsS \"$BASE/admin/createAdmin.html?superUser=$TOKEN\" >/dev/null 2>&1 || true); (curl -fsS -X POST \"$BASE/admin/createAdmin.html?superUser=$TOKEN\" -H 'Content-Type: application/x-www-form-urlencoded' --data 'username=admin&name=Administrator&password=admin123&retypedPassword=admin123&email=admin%40local' >/dev/null 2>&1 || true); touch /data/system/.admin_created || true; fi; curl -fsS $BASE/ >/dev/null"]
      interval: 10s
      timeout: 10s
      retries: 60

# Notes:
# - This stack runs JetBrains TeamCity Server 2023.05.3 (vulnerable).
# - The internal evaluation database is used and initialized automatically.
# - The healthcheck creates an admin user (admin/admin123) using the super user token to finish setup, ensuring the service becomes healthy and immediately usable without manual steps.
# - Data is stored under ./teamcity-data and pre-seeded config files skip DB selection and license prompts."},{