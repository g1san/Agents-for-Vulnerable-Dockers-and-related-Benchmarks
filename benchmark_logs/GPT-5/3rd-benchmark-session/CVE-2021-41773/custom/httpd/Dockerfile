FROM debian:bullseye-slim

ARG HTTPD_VERSION=2.4.49
ARG APR_VERSION=1.7.0
ARG APR_UTIL_VERSION=1.6.1

ENV PREFIX=/usr/local/apache2 \
    PATH=/usr/local/apache2/bin:${PATH}

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      ca-certificates \
      build-essential \
      wget \
      curl \
      tar \
      perl \
      libpcre3-dev \
      zlib1g-dev \
      libssl-dev \
      libexpat1-dev \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp/build

# Download sources
RUN wget -q https://archive.apache.org/dist/httpd/httpd-${HTTPD_VERSION}.tar.gz \
 && wget -q https://archive.apache.org/dist/apr/apr-${APR_VERSION}.tar.gz \
 && wget -q https://archive.apache.org/dist/apr/apr-util-${APR_UTIL_VERSION}.tar.gz \
 && tar xzf httpd-${HTTPD_VERSION}.tar.gz \
 && tar xzf apr-${APR_VERSION}.tar.gz \
 && tar xzf apr-util-${APR_UTIL_VERSION}.tar.gz \
 && mv apr-${APR_VERSION} httpd-${HTTPD_VERSION}/srclib/apr \
 && mv apr-util-${APR_UTIL_VERSION} httpd-${HTTPD_VERSION}/srclib/apr-util

WORKDIR /tmp/build/httpd-${HTTPD_VERSION}

# Build and install httpd with shared MPMs and CGI support
RUN ./configure \
      --prefix=${PREFIX} \
      --with-included-apr \
      --enable-so \
      --enable-alias=shared \
      --enable-cgi=shared \
      --enable-cgid=shared \
      --enable-rewrite=shared \
      --enable-mime=shared \
      --enable-dir=shared \
      --enable-log_config=shared \
      --enable-setenvif=shared \
      --enable-status=shared \
      --enable-autoindex=shared \
      --enable-negotiation=shared \
      --enable-headers=shared \
      --enable-env=shared \
      --enable-unixd=shared \
      --enable-authz_core=shared \
      --enable-authz_host=shared \
      --enable-access_compat=shared \
      --enable-require=shared \
      --enable-deflate=shared \
      --enable-filter=shared \
      --enable-proxy=shared \
      --enable-proxy_http=shared \
      --enable-mods-shared=all \
      --enable-mpms-shared=all \
 && make -j"$(nproc)" \
 && make install \
 && rm -rf /tmp/build

# Create runtime dirs and sample content
RUN mkdir -p ${PREFIX}/htdocs \
    && mkdir -p ${PREFIX}/cgi-bin \
    && mkdir -p /var/www/uploads \
    && echo "Vulnerable Apache 2.4.49 up - CVE-2021-41773 test page" > ${PREFIX}/htdocs/index.html \
    && echo "Sample public file in aliased dir" > /var/www/uploads/public.txt \
    && printf "#!/bin/sh\n\necho \"Content-Type: text/plain\"\n\necho \"CGI OK\"\n" > ${PREFIX}/cgi-bin/test.sh \
    && chmod +x ${PREFIX}/cgi-bin/test.sh

# Copy our custom httpd.conf
COPY conf/httpd.conf ${PREFIX}/conf/httpd.conf

EXPOSE 80

CMD ["/usr/local/apache2/bin/httpd", "-DFOREGROUND"]
