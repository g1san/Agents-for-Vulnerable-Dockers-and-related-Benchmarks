FROM debian:10-slim

ENV DEBIAN_FRONTEND=noninteractive \
    OSMTPD_VER=6.6.1p1 \
    OSMTPD_URL=https://www.opensmtpd.org/archives/opensmtpd-6.6.1p1.tar.gz

# Point APT to archived repositories for Debian Buster and relax validity checks
RUN sed -i \
      -e 's|deb.debian.org/debian|archive.debian.org/debian|g' \
      -e 's|security.debian.org/debian-security|archive.debian.org/debian-security|g' \
      -e 's|deb.debian.org/debian-security|archive.debian.org/debian-security|g' \
      /etc/apt/sources.list \
 && printf 'Acquire::Check-Valid-Until "false";\nAcquire::AllowInsecureRepositories "true";\n' > /etc/apt/apt.conf.d/99no-check-valid-until

# Build and runtime dependencies
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    build-essential \
    libssl-dev \
    libevent-dev \
    zlib1g-dev \
    libbsd-dev \
    libasr-dev \
    pkg-config \
    curl \
    ca-certificates \
    openssl \
    ssl-cert \
    # parser generator needed by build
    bison \
    # optional but commonly paired with bison
    flex \
    # autotools (kept harmlessly; not strictly needed for release tarballs)
    autoconf \
    automake \
    libtool \
    m4 \
    # runtime libs to keep \
    libevent-2.1-6 \
    libssl1.1 \
    libasr0 \
    zlib1g \
 && rm -rf /var/lib/apt/lists/*

# Fetch, build and install OpenSMTPD portable from official archives (release tarball includes configure)
RUN set -eux; \
    curl -fL "$OSMTPD_URL" -o /tmp/opensmtpd.tar.gz; \
    mkdir -p /tmp/opensmtpd; \
    tar -xzf /tmp/opensmtpd.tar.gz -C /tmp/opensmtpd --strip-components=0; \
    cd "/tmp/opensmtpd/opensmtpd-${OSMTPD_VER}"; \
    ./configure --prefix=/usr --sysconfdir=/etc --with-ssl=openssl; \
    make -j"$(nproc)"; \
    make install; \
    cd /; \
    rm -rf /tmp/opensmtpd /tmp/opensmtpd.tar.gz

# Create required users/groups and spool directories
RUN addgroup --system _smtpd || true \
 && adduser --system --ingroup _smtpd --no-create-home _smtpd || true \
 && addgroup --system _smtpq || true \
 && adduser --system --ingroup _smtpq --no-create-home _smtpq || true \
 && mkdir -p /var/spool/smtpd /var/spool/mail /run/smtpd \
 && chown -R _smtpd:_smtpd /var/spool/smtpd \
 && chmod 1733 /var/spool/mail

# Provide minimal aliases to avoid alias resolution issues
RUN printf "root: root\n" > /etc/aliases

COPY smtpd.conf /etc/smtpd.conf
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 25

CMD ["/entrypoint.sh"]
