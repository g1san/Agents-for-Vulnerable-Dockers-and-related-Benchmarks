#!/bin/sh
set -e

# Ensure runtime directories exist
mkdir -p /run/smtpd /var/spool/mail
chmod 1733 /var/spool/mail

# Create a non-privileged local user for testing delivery (optional)
if ! id tester >/dev/null 2>&1; then
  adduser --disabled-password --gecos "Test User" tester || true
fi

# Generate snakeoil certs if missing (TLS not required, but config references them)
if [ ! -f /etc/ssl/certs/ssl-cert-snakeoil.pem ] || [ ! -f /etc/ssl/private/ssl-cert-snakeoil.key ]; then
  mkdir -p /etc/ssl/private
  openssl req -x509 -nodes -newkey rsa:2048 -days 3650 \
    -subj "/CN=localhost" \
    -keyout /etc/ssl/private/ssl-cert-snakeoil.key \
    -out /etc/ssl/certs/ssl-cert-snakeoil.pem >/dev/null 2>&1 || true
  chmod 600 /etc/ssl/private/ssl-cert-snakeoil.key
fi

# Initialize aliases (no-op if already present)
newaliases >/dev/null 2>&1 || true

# Run OpenSMTPD in foreground
exec /usr/sbin/smtpd -f /etc/smtpd.conf -n -d
