# Build a local image that provides OpenSMTPD 6.6 portable
FROM debian:bookworm-slim

ARG OSMTPD_VERSION=6.6.1p1
ENV DEBIAN_FRONTEND=noninteractive

# Install build and runtime dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       ca-certificates wget xz-utils \
       build-essential pkg-config \
       libevent-dev libssl-dev libbsd-dev \
       libsqlite3-dev libedit-dev \
       # user/group management tools
       passwd \
    && rm -rf /var/lib/apt/lists/*

# Build and install OpenSMTPD portable 6.6.x
WORKDIR /tmp/build
RUN set -eux; \
    wget -O opensmtpd.tar.gz "https://www.opensmtpd.org/archives/opensmtpd-${OSMTPD_VERSION}.tar.gz"; \
    tar xzf opensmtpd.tar.gz; \
    cd opensmtpd-${OSMTPD_VERSION}; \
    ./configure \
      --prefix=/usr/local \
      --sysconfdir=/etc/smtpd \
      --with-privsep-user=_smtpd \
      --with-queue-user=_smtpq; \
    make -j"$(nproc)"; \
    make install; \
    cd /; rm -rf /tmp/build

# Prepare runtime directories and default config dir
RUN mkdir -p /etc/smtpd /var/spool/smtpd /var/empty

# Copy entrypoint script
COPY ./entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 25/tcp

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
