# Local build providing OpenSMTPD 6.6.x from Alpine 3.11 packages
FROM alpine:3.11

# Use Alpine 3.11 repositories that contain OpenSMTPD 6.6.x
RUN echo "https://dl-cdn.alpinelinux.org/alpine/v3.11/main" > /etc/apk/repositories \
 && echo "https://dl-cdn.alpinelinux.org/alpine/v3.11/community" >> /etc/apk/repositories \
 && apk add --no-cache \
      opensmtpd=6.6.4p1-r1 \
      ca-certificates \
      tzdata \
      bash \
 && update-ca-certificates

# Ensure configuration directory exists; config will be bind-mounted
RUN mkdir -p /etc/smtpd \
    && mkdir -p /var/spool/smtpd \
    && mkdir -p /var/mail

# Copy entrypoint
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

EXPOSE 25/tcp

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["/usr/sbin/smtpd", "-d", "-f", "/etc/smtpd/smtpd.conf"]
