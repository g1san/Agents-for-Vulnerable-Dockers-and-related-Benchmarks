#!/usr/bin/env sh
set -e

# Prepare runtime dirs
mkdir -p /var/mail /var/spool/smtpd /run/smtpd
chmod 755 /run/smtpd || true

# Ensure root's mbox exists for alias delivery (postmaster -> root)
if [ ! -f /var/mail/root ]; then
  touch /var/mail/root
fi
chmod 600 /var/mail/root || true
chown root:root /var/mail/root || true

# Initialize OpenSMTPD spool with required permissions and structure
# Top-level spool must be 711 and owned by root
chmod 711 /var/spool/smtpd || true
chown root:root /var/spool/smtpd || true

# Create expected subdirectories
mkdir -p /var/spool/smtpd/offline \
         /var/spool/smtpd/purge \
         /var/spool/smtpd/queue \
         /var/spool/smtpd/temporary

# Set strict perms and ownership as required by OpenSMTPD 6.6.4p1 on Alpine 3.11
# Subdirs must be 700, owned by uid 101 (smtpd) and gid 0 (root)
for d in offline purge queue temporary; do
  chmod 700 "/var/spool/smtpd/$d" || true
  chown 101:0 "/var/spool/smtpd/$d" || true
done

# Ensure config files exist (they will be mounted read-only by compose)
if [ ! -f /etc/smtpd/smtpd.conf ]; then
  echo "Error: /etc/smtpd/smtpd.conf not found (volume not mounted?)" >&2
  exit 1
fi
if [ ! -f /etc/smtpd/aliases ]; then
  echo "Warning: /etc/smtpd/aliases not found; proceeding without aliases" >&2
fi

# Execute smtpd in foreground with provided args
exec "$@"
