#!/bin/sh
set -e

# Ensure required system users/groups exist
if ! getent group _smtpd >/dev/null 2>&1; then
  groupadd -r _smtpd
fi
if ! getent passwd _smtpd >/dev/null 2>&1; then
  useradd -r -g _smtpd -d /var/empty -s /usr/sbin/nologin _smtpd
fi
if ! getent group _smtpq >/dev/null 2>&1; then
  groupadd -r _smtpq
fi
if ! getent passwd _smtpq >/dev/null 2>&1; then
  useradd -r -g _smtpq -d /var/empty -s /usr/sbin/nologin _smtpq
fi

mkdir -p /var/spool/smtpd /var/empty
chown _smtpd:_smtpd /var/spool/smtpd || true

# Run OpenSMTPD in foreground with provided config
exec /usr/local/sbin/smtpd -d -f /etc/smtpd/smtpd.conf
