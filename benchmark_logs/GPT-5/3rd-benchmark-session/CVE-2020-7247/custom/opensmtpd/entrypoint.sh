#!/bin/sh
set -e

# Ensure OpenSMTPD spool hierarchy, ownership and permissions (idempotent)
mkdir -p /var/spool/smtpd/empty \
         /var/spool/smtpd/purge \
         /var/spool/smtpd/queue/tmp \
         /var/spool/smtpd/queue/corrupt \
         /var/spool/smtpd/queue/envelope \
         /var/spool/smtpd/queue/message \
         /var/spool/smtpd/var/run
chown -R root:root /var/spool/smtpd
chmod 711 /var/spool/smtpd /var/spool/smtpd/empty
chmod 700 /var/spool/smtpd/purge
chown -R _smtpq:_smtpq /var/spool/smtpd/queue
chmod 700 /var/spool/smtpd/queue /var/spool/smtpd/queue/tmp /var/spool/smtpd/queue/corrupt /var/spool/smtpd/queue/envelope /var/spool/smtpd/queue/message
chmod 700 /var/spool/smtpd/var /var/spool/smtpd/var/run

# Ensure mailbox permissions each start
if [ -f /var/mail/test ]; then
  chown test:mail /var/mail/test || true
  chmod 660 /var/mail/test || true
fi

# Run OpenSMTPD in foreground with our config
exec /usr/sbin/smtpd -d -f /etc/opensmtpd/opensmtpd.conf -v
