FROM debian:bookworm-slim

# Build and runtime dependencies
RUN apt-get update \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    build-essential \
    libssl-dev \
    libevent-dev \
    zlib1g-dev \
    bison \
    flex \
    automake \
    autoconf \
    libtool \
    pkg-config \
    curl \
    ca-certificates \
    bash \
 && rm -rf /var/lib/apt/lists/*

ENV OSMTPD_VER=6.6.1p1 \
    LIBASR_VER=1.0.4

# Create required users for privilege separation
RUN groupadd --system _smtpd \
 && useradd --system --no-create-home --gid _smtpd _smtpd \
 && groupadd --system _smtpq \
 && useradd --system --no-create-home --gid _smtpq _smtpq

# Build and install libasr (not available via Debian bookworm repos)
WORKDIR /tmp/build
RUN curl -fsSL https://www.opensmtpd.org/archives/libasr-${LIBASR_VER}.tar.gz -o libasr.tar.gz \
 && tar xzf libasr.tar.gz \
 && cd libasr-${LIBASR_VER} \
 && ./configure --prefix=/usr \
 && make -j"$(nproc)" \
 && make install

# Build and install OpenSMTPD portable 6.6.1p1 (vulnerable era < 6.6.2p1)
# Use -fcommon to avoid multiple definition errors for BSDoptarg/BSDoptind with GCC 10+
RUN curl -fsSL https://www.opensmtpd.org/archives/opensmtpd-${OSMTPD_VER}.tar.gz -o opensmtpd.tar.gz \
 && tar xzf opensmtpd.tar.gz \
 && cd opensmtpd-${OSMTPD_VER} \
 && CFLAGS="-O2 -fcommon" ./configure \
      --prefix=/usr \
      --sysconfdir=/etc/opensmtpd \
      --with-user=_smtpd \
      --with-queue-user=_smtpq \
 && make -j"$(nproc)" \
 && make install \
 && cd / \
 && rm -rf /tmp/build

# Prepare runtime directories with correct ownership and permissions for chroot/queue
RUN set -eux; \
    mkdir -p /var/spool/smtpd/empty; \
    mkdir -p /var/spool/smtpd/purge; \
    mkdir -p /var/spool/smtpd/queue/tmp /var/spool/smtpd/queue/corrupt /var/spool/smtpd/queue/envelope /var/spool/smtpd/queue/message; \
    mkdir -p /var/spool/smtpd/var/run; \
    chown -R root:root /var/spool/smtpd; \
    chmod 711 /var/spool/smtpd /var/spool/smtpd/empty; \
    chmod 700 /var/spool/smtpd/purge; \
    chown -R _smtpq:_smtpq /var/spool/smtpd/queue; \
    chmod 700 /var/spool/smtpd/queue /var/spool/smtpd/queue/tmp /var/spool/smtpd/queue/corrupt /var/spool/smtpd/queue/envelope /var/spool/smtpd/queue/message; \
    chmod 700 /var/spool/smtpd/var /var/spool/smtpd/var/run

# Create a local user for delivery and prepare mail spool (as in original image)
RUN set -eux; \
    if ! getent group mail >/dev/null; then groupadd --system mail; fi; \
    if ! id -u test >/dev/null 2>&1; then useradd --system --home-dir /home/test --gid mail test; fi; \
    mkdir -p /var/mail /home/test; \
    touch /var/mail/test; \
    chown -R test:mail /var/mail/test /home/test; \
    chmod 660 /var/mail/test

# Provide a minimal mail.local to emulate local delivery behavior
RUN mkdir -p /usr/libexec
COPY mail.local /usr/libexec/mail.local
RUN chmod 0755 /usr/libexec/mail.local

# OpenSMTPD configuration and aliases
RUN mkdir -p /etc/opensmtpd
COPY opensmtpd.conf /etc/opensmtpd/opensmtpd.conf
COPY aliases /etc/opensmtpd/aliases

# Simple entrypoint to ensure correct permissions then start smtpd in foreground
COPY entrypoint.sh /entrypoint.sh
RUN chmod 0755 /entrypoint.sh

EXPOSE 25
ENTRYPOINT ["/entrypoint.sh"]
