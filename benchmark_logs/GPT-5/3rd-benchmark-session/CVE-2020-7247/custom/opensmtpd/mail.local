#!/bin/sh
# Minimal local delivery agent for testing purposes
# Usage: mail.local -f <from> <user>

FROM=""
USER=""
while [ $# -gt 0 ]; do
  case "$1" in
    -f)
      shift
      FROM="$1"
      ;;
    *)
      USER="$1"
      ;;
  esac
  shift
done

[ -z "$USER" ] && exit 1

mkdir -p /var/mail
MAILBOX="/var/mail/$USER"
# Ensure mailbox exists and is writable
if [ ! -f "$MAILBOX" ]; then
  touch "$MAILBOX"
  chown test:mail "$MAILBOX" 2>/dev/null || true
  chmod 660 "$MAILBOX" 2>/dev/null || true
fi

# Append the message as-is to the user's mailbox
# Prepend a simple From_ line like traditional mbox
DATESTR=$(date)
echo "From $FROM $DATESTR" >> "$MAILBOX"
cat >> "$MAILBOX"
echo >> "$MAILBOX"
exit 0
