{
    "files": [
        {
            "location": "./../../dockers/CVE-2020-7247/custom/docker-compose.yml",
            "content": "services:\n  opensmtpd:\n    build:\n      context: ./opensmtpd\n    image: cve-2020-7247/opensmtpd:6.6\n    container_name: cve-2020-7247-opensmtpd\n    ports:\n      - \"25:25\"\n    restart: unless-stopped\n"
        },
        {
            "location": "./../../dockers/CVE-2020-7247/custom/opensmtpd/Dockerfile",
            "content": "FROM debian:bookworm-slim\n\n# Build and runtime dependencies\nRUN apt-get update \\\n && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \\\n    build-essential \\\n    libssl-dev \\\n    libevent-dev \\\n    zlib1g-dev \\\n    bison \\\n    flex \\\n    automake \\\n    autoconf \\\n    libtool \\\n    pkg-config \\\n    curl \\\n    ca-certificates \\\n    bash \\\n && rm -rf /var/lib/apt/lists/*\n\nENV OSMTPD_VER=6.6.1p1 \\\n    LIBASR_VER=1.0.4\n\n# Create required users for privilege separation\nRUN groupadd --system _smtpd \\\n && useradd --system --no-create-home --gid _smtpd _smtpd \\\n && groupadd --system _smtpq \\\n && useradd --system --no-create-home --gid _smtpq _smtpq\n\n# Build and install libasr (not available via Debian bookworm repos)\nWORKDIR /tmp/build\nRUN curl -fsSL https://www.opensmtpd.org/archives/libasr-${LIBASR_VER}.tar.gz -o libasr.tar.gz \\\n && tar xzf libasr.tar.gz \\\n && cd libasr-${LIBASR_VER} \\\n && ./configure --prefix=/usr \\\n && make -j\"$(nproc)\" \\\n && make install\n\n# Build and install OpenSMTPD portable 6.6.1p1 (vulnerable era < 6.6.2p1)\n# Use -fcommon to avoid multiple definition errors for BSDoptarg/BSDoptind with GCC 10+\nRUN curl -fsSL https://www.opensmtpd.org/archives/opensmtpd-${OSMTPD_VER}.tar.gz -o opensmtpd.tar.gz \\\n && tar xzf opensmtpd.tar.gz \\\n && cd opensmtpd-${OSMTPD_VER} \\\n && CFLAGS=\"-O2 -fcommon\" ./configure \\\n      --prefix=/usr \\\n      --sysconfdir=/etc/opensmtpd \\\n      --with-user=_smtpd \\\n      --with-queue-user=_smtpq \\\n && make -j\"$(nproc)\" \\\n && make install \\\n && cd / \\\n && rm -rf /tmp/build\n\n# Prepare runtime directories with correct ownership and permissions for chroot/queue\nRUN set -eux; \\\n    mkdir -p /var/spool/smtpd/empty; \\\n    mkdir -p /var/spool/smtpd/purge; \\\n    mkdir -p /var/spool/smtpd/queue/tmp /var/spool/smtpd/queue/corrupt /var/spool/smtpd/queue/envelope /var/spool/smtpd/queue/message; \\\n    mkdir -p /var/spool/smtpd/var/run; \\\n    chown -R root:root /var/spool/smtpd; \\\n    chmod 711 /var/spool/smtpd /var/spool/smtpd/empty; \\\n    chmod 700 /var/spool/smtpd/purge; \\\n    chown -R _smtpq:_smtpq /var/spool/smtpd/queue; \\\n    chmod 700 /var/spool/smtpd/queue /var/spool/smtpd/queue/tmp /var/spool/smtpd/queue/corrupt /var/spool/smtpd/queue/envelope /var/spool/smtpd/queue/message; \\\n    chmod 700 /var/spool/smtpd/var /var/spool/smtpd/var/run\n\n# Create a local user for delivery and prepare mail spool (as in original image)\nRUN set -eux; \\\n    if ! getent group mail >/dev/null; then groupadd --system mail; fi; \\\n    if ! id -u test >/dev/null 2>&1; then useradd --system --home-dir /home/test --gid mail test; fi; \\\n    mkdir -p /var/mail /home/test; \\\n    touch /var/mail/test; \\\n    chown -R test:mail /var/mail/test /home/test; \\\n    chmod 660 /var/mail/test\n\n# Provide a minimal mail.local to emulate local delivery behavior\nRUN mkdir -p /usr/libexec\nCOPY mail.local /usr/libexec/mail.local\nRUN chmod 0755 /usr/libexec/mail.local\n\n# OpenSMTPD configuration and aliases\nRUN mkdir -p /etc/opensmtpd\nCOPY opensmtpd.conf /etc/opensmtpd/opensmtpd.conf\nCOPY aliases /etc/opensmtpd/aliases\n\n# Simple entrypoint to ensure correct permissions then start smtpd in foreground\nCOPY entrypoint.sh /entrypoint.sh\nRUN chmod 0755 /entrypoint.sh\n\nEXPOSE 25\nENTRYPOINT [\"/entrypoint.sh\"]\n"
        },
        {
            "location": "./../../dockers/CVE-2020-7247/custom/opensmtpd/opensmtpd.conf",
            "content": "# Minimal OpenSMTPD configuration for 6.6.x portable\n\n# Listen on all interfaces (SMTP default port 25)\nlisten on 0.0.0.0\n\n# Aliases table\ntable aliases file:/etc/opensmtpd/aliases\n\n# Action uses an mda invoked via a shell and expands aliases\naction \"local\" mda \"/bin/sh -c '/usr/libexec/mail.local -f %{mbox.from} %{user.username}'\" alias <aliases> user root\n\n# Accept messages for any and deliver using the above action\nmatch from any for any action \"local\"\n"
        },
        {
            "location": "./../../dockers/CVE-2020-7247/custom/opensmtpd/aliases",
            "content": "# Local aliases\nroot: test\ntest: test\n"
        },
        {
            "location": "./../../dockers/CVE-2020-7247/custom/opensmtpd/mail.local",
            "content": "#!/bin/sh\n# Minimal local delivery agent for testing purposes\n# Usage: mail.local -f <from> <user>\n\nFROM=\"\"\nUSER=\"\"\nwhile [ $# -gt 0 ]; do\n  case \"$1\" in\n    -f)\n      shift\n      FROM=\"$1\"\n      ;;\n    *)\n      USER=\"$1\"\n      ;;\n  esac\n  shift\ndone\n\n[ -z \"$USER\" ] && exit 1\n\nmkdir -p /var/mail\nMAILBOX=\"/var/mail/$USER\"\n# Ensure mailbox exists and is writable\nif [ ! -f \"$MAILBOX\" ]; then\n  touch \"$MAILBOX\"\n  chown test:mail \"$MAILBOX\" 2>/dev/null || true\n  chmod 660 \"$MAILBOX\" 2>/dev/null || true\nfi\n\n# Append the message as-is to the user's mailbox\n# Prepend a simple From_ line like traditional mbox\nDATESTR=$(date)\necho \"From $FROM $DATESTR\" >> \"$MAILBOX\"\ncat >> \"$MAILBOX\"\necho >> \"$MAILBOX\"\nexit 0\n"
        },
        {
            "location": "./../../dockers/CVE-2020-7247/custom/opensmtpd/entrypoint.sh",
            "content": "#!/bin/sh\nset -e\n\n# Ensure OpenSMTPD spool hierarchy, ownership and permissions (idempotent)\nmkdir -p /var/spool/smtpd/empty \\\n         /var/spool/smtpd/purge \\\n         /var/spool/smtpd/queue/tmp \\\n         /var/spool/smtpd/queue/corrupt \\\n         /var/spool/smtpd/queue/envelope \\\n         /var/spool/smtpd/queue/message \\\n         /var/spool/smtpd/var/run\nchown -R root:root /var/spool/smtpd\nchmod 711 /var/spool/smtpd /var/spool/smtpd/empty\nchmod 700 /var/spool/smtpd/purge\nchown -R _smtpq:_smtpq /var/spool/smtpd/queue\nchmod 700 /var/spool/smtpd/queue /var/spool/smtpd/queue/tmp /var/spool/smtpd/queue/corrupt /var/spool/smtpd/queue/envelope /var/spool/smtpd/queue/message\nchmod 700 /var/spool/smtpd/var /var/spool/smtpd/var/run\n\n# Ensure mailbox permissions each start\nif [ -f /var/mail/test ]; then\n  chown test:mail /var/mail/test || true\n  chmod 660 /var/mail/test || true\nfi\n\n# Run OpenSMTPD in foreground with our config\nexec /usr/sbin/smtpd -d -f /etc/opensmtpd/opensmtpd.conf -v\n"
        }
    ],
    "directory_tree": "./CVE-2020-7247\n\u2514\u2500\u2500 custom\n    \u251c\u2500\u2500 docker-compose.yml\n    \u2514\u2500\u2500 opensmtpd\n        \u251c\u2500\u2500 Dockerfile\n        \u251c\u2500\u2500 aliases\n        \u251c\u2500\u2500 entrypoint.sh\n        \u251c\u2500\u2500 mail.local\n        \u2514\u2500\u2500 opensmtpd.conf"
}