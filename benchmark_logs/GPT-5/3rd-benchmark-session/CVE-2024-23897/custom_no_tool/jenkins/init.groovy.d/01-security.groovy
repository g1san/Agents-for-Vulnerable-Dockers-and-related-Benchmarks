import jenkins.model.*
import hudson.security.*

// Disable setup wizard explicitly
System.setProperty('jenkins.install.runSetupWizard', 'false')

def instance = Jenkins.getInstance()

// Security realm: internal database
if (!(instance.getSecurityRealm() instanceof HudsonPrivateSecurityRealm)) {
  def hudsonRealm = new HudsonPrivateSecurityRealm(false)
  instance.setSecurityRealm(hudsonRealm)
}

def hudsonRealm = instance.getSecurityRealm()

// Create admin user if absent
String adminUser = 'admin'
String adminPass = 'admin'
if (hudsonRealm.getAllUsers().find { it.id == adminUser } == null) {
  def u = hudsonRealm.createAccount(adminUser, adminPass)
  u.save()
}

// Authorization: Grant Anonymous Overall/Read to make testing straightforward
// and grant full admin to the admin user
def strategy = new GlobalMatrixAuthorizationStrategy()
strategy.add(Jenkins.READ, 'anonymous')
strategy.add(Jenkins.ADMINISTER, adminUser)
instance.setAuthorizationStrategy(strategy)

// Basic instance tweaks
instance.setNumExecutors(2)
instance.save()

println '\n[Jenkins Init] Security configured. Admin credentials: admin / admin'
println '[Jenkins Init] Anonymous has Overall/Read.'
println '[Jenkins Init] Demo secret at /var/jenkins_home/secret-demo/flag.txt'\
