FROM eclipse-temurin:11-jre

ENV JETTY_VERSION=9.4.42.v20210604 \
    JETTY_BASE=/opt/jetty \
    JETTY_WEBAPPS=/opt/jetty/webapps

# Create runtime user and directories
RUN useradd --system --create-home --home-dir /opt/jetty --shell /usr/sbin/nologin jetty || true \
    && mkdir -p ${JETTY_WEBAPPS}/ROOT

# Install prerequisites and fetch jetty-runner for the specified Jetty version
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends curl ca-certificates; \
    rm -rf /var/lib/apt/lists/*; \
    curl -fsSL -o /opt/jetty/jetty-runner.jar \
      https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-runner/${JETTY_VERSION}/jetty-runner-${JETTY_VERSION}.jar; \
    chown -R jetty:jetty /opt/jetty

# Copy the demo webapp into place
COPY webapps/ROOT/ ${JETTY_WEBAPPS}/ROOT/
RUN chown -R jetty:jetty ${JETTY_WEBAPPS}

EXPOSE 8080
USER jetty
WORKDIR ${JETTY_BASE}

# Launch Jetty Runner serving the ROOT webapp at /
CMD ["java", "-jar", "/opt/jetty/jetty-runner.jar", "--port", "8080", "/opt/jetty/webapps/ROOT"]
