FROM httpd:2.4.58

# Build and install vulnerable PHP CGI (5.4.1)
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
        ca-certificates curl build-essential autoconf pkg-config \
        libxml2-dev zlib1g-dev; \
    rm -rf /var/lib/apt/lists/*

# Fetch, compile, and install php-cgi 5.4.1 (affected by CVE-2012-1823)
RUN set -eux; \
    curl -fsSL https://museum.php.net/php5/php-5.4.1.tar.gz -o /tmp/php-5.4.1.tar.gz; \
    cd /tmp; \
    tar -xzf php-5.4.1.tar.gz; \
    cd php-5.4.1; \
    ./buildconf --force || true; \
    ./configure --enable-cgi --disable-all; \
    make -j"$(nproc)"; \
    make install; \
    cd /; \
    rm -rf /tmp/php-5.4.1 /tmp/php-5.4.1.tar.gz; \
    php-cgi -v

# Apache configuration to wire PHP via CGI SAPI
COPY conf/php-cgi.conf /usr/local/apache2/conf/extra/php-cgi.conf
RUN set -eux; \
    printf "\n# Include PHP CGI wiring for CVE-2012-1823 reproduction\nInclude conf/extra/php-cgi.conf\n" >> /usr/local/apache2/conf/httpd.conf

# CGI wrapper and sample vulnerable PHP app
COPY cgi-bin/php-cgi /usr/local/apache2/cgi-bin/php-cgi
RUN chmod +x /usr/local/apache2/cgi-bin/php-cgi

COPY src/ /usr/local/apache2/htdocs/
