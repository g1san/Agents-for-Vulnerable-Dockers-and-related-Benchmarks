FROM eclipse-temurin:11-jre

ARG JETTY_VERSION=9.4.42.v20210604
ENV JETTY_HOME=/opt/jetty \
    JETTY_BASE=/var/lib/jetty \
    JETTY_VERSION=${JETTY_VERSION}

RUN apt-get update \
    && apt-get install -y --no-install-recommends curl ca-certificates tar \
    && rm -rf /var/lib/apt/lists/*

# Fetch vulnerable Jetty 9.4.42 distribution
RUN curl -fsSL https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-distribution/${JETTY_VERSION}/jetty-distribution-${JETTY_VERSION}.tar.gz -o /tmp/jetty.tar.gz \
    && mkdir -p /opt \
    && tar -xzf /tmp/jetty.tar.gz -C /opt \
    && mv /opt/jetty-distribution-${JETTY_VERSION} ${JETTY_HOME} \
    && rm /tmp/jetty.tar.gz

# Create a Jetty base with required modules (http, deploy) for Jetty 9.4
RUN mkdir -p ${JETTY_BASE} \
    && java -jar ${JETTY_HOME}/start.jar --create-startd --add-to-start=http,deploy

# Deploy the sample webapp
COPY webapps ${JETTY_BASE}/webapps

EXPOSE 8080
WORKDIR ${JETTY_BASE}
CMD ["java", "-jar", "/opt/jetty/start.jar"]
