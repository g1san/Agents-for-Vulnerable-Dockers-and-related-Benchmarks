FROM eclipse-temurin:11-jre

ARG JETTY_VERSION=9.4.42.v20210604
ENV JETTY_HOME=/opt/jetty \
    JETTY_BASE=/var/lib/jetty

# Minimal tools to fetch Jetty
RUN apt-get update \
    && apt-get install -y --no-install-recommends curl ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create user and JETTY_BASE (do not pre-create JETTY_HOME to allow proper rename)
RUN useradd -ms /bin/bash jetty \
    && mkdir -p "$JETTY_BASE"

# Fetch vulnerable Jetty Home (9.4.42) and place it at /opt/jetty
RUN curl -fsSL \
      https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-home/${JETTY_VERSION}/jetty-home-${JETTY_VERSION}.tar.gz \
      -o /tmp/jetty-home.tgz \
    && tar -xzf /tmp/jetty-home.tgz -C /opt \
    && mv /opt/jetty-home-${JETTY_VERSION} "$JETTY_HOME" \
    && rm -f /tmp/jetty-home.tgz

# Initialize Jetty Base with required modules in non-interactive mode
WORKDIR "$JETTY_BASE"
RUN java -jar "$JETTY_HOME/start.jar" --create-startd --add-modules=http,deploy,webapp --approve-all-licenses \
    && chown -R jetty:jetty "$JETTY_HOME" "$JETTY_BASE"

# Add the demo webapp under ROOT context
COPY --chown=jetty:jetty webapp "$JETTY_BASE/webapps/root"

EXPOSE 8080
USER jetty
CMD ["java", "-jar", "/opt/jetty/start.jar"]
