FROM debian:bullseye-slim

ENV DEBIAN_FRONTEND=noninteractive \
    HTTPD_VERSION=2.4.50 \
    PREFIX=/usr/local/apache2

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    ca-certificates \
    bzip2 \
    tar \
    libpcre3-dev \
    libexpat1-dev \
    libssl-dev \
    zlib1g-dev \
 && rm -rf /var/lib/apt/lists/*

# Fetch and build httpd 2.4.50 with APR and APR-Util bundled
RUN curl -fsSL https://archive.apache.org/dist/httpd/httpd-${HTTPD_VERSION}.tar.bz2 -o /tmp/httpd.tar.bz2 \
 && curl -fsSL https://archive.apache.org/dist/apr/apr-1.7.0.tar.bz2 -o /tmp/apr.tar.bz2 \
 && curl -fsSL https://archive.apache.org/dist/apr/apr-util-1.6.1.tar.bz2 -o /tmp/apr-util.tar.bz2 \
 && tar -xjf /tmp/httpd.tar.bz2 -C /tmp \
 && tar -xjf /tmp/apr.tar.bz2 -C /tmp \
 && tar -xjf /tmp/apr-util.tar.bz2 -C /tmp \
 && mv /tmp/apr-1.7.0 /tmp/httpd-${HTTPD_VERSION}/srclib/apr \
 && mv /tmp/apr-util-1.6.1 /tmp/httpd-${HTTPD_VERSION}/srclib/apr-util \
 && cd /tmp/httpd-${HTTPD_VERSION} \
 && ./configure \
      --prefix=${PREFIX} \
      --enable-so \
      --enable-mods-shared=reallyall \
      --enable-mpms-shared=all \
      --with-mpm=prefork \
      --enable-cgi \
 && make -j"$(nproc)" \
 && make install \
 && rm -rf /tmp/*

# Copy configuration and web content
COPY httpd.conf ${PREFIX}/conf/httpd.conf
COPY www/ ${PREFIX}/htdocs/
COPY cgi-bin/ ${PREFIX}/cgi-bin/
COPY assets/ /var/www/assets/
COPY entrypoint.sh /entrypoint.sh

RUN chmod +x /entrypoint.sh \
 && chmod +x ${PREFIX}/cgi-bin/test.sh

EXPOSE 80
CMD ["/entrypoint.sh"]
