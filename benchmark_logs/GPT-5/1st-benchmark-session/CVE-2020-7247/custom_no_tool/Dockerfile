## Multi-stage build to produce OpenSMTPD 6.6.1p1 locally
FROM debian:bullseye AS build

ENV DEBIAN_FRONTEND=noninteractive \
    OSMTPD_VER=6.6.1p1

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    ca-certificates curl build-essential pkg-config \
    libevent-dev libssl-dev libbsd-dev zlib1g-dev \
    bison flex automake autoconf libtool \
 && rm -rf /var/lib/apt/lists/*

# Fetch and build OpenSMTPD portable 6.6.1p1
RUN curl -fsSL https://www.opensmtpd.org/archives/opensmtpd-${OSMTPD_VER}.tar.gz -o /tmp/opensmtpd.tar.gz \
 && mkdir -p /usr/src/opensmtpd \
 && tar -xzf /tmp/opensmtpd.tar.gz -C /usr/src/opensmtpd --strip-components=1

WORKDIR /usr/src/opensmtpd
RUN ./configure --prefix=/usr --sysconfdir=/etc/opensmtpd \
 && make -j"$(nproc)" \
 && make install

# Runtime image
FROM debian:bullseye-slim AS runtime

ENV DEBIAN_FRONTEND=noninteractive

RUN groupadd -r _smtpd \
 && useradd -r -g _smtpd -d /var/empty -s /usr/sbin/nologin _smtpd \
 && groupadd -r _smtpq \
 && useradd -r -g _smtpq -d /var/empty -s /usr/sbin/nologin _smtpq \
 && apt-get update \
 && apt-get install -y --no-install-recommends \
      libevent-2.1-7 libssl1.1 libbsd0 ca-certificates tzdata \
 && rm -rf /var/lib/apt/lists/*

# Binaries and support files
COPY --from=build /usr/sbin/smtpd /usr/sbin/smtpd
COPY --from=build /usr/bin/smtpctl /usr/bin/smtpctl
COPY --from=build /usr/libexec/ /usr/libexec/
COPY --from=build /usr/share/opensmtpd/ /usr/share/opensmtpd/

# Entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh \
 && mkdir -p /etc/opensmtpd /var/spool/smtpd /var/run/smtpd \
 && chown -R _smtpd:_smtpd /var/spool/smtpd /var/run/smtpd

EXPOSE 25/tcp
ENTRYPOINT ["/entrypoint.sh"]
CMD ["-d", "-f", "/etc/opensmtpd/smtpd.conf"]
