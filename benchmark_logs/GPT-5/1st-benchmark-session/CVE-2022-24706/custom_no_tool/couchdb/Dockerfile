FROM couchdb:3.2.1

# Ensure we can modify config files
USER root

# Expose HTTP externally and keep defaults minimal
COPY local.ini /opt/couchdb/etc/local.d/local.ini

# Make Erlang distribution externally reachable and set a known cookie
# - Fix distribution port to 9100 and bind to all interfaces
# - Force the Erlang cookie to a known value used historically by packages
RUN set -eux; \
    vm="/opt/couchdb/etc/vm.args"; \
    if grep -q "^-setcookie" "$vm"; then \
      sed -ri 's|^-setcookie .*|-setcookie monster|' "$vm"; \
    else \
      echo "-setcookie monster" >> "$vm"; \
    fi; \
    grep -q "inet_dist_listen_min" "$vm" || echo "-kernel inet_dist_listen_min 9100" >> "$vm"; \
    grep -q "inet_dist_listen_max" "$vm" || echo "-kernel inet_dist_listen_max 9100" >> "$vm"; \
    grep -q "inet_dist_use_interface" "$vm" || echo "-kernel inet_dist_use_interface {0,0,0,0}" >> "$vm"; \
    chown -R couchdb:couchdb /opt/couchdb/etc

USER couchdb

EXPOSE 5984 4369 9100
