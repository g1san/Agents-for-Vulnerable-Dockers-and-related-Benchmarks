#!/bin/sh
set -eux

CONF="/usr/local/apache2/conf/httpd.conf"

# Ensure the Apache configuration exists before editing
if [ ! -f "$CONF" ]; then
  echo "Config file not found: $CONF" >&2
  exit 1
fi

# 1) Ensure cgid_module is loaded exactly once
sed -i '/^[[:space:]]*LoadModule[[:space:]]*cgid_module[[:space:]]/d' "$CONF"
printf '\nLoadModule cgid_module modules/mod_cgid.so\n' >> "$CONF"

# 2) Ensure ScriptAlias /cgi-bin/ is present and unique
sed -i '/^[[:space:]]*ScriptAlias[[:space:]]*\/cgi-bin\//d' "$CONF" || true
printf 'ScriptAlias /cgi-bin/ "/usr/local/apache2/cgi-bin/"\n' >> "$CONF"

# 3) Relax protections so traversal outside DocumentRoot is permitted (PoC context)
sed -i 's/Require all denied/Require all granted/g' "$CONF"

# 4) Ensure CGI directory allows executing scripts, append block if missing
if ! grep -qE '^[[:space:]]*<Directory[[:space:]]+"/usr/local/apache2/cgi-bin"' "$CONF"; then
  cat >> "$CONF" <<'EOF'

<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options +ExecCGI
    Require all granted
</Directory>
EOF
fi

# Validate configuration before launching
httpd -t
exec httpd-foreground
