FROM httpd:2.4.49-alpine

# Enable CGI, ScriptAlias, and relax root directory restrictions to expose CVE-2021-41773
RUN set -eux; \
    CONF=/usr/local/apache2/conf/httpd.conf; \
    test -f "$CONF"; \
    # Remove only the LoadModule directive for cgid_module (avoid touching any <IfModule> blocks)
    sed -i -e '/^[[:space:]]*LoadModule[[:space:]]*cgid_module[[:space:]]/d' "$CONF"; \
    printf '\nLoadModule cgid_module modules/mod_cgid.so\n' >> "$CONF"; \
    # Ensure ScriptAlias /cgi-bin/ is present and unique
    sed -i -e '/^[[:space:]]*ScriptAlias[[:space:]]*\/cgi-bin\//d' "$CONF" || true; \
    printf 'ScriptAlias /cgi-bin/ "/usr/local/apache2/cgi-bin/"\n' >> "$CONF"; \
    # Relax protections so traversal outside DocumentRoot is permitted (for PoC)
    sed -i -e 's/Require all denied/Require all granted/g' "$CONF"; \
    # Ensure CGI directory allows executing scripts
    printf '\n<Directory "/usr/local/apache2/cgi-bin">\n    AllowOverride None\n    Options +ExecCGI\n    Require all granted\n</Directory>\n' >> "$CONF"; \
    # Validate configuration at build time, too
    httpd -t

EXPOSE 80
