#!/bin/bash

# Check if the salt-master configuration is valid
salt-master --verify-config
if [ $? -ne 0 ]; then
  echo "Salt-master configuration is invalid."
  exit 1
fi

# Ensure necessary directories exist
if [ ! -d "/var/cache/salt" ]; then
  mkdir -p /var/cache/salt
  echo "Created /var/cache/salt directory."
fi

# Start the salt-master service in the foreground
echo "Starting salt-master..."
salt-master -l debug

# Continuously check the process to keep the container alive
while true; do
  sleep 60
  pgrep -f salt-master > /dev/null || {
    echo "Salt-master process not found, restarting..."
    salt-master -l debug
  }
done
