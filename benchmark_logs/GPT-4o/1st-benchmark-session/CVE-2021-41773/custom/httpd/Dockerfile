FROM debian:bullseye-slim AS build-env

# Install required packages
RUN apt-get update && apt-get install -y \
    libapache2-mod-security2 \
    apache2-bin \
    && rm -rf /var/lib/apt/lists/*

FROM httpd:2.4.49

COPY --from=build-env /etc/apache2/mods-available/security2.load /etc/apache2/mods-available/security2.load

COPY conf/httpd.conf /usr/local/apache2/conf/httpd.conf
COPY www/ /usr/local/apache2/htdocs/

# Ensure the necessary modules are loaded for prefork MPM
RUN sed -i '/LoadModule mpm_event_module/s/^/#/' /usr/local/apache2/conf/httpd.conf
RUN echo 'LoadModule mpm_prefork_module modules/mod_mpm_prefork.so' >> /usr/local/apache2/conf/httpd.conf

# Ensure the server can start with the correct permissions
RUN chown -R www-data:www-data /usr/local/apache2/htdocs
