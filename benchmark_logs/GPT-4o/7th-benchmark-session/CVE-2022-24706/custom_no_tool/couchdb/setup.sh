#!/bin/bash

# This script sets up CouchDB with a secure Erlang cookie and initializes system databases

# Set a secure random Erlang cookie
COOKIE_FILE="/opt/couchdb/.erlang.cookie"
openssl rand -base64 32 > $COOKIE_FILE
chmod 400 $COOKIE_FILE
chown couchdb:couchdb $COOKIE_FILE

# Configure CouchDB admin credentials in local.ini
INI_FILE="/opt/couchdb/etc/local.ini"
echo "[admins]" >> $INI_FILE
echo "admin = password" >> $INI_FILE

# Start CouchDB in the background
/opt/couchdb/bin/couchdb &

# Wait for CouchDB to start
sleep 10

# Initialize system databases if they do not exist
curl -u admin:password -X PUT http://127.0.0.1:5984/_users
curl -u admin:password -X PUT http://127.0.0.1:5984/_nodes
curl -u admin:password -X PUT http://127.0.0.1:5984/_dbs

# Add test data to the _users database
curl -u admin:password -X POST http://127.0.0.1:5984/_users -H "Content-Type: application/json" -d '{"_id": "org.couchdb.user:testuser", "name": "testuser", "password": "testpass", "roles": [], "type": "user"}'

# Bring CouchDB to the foreground
wait
