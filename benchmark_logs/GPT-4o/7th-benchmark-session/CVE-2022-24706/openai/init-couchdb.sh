#!/bin/bash
# Wait for CouchDB to start
until curl -s http://localhost:5984/_up; do
  >&2 echo "CouchDB is unavailable - sleeping"
  sleep 1
done

# Retry mechanism to ensure databases are created
for i in {1..5}; do
  curl -X PUT http://admin:password@localhost:5984/_users
  curl -X PUT http://admin:password@localhost:5984/_replicator
  curl -X PUT http://admin:password@localhost:5984/testdb
  if [ $? -eq 0 ]; then
    echo "Databases created successfully"
    break
  else
    echo "Failed to create databases, retrying..."
    sleep 2
  fi
done

# Add some test data to the test database
curl -X POST http://admin:password@localhost:5984/testdb -H "Content-Type: application/json" -d '{"name": "test", "type": "example"}'
