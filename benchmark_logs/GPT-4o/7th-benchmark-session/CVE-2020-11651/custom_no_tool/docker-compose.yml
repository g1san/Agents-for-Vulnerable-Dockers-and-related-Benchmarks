version: '3.8'

services:
  salt-master:
    image: saltstack/salt:2019.2.3
    container_name: salt-master
    ports:
      - "4505:4505"
      - "4506:4506"
      - "8000:8000"
    volumes:
      - ./master:/etc/salt/master
    command: ["salt-master", "-l", "debug"]
    healthcheck:
      test: ["CMD", "pgrep", "salt-master"]
      interval: 30s
      timeout: 10s
      retries: 5

  salt-minion:
    image: saltstack/salt:2019.2.3
    container_name: salt-minion
    depends_on:
      - salt-master
    volumes:
      - ./minion:/etc/salt/minion
    command: ["salt-minion", "-l", "debug"]
    healthcheck:
      test: ["CMD", "pgrep", "salt-minion"]
      interval: 30s
      timeout: 10s
      retries: 5

  python:
    build:
      context: ./scripts
      dockerfile: Dockerfile
    container_name: python
    depends_on:
      salt-master:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
    working_dir: /scripts
    entrypoint: ["python", "exploit.py"]
