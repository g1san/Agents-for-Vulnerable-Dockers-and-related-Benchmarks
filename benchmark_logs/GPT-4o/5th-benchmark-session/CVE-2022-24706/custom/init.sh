#!/bin/bash

# Wait for CouchDB to start and be ready
until curl -s http://localhost:5984/_up | grep -q '"status":"ok"'; do
  echo "Waiting for CouchDB to be ready..."
  sleep 1
  curl -s http://localhost:5984/_up || echo "CouchDB not ready"
done

# Create necessary system databases if they do not exist
for db in _users _nodes _replicator _global_changes _dbs; do
  if ! curl -s -o /dev/null -w "%{http_code}" "http://admin:securepassword@localhost:5984/$db" | grep -q '200'; then
    curl -X PUT "http://admin:securepassword@localhost:5984/$db" && echo "$db database created" || echo "Failed to create $db database"
  else
    echo "$db database already exists"
  fi
done

# Continue with CouchDB startup
exec "$@"
