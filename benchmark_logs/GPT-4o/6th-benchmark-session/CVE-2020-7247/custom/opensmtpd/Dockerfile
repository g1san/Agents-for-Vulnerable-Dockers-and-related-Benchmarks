FROM alpine:3.11

RUN apk add --no-cache \
    build-base \
    libressl-dev \
    libevent-dev \
    git

# Clone the OpenSMTPD source code for version 6.6.2p1
RUN git clone https://github.com/OpenSMTPD/OpenSMTPD.git /opensmtpd && \
    cd /opensmtpd && \
    git checkout opensmtpd-6.6.2p1

# Build and install OpenSMTPD
RUN cd /opensmtpd && \
    ./bootstrap && \
    ./configure && \
    make && \
    make install

# Create the mail directory
RUN mkdir -p /var/mail

COPY smtpd.conf /etc/smtpd/smtpd.conf

CMD ["/usr/local/sbin/smtpd", "-d", "-f", "/etc/smtpd/smtpd.conf"]
