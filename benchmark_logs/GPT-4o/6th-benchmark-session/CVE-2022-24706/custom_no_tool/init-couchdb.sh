#!/bin/bash

# Function to check if a database exists
check_db_exists() {
  local db_name=$1
  curl -s -o /dev/null -w "%{http_code}" http://admin:password@localhost:5984/$db_name
}

# Wait for CouchDB to start
until [ $(curl -s -o /dev/null -w "%{http_code}" http://admin:password@localhost:5984/_up) -eq 200 ]; do
  echo "Waiting for CouchDB to start..."
  sleep 2
done

# Ensure system databases are created
for db in _users _replicator _global_changes _nodes _dbs; do
  until [ $(check_db_exists $db) -eq 200 ]; do
    echo "Creating $db database..."
    curl -X PUT http://admin:password@localhost:5984/$db
    sleep 1
  done
done

# Create a test database
curl -X PUT http://admin:password@localhost:5984/test_db

# Add some test data
curl -X POST http://admin:password@localhost:5984/test_db -H "Content-Type: application/json" -d '{"name": "test_user", "role": "tester"}'
