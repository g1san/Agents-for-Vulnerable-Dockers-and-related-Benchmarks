FROM jetty:9.4.38-jdk11-slim

# Switch to root to install required packages
USER root

# Install gnupg and curl, update sources, and clean up
RUN apt-get update && apt-get install -y gnupg curl && rm -rf /var/lib/apt/lists/*

# Add missing public keys and update sources
RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0E98404D386FA1D9 6ED0E7B82643E131 605C66F00D6C9793 && \
    sed -i 's/buster/bullseye/g' /etc/apt/sources.list && \
    apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Switch back to jetty user
USER jetty

# Download servlet-api jar
RUN mkdir -p /tmp/lib && \
    curl -o /tmp/lib/servlet-api.jar https://repo1.maven.org/maven2/javax/servlet/javax.servlet-api/4.0.1/javax.servlet-api-4.0.1.jar

COPY ./webapps /var/lib/jetty/webapps

RUN mkdir -p /var/lib/jetty/webapps/ROOT/WEB-INF/classes/com/example
COPY ./webapps/ROOT/WEB-INF/classes/com/example/TestServlet.java /var/lib/jetty/webapps/ROOT/WEB-INF/classes/com/example/TestServlet.java

# Compile the servlet with the servlet-api jar
RUN javac -cp /tmp/lib/servlet-api.jar /var/lib/jetty/webapps/ROOT/WEB-INF/classes/com/example/TestServlet.java
