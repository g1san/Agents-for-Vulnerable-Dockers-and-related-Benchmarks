#!/bin/bash

# Set the admin user in the local.ini file
cat <<EOL >> /opt/couchdb/etc/local.ini
[admins]
admin = admin
EOL

# Start CouchDB in the background to perform initial setup
/opt/couchdb/bin/couchdb -b

# Wait for CouchDB to start by checking its availability
until curl -s http://admin:admin@localhost:5984/; do
    echo "Waiting for CouchDB to start..."
    sleep 5
done

# Create necessary system databases
curl -X PUT http://admin:admin@localhost:5984/_users
curl -X PUT http://admin:admin@localhost:5984/_replicator
curl -X PUT http://admin:admin@localhost:5984/_global_changes
curl -X PUT http://admin:admin@localhost:5984/_nodes
curl -X PUT http://admin:admin@localhost:5984/_dbs

# Set the Erlang cookie to a secure value
echo "secure_cookie_value" > /opt/couchdb/.erlang.cookie
chmod 400 /opt/couchdb/.erlang.cookie

# Stop CouchDB to restart it properly
/opt/couchdb/bin/couchdb -d

# Start CouchDB using the service command
exec /opt/couchdb/bin/couchdb
