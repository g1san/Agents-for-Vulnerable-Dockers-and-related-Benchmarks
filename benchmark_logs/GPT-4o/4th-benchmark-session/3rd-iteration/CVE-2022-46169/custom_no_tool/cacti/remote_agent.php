<?php
// Vulnerable remote_agent.php script

// Simulating the vulnerable code
if (isset($_GET['action']) && $_GET['action'] === 'polldata') {
    $ip = $_SERVER['REMOTE_ADDR'];
    // Simulating a flawed IP verification
    if ($ip === '127.0.0.1') {
        $poller_item = $_GET['poller_item'];
        // Unsafe use of proc_open leading to command injection
        $process = proc_open($poller_item, [
            1 => ['pipe', 'w'],
            2 => ['pipe', 'w'],
        ], $pipes);
        if (is_resource($process)) {
            fclose($pipes[1]);
            fclose($pipes[2]);
            proc_close($process);
        }
    }
}
