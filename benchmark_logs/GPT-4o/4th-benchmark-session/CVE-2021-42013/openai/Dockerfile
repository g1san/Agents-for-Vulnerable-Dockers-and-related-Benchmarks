FROM debian:11.0

RUN apt-get update && \
    apt-get install -y apache2 apache2-bin apache2-utils bash coreutils

# Enable CGI scripts
RUN a2enmod cgi

# Ensure necessary modules are enabled
RUN a2enmod mpm_event && \
    a2enmod alias && \
    a2enmod mime && \
    a2enmod authz_core

# Create log directory and set permissions
RUN mkdir -p /var/log/apache2 && \
    chown -R www-data:www-data /var/log/apache2

# Copy the configuration file
COPY httpd.conf /etc/apache2/apache2.conf

# Health check
HEALTHCHECK --interval=30s --timeout=3s CMD curl -f http://localhost:80/ || exit 1

ENV APACHE_RUN_USER=www-data
ENV APACHE_RUN_GROUP=www-data
ENV APACHE_LOG_DIR=/var/log/apache2

CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
