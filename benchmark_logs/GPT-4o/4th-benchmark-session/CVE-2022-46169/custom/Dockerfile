FROM php:7.4-apache

RUN apt-get update && \
    apt-get install -y git librrd-dev libpng-dev libjpeg-dev libxml2-dev && \
    docker-php-ext-install mysqli && \
    docker-php-ext-install sockets && \
    docker-php-ext-install gd && \
    docker-php-ext-install xml && \
    a2enmod rewrite

COPY cacti.sql /docker-entrypoint-initdb.d/cacti.sql

# Configure Git to treat the directory as safe
RUN git config --global --add safe.directory /var/www/html

# Clone the Cacti repository and checkout the specific version
RUN git clone https://github.com/Cacti/cacti.git /var/www/html && \
    cd /var/www/html && \
    git checkout tags/release/1.2.22

RUN chown -R www-data:www-data /var/www/html

# Allow .htaccess
RUN sed -i 's/AllowOverride None/AllowOverride All/g' /etc/apache2/apache2.conf

EXPOSE 80

