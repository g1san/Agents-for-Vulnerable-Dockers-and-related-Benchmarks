FROM debian:stretch-slim

# Switch to the archive repository
RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list && \
    sed -i '/security.debian.org/d' /etc/apt/sources.list && \
    sed -i '/stretch-updates/d' /etc/apt/sources.list && \
    echo 'Acquire::Check-Valid-Until "0";' > /etc/apt/apt.conf.d/99no-check-valid-until

# Install dependencies
RUN apt-get update && apt-get install -y \
    wget \
    libxml2-dev \
    libcurl4-openssl-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libmcrypt-dev \
    default-libmysqlclient-dev \
    libmariadbclient-dev-compat \
    zlib1g \
    zlib1g-dev \
    apache2 \
    apache2-dev \
    && rm -rf /var/lib/apt/lists/*

# Download and install PHP 5.3
RUN wget -q https://museum.php.net/php5/php-5.3.29.tar.bz2 && \
    tar -xjf php-5.3.29.tar.bz2 && \
    cd php-5.3.29 && \
    ./configure --with-apxs2=/usr/bin/apxs2 --with-mysqli && \
    make && \
    make install && \
    cd .. && rm -rf php-5.3.29 php-5.3.29.tar.bz2

# Copy the PHP configuration
COPY index.php /var/www/html/index.php

# Start Apache
CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
