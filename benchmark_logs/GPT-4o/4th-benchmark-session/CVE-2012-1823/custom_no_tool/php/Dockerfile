FROM debian:buster

# Update sources.list to use the archive repositories
RUN sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
RUN echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until

# Install dependencies
RUN apt-get update && apt-get install -y \
    apache2 \
    apache2-bin \
    apache2-dev \
    wget \
    build-essential \
    libxml2-dev=2.9.4+dfsg1-7+deb10u2 \
    libssl-dev \
    libcurl4-openssl-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libbz2-dev \
    libmcrypt-dev \
    libmariadb-dev-compat \
    libxslt1-dev \
    perl \
    && rm -rf /var/lib/apt/lists/*

# Download and compile PHP 5.3.11
RUN wget https://museum.php.net/php5/php-5.3.11.tar.bz2 \
    && tar -xjf php-5.3.11.tar.bz2 \
    && cd php-5.3.11 \
    && ./configure --with-apxs2=/usr/bin/apxs2 --with-mysqli \
    && make \
    && make install

# Enable CGI mode
RUN a2enmod cgi

WORKDIR /var/www/html

# Copy existing application directory contents
COPY . /var/www/html/

RUN echo 'ServerName localhost' >> /etc/apache2/apache2.conf

CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
