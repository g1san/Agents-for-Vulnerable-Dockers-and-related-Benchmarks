#!/bin/bash

# Ensure the script uses Unix-style line endings

# Set the admin user in the local.ini file
cat <<EOL >> /opt/couchdb/etc/local.ini
[admins]
admin = admin
EOL

# Set the Erlang cookie to a secure value before starting CouchDB
echo "secure_cookie_value" > /opt/couchdb/.erlang.cookie
chmod 400 /opt/couchdb/.erlang.cookie

# Start CouchDB in the background to perform initial setup
/opt/couchdb/bin/couchdb -b

# Wait for CouchDB to start by checking its availability
until curl -s http://admin:admin@localhost:5984/; do
    echo "Waiting for CouchDB to start..."
    sleep 5
done

# Use CouchDB setup endpoint to initialize system databases
curl -X POST http://admin:admin@localhost:5984/_cluster_setup -H "Content-Type: application/json" -d '{"action": "enable_cluster", "bind_address":"0.0.0.0", "username": "admin", "password":"admin", "node_count": "1"}'

# Ensure system databases are created
for db in _users _nodes _dbs _replicator; do
    echo "Checking database $db"
    if ! curl -s http://admin:admin@localhost:5984/$db; then
        echo "Creating database $db"
        curl -X PUT http://admin:admin@localhost:5984/$db
    fi
done

# Stop CouchDB to restart it properly
/opt/couchdb/bin/couchdb -d

# Start CouchDB using the service command
exec /opt/couchdb/bin/couchdb
