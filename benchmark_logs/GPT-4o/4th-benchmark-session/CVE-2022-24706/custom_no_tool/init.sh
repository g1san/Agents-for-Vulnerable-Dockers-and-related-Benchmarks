#!/bin/bash

# Ensure the script uses Unix-style line endings

# Set the admin user in the local.ini file
cat <<EOL >> /opt/couchdb/etc/local.ini
[admins]
admin = admin
EOL

# Start CouchDB in the background to perform initial setup
/opt/couchdb/bin/couchdb -b

# Wait for CouchDB to start by checking its availability
until curl -s http://admin:admin@localhost:5984/; do
    echo "Waiting for CouchDB to start..."
    sleep 5
    done

# Use CouchDB setup endpoint to initialize system databases
curl -X POST http://admin:admin@localhost:5984/_cluster_setup -H "Content-Type: application/json" -d '{"action": "enable_cluster", "bind_address":"0.0.0.0", "username": "admin", "password":"admin", "node_count": "1"}'

# Set the Erlang cookie to a secure value
echo "secure_cookie_value" > /opt/couchdb/.erlang.cookie
chmod 400 /opt/couchdb/.erlang.cookie

# Stop CouchDB to restart it properly
/opt/couchdb/bin/couchdb -d

# Start CouchDB using the service command
exec /opt/couchdb/bin/couchdb
