FROM python:3.8-slim

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       git \
       build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install the distro module required for SaltStack
RUN pip install distro

# Install SaltStack version vulnerable to CVE-2020-11652
RUN pip install salt==3000.1

# Copy the configuration file
COPY salt-master.conf /etc/salt/master

# Modify the SaltStack source code to use 'distro' instead of '_supported_dists'
RUN sed -i 's/from platform import _supported_dists/import distro as _supported_dists/' /usr/local/lib/python3.8/site-packages/salt/grains/core.py
RUN sed -i 's/_supported_dists = \/_supported_dists = distro.linux_distribution()\/' /usr/local/lib/python3.8/site-packages/salt/grains/core.py

# Start the salt-master service
CMD ["salt-master", "-l", "debug"]
