FROM alpine:3.11

# Install s6-overlay for process management
ADD https://github.com/just-containers/s6-overlay/releases/download/v2.1.0.2/s6-overlay-amd64.tar.gz /tmp/
RUN tar xzf /tmp/s6-overlay-amd64.tar.gz -C /

# Install dependencies
RUN apk add --no-cache curl tar build-base openssl

# Download and extract OpenSMTPD 6.6.1
RUN curl -k -L -o /tmp/opensmtpd.tar.gz https://fastly.cdn.openbsd.org/pub/OpenBSD/OpenSMTPD/opensmtpd-6.6.1.tar.gz \
    && tar xzf /tmp/opensmtpd.tar.gz -C /tmp \
    && cd /tmp/opensmtpd-6.6.1 \
    && ./configure \
    && make \
    && make install \
    && apk del curl tar build-base

# Copy configuration files
COPY smtpd.conf /etc/smtpd/smtpd.conf
COPY root/ /

# Set s6-overlay as the entrypoint
ENTRYPOINT ["/init"]
