version: '3.8'
services:
  teamcity-server:
    image: jetbrains/teamcity-server:2023.05.3
    ports:
      - "8111:8111"
    environment:
      TEAMCITY_SERVER_OPTS: -Dteamcity.authorization.interceptor.disabled=true
    volumes:
      - teamcity_data:/data/teamcity_server/datadir
      - teamcity_logs:/opt/teamcity/logs
    depends_on:
      - mysql
    networks:
      app_net:
        aliases:
          - teamcity-server
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: teamcity
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password --init-file=/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: "mysqladmin ping -h localhost -u root --password=example"
      interval: 30s
      timeout: 10s
      retries: 5
    restart: always
    networks:
      app_net:
    entrypoint: ["mysqld"]
  nginx:
    image: nginx:1.21
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    networks:
      app_net:
networks:
  app_net:
volumes:
  teamcity_data:
  teamcity_logs:
  mysql_data:
