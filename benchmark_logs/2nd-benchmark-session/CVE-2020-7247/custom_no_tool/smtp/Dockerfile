FROM alpine:3.11

# Install dependencies for building OpenSMTPD
RUN apk update && apk add --no-cache \
    build-base \
    openssl-dev \
    libevent-dev \
    curl \
    git \
    autoconf \
    automake \
    libtool

# Download and extract a release archive of OpenSMTPD that contains a configure script
RUN curl -L -o /tmp/opensmtpd.tar.gz https://github.com/OpenSMTPD/OpenSMTPD/archive/refs/tags/6.6.1p1.tar.gz \
    && tar -xzf /tmp/opensmtpd.tar.gz -C /tmp \
    && cd /tmp/OpenSMTPD-6.6.1p1 \
    && ./configure \
    && make \
    && make install \
    && rm -rf /tmp/opensmtpd /tmp/OpenSMTPD-6.6.1p1 /tmp/opensmtpd.tar.gz

COPY smtpd.conf /etc/smtpd/smtpd.conf
COPY start.sh /start.sh
RUN chmod +x /start.sh

ENTRYPOINT ["/start.sh"]
