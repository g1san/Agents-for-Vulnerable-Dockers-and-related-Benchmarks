FROM php:7.4-apache

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        libpng-dev \
        libjpeg-dev \
        libpq-dev \
        libzip-dev \
        zlib1g-dev \
        librrd-dev \
        rrdtool \
        libldap2-dev \
        libxml2-dev \
        git \
        wget \
        unzip \
        netcat-openbsd && \
    docker-php-ext-configure gd --with-jpeg && \
    docker-php-ext-install gd mysqli zip && \
    pecl install rrd && \
    docker-php-ext-enable rrd && \
    echo "extension=rrd.so" > /usr/local/etc/php/conf.d/rrd.ini && \
    a2enmod rewrite && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /var/www/html

# Download the correct Cacti source archive (v1.2.22)
RUN wget -O cacti.tar.gz https://github.com/Cacti/cacti/archive/v1.2.22.tar.gz && \
    tar -xzf cacti.tar.gz --strip-components=1 && \
    rm cacti.tar.gz && \
    chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html

COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

ENTRYPOINT ["sh","/usr/local/bin/entrypoint.sh"]
CMD ["apache2-foreground"]