#!/bin/bash
set -e

# Wait for MySQL to become available
host="${CACTI_DB_HOST}"
port="${CACTI_DB_PORT:-3306}"
while ! nc -z "$host" "$port"; do
  echo "Waiting for MySQL at $host:$port..."
  sleep 2
done

# Initialise Cacti configuration if not already present
if [ ! -f /var/www/html/include/config.php ]; then
  echo "Initializing Cacti configuration..."
  cp include/config.php.dist include/config.php
  sed -i "s/'localhost'/'${CACTI_DB_HOST}'/" include/config.php
  sed -i "s/'cacti'/'${CACTI_DB_NAME}'/" include/config.php
  sed -i "s/'cactiuser'/'${CACTI_DB_USER}'/" include/config.php
  # Set DB password â€“ the default config uses the string 'cacti' for the password
  sed -i "s/'cacti'/'${CACTI_DB_PASS}'/" include/config.php
  chown -R www-data:www-data /var/www/html
fi

exec "$@"