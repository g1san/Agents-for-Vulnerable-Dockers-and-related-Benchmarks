FROM php:7.4-apache

# Install required packages for Cacti
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        libpng-dev \
        libjpeg-dev \
        libpq-dev \
        libzip-dev \
        zlib1g-dev \
        librrd-dev \
        rrdtool \
        libldap2-dev \
        libxml2-dev \
        git \
        wget \
        unzip && \
    docker-php-ext-configure gd --with-jpeg && \
    docker-php-ext-install gd mysqli zip && \
    pecl install rrd && \
    docker-php-ext-enable rrd && \
    echo "extension=rrd.so" > /usr/local/etc/php/conf.d/rrd.ini && \
    a2enmod rewrite && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /var/www/html

# Download Cacti 1.2.22 (the vulnerable version)
RUN wget -O cacti.tar.gz https://codeload.github.com/Cacti/cacti/tar.gz/1.2.22 && \
    tar -xzf cacti.tar.gz --strip-components=1 && \
    rm cacti.tar.gz && \
    chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html

# Copy custom entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["apache2-foreground"]