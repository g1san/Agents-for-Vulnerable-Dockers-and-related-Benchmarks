#!/bin/bash
set -e

# Wait for MySQL to be ready
while ! nc -z "$CACTI_DB_HOST" 3306; do
  echo "Waiting for MySQL..."
  sleep 2
done

# Configure Cacti database settings if not already configured
if [ -f /var/www/html/include/config.php ]; then
  echo "Cacti config already exists."
else
  cp /var/www/html/include/config.php.dist /var/www/html/include/config.php
  sed -i "s/\$database_default_user = .*/\$database_default_user = \"${CACTI_DB_USER}\";/" /var/www/html/include/config.php
  sed -i "s/\$database_default_password = .*/\$database_default_password = \"${CACTI_DB_PASSWORD}\";/" /var/www/html/include/config.php
  sed -i "s/\$database_default_host = .*/\$database_default_host = \"${CACTI_DB_HOST}\";/" /var/www/html/include/config.php
  sed -i "s/\$database_default_name = .*/\$database_default_name = \"${CACTI_DB_NAME}\";/" /var/www/html/include/config.php
fi

exec "$@"