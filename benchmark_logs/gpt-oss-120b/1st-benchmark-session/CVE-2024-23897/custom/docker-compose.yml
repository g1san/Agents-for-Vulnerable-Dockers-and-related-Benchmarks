version: '3.8'
services:
  jenkins:
    image: jenkins/jenkins:2.441
    container_name: jenkins
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
    volumes:
      - jenkins_home:/var/jenkins_home
    depends_on:
      - postgres
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      - POSTGRES_USER=jenkins
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=jenkins
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
  vulnerable-app:
    image: php:8.2-apache
    container_name: vulnerable_app
    ports:
      - "8081:80"
    volumes:
      - ./app:/var/www/html
    depends_on:
      - vulnerable-redis
    environment:
      - REDIS_HOST=vulnerable-redis
      - REDIS_PORT=6379
  vulnerable-redis:
    image: redis:6.0
    container_name: vulnerable_redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--protected-mode", "no", "--loglevel", "warning"]
    volumes:
      - redis-data:/data
volumes:
  jenkins_home:
  pg_data:
  redis-data:
