#!/bin/sh
# wait-for-db.sh â€“ blocks until PostgreSQL is ready or exits with error after timeout
HOST=${DATABASE_HOST:-db}
PORT=${DATABASE_PORT:-5432}
USER=${DATABASE_USER:-postgres}
MAX_RETRIES=30
SLEEP_INTERVAL=2

echo "Waiting for PostgreSQL at $HOST:$PORT..."
for i in $(seq 1 $MAX_RETRIES); do
  if pg_isready -h "$HOST" -p "$PORT" -U "$USER" >/dev/null 2>&1; then
    echo "PostgreSQL is ready (attempt $i)."
    exit 0
  fi
  echo "PostgreSQL not ready yet (attempt $i/$MAX_RETRIES). Sleeping $SLEEP_INTERVAL sec..."
  sleep $SLEEP_INTERVAL
done

echo "ERROR: PostgreSQL did not become ready after $MAX_RETRIES attempts."
exit 1