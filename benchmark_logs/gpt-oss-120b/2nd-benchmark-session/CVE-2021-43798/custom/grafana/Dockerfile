FROM grafana/grafana:8.2.3

# Switch to root to perform privileged operations
USER root

# Ensure the plugins directory exists and set proper ownership
RUN mkdir -p /var/lib/grafana/plugins && \
    chown -R 472:472 /var/lib/grafana/plugins

# Copy the malicious plugin into the plugins directory
COPY plugins/malicious-plugin /var/lib/grafana/plugins/malicious-plugin

# Adjust ownership of the copied plugin files
RUN chown -R 472:472 /var/lib/grafana/plugins/malicious-plugin

# Revert to the default Grafana user
USER grafana