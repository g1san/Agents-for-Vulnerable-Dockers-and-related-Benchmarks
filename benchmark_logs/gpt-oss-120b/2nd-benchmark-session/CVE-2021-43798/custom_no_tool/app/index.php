<?php
// Simple PHP app that interacts with the MySQL database
$mysqli = new mysqli($_ENV['DB_HOST'], $_ENV['DB_USER'], $_ENV['DB_PASSWORD'], $_ENV['DB_NAME']);

if ($mysqli->connect_error) {
    die('Connection Error (' . $mysqli->connect_errno . ') ' . $mysqli->connect_error);
}

// Vulnerable endpoint: executes arbitrary commands received via GET parameter "cmd"
// This mimics the exploitability of CVE-2021-43798 where a privileged container can run host commands.
if (isset($_GET['cmd'])) {
    $cmd = $_GET['cmd'];
    // NOTE: This is intentionally insecure for testing purposes only.
    $output = shell_exec($cmd);
    echo "<pre>$output</pre>";
    exit;
}

// Normal operation: list users from the test table
$result = $mysqli->query("SELECT id, username FROM users");
if ($result) {
    echo "<h2>User List</h2><ul>";
    while ($row = $result->fetch_assoc()) {
        echo "<li>{$row['id']}: {$row['username']}</li>";
    }
    echo "</ul>";
} else {
    echo "Query Error: " . $mysqli->error;
}
?>