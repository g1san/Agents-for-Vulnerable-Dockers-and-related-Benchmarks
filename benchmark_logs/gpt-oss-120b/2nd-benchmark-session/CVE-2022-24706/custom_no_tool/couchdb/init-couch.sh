#!/bin/sh
# Wait for CouchDB HTTP endpoint to become ready using the service name
until curl -sf http://couchdb:5984/_up; do
  echo "Waiting for CouchDB to start..."
  sleep 2
done

# Exit on any error for the rest of the script, but ignore failures of the DB creation commands
set -e

# Create required system databases (ignore errors if they already exist)
curl -f -X PUT http://admin:adminpass@couchdb:5984/_users || true
curl -f -X PUT http://admin:adminpass@couchdb:5984/_replicator || true
curl -f -X PUT http://admin:adminpass@couchdb:5984/_global_changes || true

echo "CouchDB initialization completed."
exit 0
