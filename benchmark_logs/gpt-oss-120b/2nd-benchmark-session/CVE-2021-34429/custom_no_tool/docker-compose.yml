services:
  vulnerable:
    image: alpine:3.13
    container_name: vulnerable
    command: ["tail", "-f", "/dev/null"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  jetty-vuln:
    image: jetty:9.4.42-jdk11
    container_name: jetty-vuln
    ports:
      - "8080:8080"
    volumes:
      - ./webapp:/var/lib/jetty/webapps/ROOT:ro
    # Ensure Jetty runs in the foreground (default entrypoint does this)

  exploit:
    build:
      context: .
      dockerfile: Dockerfile.exploit
    container_name: exploit
    depends_on:
      - vulnerable
      - jetty-vuln
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    privileged: true
    command: ["sh", "/exploit.sh"]