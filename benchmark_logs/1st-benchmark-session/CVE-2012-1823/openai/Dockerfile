FROM debian:bullseye as build

# Install dependencies for building PHP
RUN apt-get update && apt-get install -y \
    autoconf \
    build-essential \
    curl \
    libxml2-dev \
    libssl-dev \
    libcurl4-openssl-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libonig-dev \
    && rm -rf /var/lib/apt/lists/*

# Download and extract PHP source
RUN curl -SL "https://museum.php.net/php5/php-5.3.11.tar.bz2" | tar -xjC /usr/src/

# Build PHP
WORKDIR /usr/src/php-5.3.11
RUN ./configure --with-config-file-path=/usr/local/etc/php \
    --with-config-file-scan-dir=/usr/local/etc/php/conf.d \
    --enable-mbstring \
    --enable-soap \
    --enable-intl \
    --with-openssl \
    --with-zlib \
    --with-curl \
    --with-jpeg-dir \
    --with-png-dir \
    --with-freetype-dir \
    --enable-exif \
    --enable-calendar \
    --enable-bcmath \
    --with-bz2 \
    --with-gettext \
    --with-gmp \
    --enable-fpm
RUN make -j"$(nproc)" && make install

FROM httpd:2.2.22

COPY httpd.conf /usr/local/apache2/conf/httpd.conf

RUN apt-get update && \
    apt-get install -y libfcgi-bin && \
    apt-get clean

COPY --from=build /usr/local/bin/php-cgi /usr/local/bin/php-cgi
COPY --from=build /usr/local/etc/php /usr/local/etc/php
COPY --from=build /usr/local/lib/php/extensions/no-debug-non-zts-20090626 /usr/local/lib/php/extensions/no-debug-non-zts-20090626

COPY public /var/www/html

