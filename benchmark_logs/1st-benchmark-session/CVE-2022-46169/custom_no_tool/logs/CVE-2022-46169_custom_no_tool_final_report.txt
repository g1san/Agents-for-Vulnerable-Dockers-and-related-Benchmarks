========== Generated Code (First Version) ==========
Directory tree:
CVE-2022-46169/
├── docker-compose.yml
├── cacti/
│   ├── Dockerfile
│   └── config.php
└── mysql/
    └── init.sql


---------- docker-compose.yml ----------
version: '3.7'
services:
  mysql:
    image: mysql:5.7
    container_name: cacti-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: cacti
      MYSQL_USER: cactiuser
      MYSQL_PASSWORD: cactiuserpass
    volumes:
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - cactinetwork

  cacti:
    build: ./cacti
    container_name: cacti-server
    ports:
      - "8080:80"
    networks:
      - cactinetwork
    depends_on:
      - mysql

networks:
  cactinetwork:
    driver: bridge


---------- cacti/Dockerfile ----------
FROM php:7.4-apache

RUN apt-get update && \
    apt-get install -y \
    librrd-dev \
    libpng-dev \
    libjpeg-dev \
    libxml2-dev \
    libldap2-dev \
    libmcrypt-dev \
    libmariadb-dev-compat \
    libmariadb-dev \
    unzip \
    git

RUN docker-php-ext-install mysqli pdo pdo_mysql gd ldap xml

RUN a2enmod rewrite

COPY config.php /var/www/html/config.php

# Download and set up Cacti version 1.2.22
RUN curl -L https://www.cacti.net/downloads/cacti-1.2.22.tar.gz | tar zxvf - -C /var/www/html --strip-components=1

WORKDIR /var/www/html

RUN chown -R www-data:www-data /var/www/html


---------- cacti/config.php ----------
<?php
$database_type = "mysql";
$database_default = "cacti";
$database_hostname = "mysql";
$database_username = "cactiuser";
$database_password = "cactiuserpass";
$database_port = "3306";
$database_ssl = false;
$url_path = "/";


---------- mysql/init.sql ----------
CREATE DATABASE IF NOT EXISTS cacti;
USE cacti;

CREATE TABLE IF NOT EXISTS poller_output (
  id int(11) NOT NULL AUTO_INCREMENT,
  local_data_id int(11) DEFAULT NULL,
  rrd_name varchar(255) DEFAULT NULL,
  output text,
  time timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);

CREATE USER 'cactiuser'@'%' IDENTIFIED BY 'cactiuserpass';
GRANT ALL PRIVILEGES ON cacti.* TO 'cactiuser'@'%';
FLUSH PRIVILEGES;





Test iteration #0 failed!
	Error: The error occurs because the downloaded file from the URL 'https://www.cacti.net/downloads/cacti-1.2.22.tar.gz' is not in gzip format as expected by the 'tar zxvf' command. This usually indicates that the URL is either incorrect or the file at the URL is not the expected tar.gz file.
	Fix: To fix the error, verify the URL to ensure it points to a valid tar.gz file. If the URL is correct and the file is still not in the expected format, try downloading the file manually to check its contents. Alternatively, use a different method to obtain the file, such as downloading it to the host machine and copying it into the Docker image.========== Test Passed! Generated Code (Final Version) ==========
Directory tree:
CVE-2022-46169/
├── cacti/
│   ├── Dockerfile
│   └── config.php
├── docker-compose.yml
└── mysql/
    └── init.sql


---------- docker-compose.yml ----------
version: '3.7'
services:
  mysql:
    image: mysql:5.7
    container_name: cacti-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: cacti
      MYSQL_USER: cactiuser
      MYSQL_PASSWORD: cactiuserpass
    volumes:
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - cactinetwork

  cacti:
    build: ./cacti
    container_name: cacti-server
    ports:
      - "8080:80"
    networks:
      - cactinetwork
    depends_on:
      - mysql

networks:
  cactinetwork:
    driver: bridge


---------- cacti/Dockerfile ----------
FROM php:7.4-apache

RUN apt-get update && \
    apt-get install -y \
    librrd-dev \
    libpng-dev \
    libjpeg-dev \
    libxml2-dev \
    libldap2-dev \
    libmcrypt-dev \
    libmariadb-dev-compat \
    libmariadb-dev \
    unzip \
    git

RUN docker-php-ext-install mysqli pdo pdo_mysql gd ldap xml

RUN a2enmod rewrite

COPY config.php /var/www/html/config.php

# Download and set up Cacti version 1.2.22
ADD https://www.cacti.net/downloads/cacti-1.2.22.tar.gz /tmp/cacti.tar.gz
RUN tar zxvf /tmp/cacti.tar.gz -C /var/www/html --strip-components=1 && rm /tmp/cacti.tar.gz

WORKDIR /var/www/html

RUN chown -R www-data:www-data /var/www/html


---------- cacti/config.php ----------
<?php
$database_type = "mysql";
$database_default = "cacti";
$database_hostname = "mysql";
$database_username = "cactiuser";
$database_password = "cactiuserpass";
$database_port = "3306";
$database_ssl = false;
$url_path = "/";


---------- mysql/init.sql ----------
CREATE DATABASE IF NOT EXISTS cacti;
USE cacti;

CREATE TABLE IF NOT EXISTS poller_output (
  id int(11) NOT NULL AUTO_INCREMENT,
  local_data_id int(11) DEFAULT NULL,
  rrd_name varchar(255) DEFAULT NULL,
  output text,
  time timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);

CREATE USER 'cactiuser'@'%' IDENTIFIED BY 'cactiuserpass';
GRANT ALL PRIVILEGES ON cacti.* TO 'cactiuser'@'%';
FLUSH PRIVILEGES;


